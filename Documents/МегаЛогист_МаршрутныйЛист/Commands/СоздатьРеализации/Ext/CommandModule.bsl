&НаСервере
Функция УжеВведенаРеализация(ДанныеЗаполнения,ЗаказКлиента)
	
	Запрос=Новый Запрос();
	Запрос.УстановитьПараметр("ЗаказКлиента",ЗаказКлиента);
	Запрос.УстановитьПараметр("ДатаОтправки",НачалоДня(ДанныеЗаполнения.ДатаОтправки));
	Запрос.Текст="ВЫБРАТЬ
	             |	РеализацияТоваровУслуг.Ссылка
	             |ИЗ
	             |	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
	             |ГДЕ
	             |	РеализацияТоваровУслуг.Проведен = Истина
	             |	И РеализацияТоваровУслуг.ЗаказКлиента = &ЗаказКлиента
	             |	И НАЧАЛОПЕРИОДА(РеализацияТоваровУслуг.Дата, ДЕНЬ) = &ДатаОтправки";
	Результат=Запрос.Выполнить().Выбрать();
	
	Возврат Результат.Следующий();
				 
КонецФункции	

&НаСервере
Процедура СоздатьРеализации(Источник)	
			
	Для Каждого СтрокаЗадания из Источник.МаршрутныеЗадания Цикл
		
		ЗаказКлиента=СтрокаЗадания.МаршрутноеЗадание.ДокументОснование;
		
		Если ТипЗнч(ЗаказКлиента) <> Тип("ДокументСсылка.ЗаказКлиента") тогда 
			Продолжить;
		КонецЕсли;
		Если ЗаказКлиента.Статус=Перечисления.МегаЛогист_СтатусыМаршрутногоЗадания.Отменено тогда
			Продолжить;
		КонецЕсли;
		//Проверим введена ли на основании заказа реализация
		Если УжеВведенаРеализация(Источник,ЗаказКлиента) тогда
			Сообщить("На основании заказа "+ЗаказКлиента+" уже введена реализация");
			Продолжить;
		КонецЕсли;
		
		Док=Документы.РеализацияТоваровУслуг.СоздатьДокумент();
		Док.Заполнить(ЗаказКлиента);
		Док.Товары.Очистить();
		Для Каждого СтрокаТовара из ЗаказКлиента.Товары цикл
			Если НачалоДня(СтрокаТовара.ДатаОтгрузки)<>НачалоДня(Источник.ДатаОтправки) тогда
				Продолжить;
			КонецЕсли;
			НоваяСтрока=Док.Товары.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока,СтрокаТовара);
		КонецЦикла;
		
		Если Док.Товары.Количество()>0 тогда
			Попытка
				Док.Записать(РежимЗаписиДокумента.Проведение);
				Сообщить("Создан документ: "+Док+ "на основании: "+ЗаказКлиента);
			Исключение
				Сообщить("Не удалось создать документ Реализация на основании: "+ЗаказКлиента);
			КонецПопытки;	
		иначе
			Сообщить("Для заказа: "+ЗаказКлиента+" нет товаров для отгрузки");
		КонецЕсли;	
		
	КонецЦикла;	

КонецПроцедуры

&НаКлиенте
Процедура ОбработкаКоманды(ПараметрКоманды, ПараметрыВыполненияКоманды)
	
	СоздатьРеализации(ПараметрКоманды);	
	
КонецПроцедуры
