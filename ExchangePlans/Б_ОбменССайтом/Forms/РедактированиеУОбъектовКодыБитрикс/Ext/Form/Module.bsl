
#Область ОбработчикиСобытийФормы

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ СОБЫТИЙ ФОРМЫ

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	ТипОбъекта	= "Справочники";	
	ЗаполнениеОбъектов1С();
	
КонецПроцедуры

&НаКлиенте
Процедура ПередЗакрытием(Отказ, СтандартнаяОбработка)
	
	Если Модифицированность тогда
		
		Ответ = Вопрос("Элементы в таблице значений были редактированы. Записать изменения. ", РежимДиалогаВопрос.ДаНет, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
	
			ЗаписьИзмененыхЭлементов();
		КонецЕсли;
		
	КонецЕсли;
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

////////////////////////////////////////////////////////////////////////////////
// ОБРАБОТЧИКИ КОМАНД ФОРМЫ

&НаКлиенте
Процедура ЗаписатьИзменения(Команда)
	ЗаписьИзмененыхЭлементов();
КонецПроцедуры

&НаСервере
Процедура ЗаписьИзмененыхЭлементов()
	
	Модифицированность = Ложь;
	Для каждого ТекСтр из Объекты1С цикл
		
		Если ТекСтр.Объект.Б_Идентификатор <> ТекСтр.КодБитрикс ИЛИ ТекСтр.Объект.Б_НомерВерсии <> ТекСтр.ВерсияБитрикс тогда
			
			 РедОбъект = ТекСтр.Объект.ПолучитьОбъект();
			 
			 РедОбъект.Б_Идентификатор 	= ТекСтр.КодБитрикс;
			 РедОбъект.Б_НомерВерсии 	= ТекСтр.ВерсияБитрикс;
			 
			 РедОбъект.Записать();

		КонецЕсли;
		
	КонецЦикла;
	
	ЗаполнениеТаблицыОбъектов();

КонецПроцедуры

&НаСервере
Процедура ЗаполнениеТаблицыОбъектов()
	
	Модифицированность = Ложь;
	Объекты1С.Очистить();
	
	ПризнакИспользованияОР 	= Метаданные.СвойстваОбъектов.ИспользованиеОбщегоРеквизита.Использовать;
	ЕстьОбщийРеквизит 		= Ложь;
	
	Если ТипОбъекта = "Справочники" тогда
		
		Если Метаданные.ОбщиеРеквизиты.Б_Идентификатор.Состав.Найти(Метаданные.Справочники[Объект1С]).Использование = ПризнакИспользованияОР тогда
			Выборка = Справочники[Объект1С].Выбрать();
			ЕстьОбщийРеквизит = Истина;
		Иначе
			Сообщить("Указанный справочник не используется для хранения кодов битрикс.");
		КонецЕсли;
			
	ИначеЕсли ТипОбъекта = "Документы" тогда
		
		Если Метаданные.ОбщиеРеквизиты.Б_Идентификатор.Состав.Найти(Метаданные.Документы[Объект1С]).Использование = ПризнакИспользованияОР тогда
			Выборка = Документы[Объект1С].Выбрать();
			ЕстьОбщийРеквизит = Истина;
		Иначе
			Сообщить("Указанный документ не используется для хранения кодов битрикс.");
		КонецЕсли;
		
	ИначеЕсли ТипОбъекта = "ПланыВидовХарактеристик" тогда
		
		Если Метаданные.ОбщиеРеквизиты.Б_Идентификатор.Состав.Найти(Метаданные.ПланыВидовХарактеристик[Объект1С]).Использование = ПризнакИспользованияОР тогда
			Выборка = ПланыВидовХарактеристик[Объект1С].Выбрать();
			ЕстьОбщийРеквизит = Истина;
		Иначе
			Сообщить("Указанный план видов характеристик не используется для хранения кодов битрикс.");
		КонецЕсли;
		
	КонецЕсли;
	
	Если ЕстьОбщийРеквизит тогда
	
		Пока Выборка.Следующий() Цикл
			
			НовСтр = Объекты1С.Добавить();
			
			НовСтр.Объект 			= Выборка.Ссылка;
			НовСтр.КодБитрикс 		= Выборка.Б_Идентификатор;
			НовСтр.ВерсияБитрикс 	= Выборка.Б_НомерВерсии;
			
		КонецЦикла;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиСобытийЭлементовШапкиФормы

&НаКлиенте
Процедура ТипОбъектаПриИзменении(Элемент)
			
	Объекты1С.Очистить();
	
	ЗаполнениеОбъектов1С();

КонецПроцедуры

&НаСервере
Процедура ЗаполнениеОбъектов1С()
	
	ПризнакИспользованияОР 	= Метаданные.СвойстваОбъектов.ИспользованиеОбщегоРеквизита.Использовать;
	
	КоллекцияМетаданных = Метаданные[ТипОбъекта];
	
	Элементы.Объект1С.СписокВыбора.Очистить();
	Объект1С = "";
	
	Для каждого ТекЭлемент из КоллекцияМетаданных Цикл
		
		Если Метаданные.ОбщиеРеквизиты.Б_Идентификатор.Состав.Найти(ТекЭлемент).Использование = ПризнакИспользованияОР тогда
			
			Элементы.Объект1С.СписокВыбора.Добавить(ТекЭлемент.имя);
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
&НаКлиенте
Процедура ТипОбъектаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
		
	Если Модифицированность тогда
		
		Ответ = Вопрос("Элементы в таблице значений были редактированы. Записать изменения. ", РежимДиалогаВопрос.ДаНет, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
	
			ЗаписьИзмененыхЭлементов();
		Иначе
			Модифицированность = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	Объекты1С.Очистить();
	
	ЗаполнениеОбъектов1С();

КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
&НаКлиенте
Процедура Объект1СПриИзменении(Элемент)
	
	Если Модифицированность тогда
		
		Ответ = Вопрос("Элементы в таблице значений были редактированы. Записать изменения. ", РежимДиалогаВопрос.ДаНет, 0);
		Если Ответ = КодВозвратаДиалога.Да Тогда
	
			ЗаписьИзмененыхЭлементов();
		Иначе
			Модифицированность = Ложь;
		КонецЕсли;
		
	КонецЕсли;
	
	ЗаполнениеТаблицыОбъектов();
	
КонецПроцедуры

#КонецОбласти

