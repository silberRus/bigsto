
#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	Объект 							= Параметры.Объект;
	СоответствияПлатежныхКасс 		= Параметры.СоответствияПлатежныхКасс;
	
	Для каждого ТекСтрока из СоответствияПлатежныхКасс Цикл
		
		Если ЗначениеЗаполнено(ТекСтрока.Касса) тогда
			
			НовСтрока = Кассы.Добавить();
			НовСтрока.Касса 			= ТекСтрока.Касса;
			НовСтрока.ПлатежнаяСистема 	= ТекСтрока.ПлатежнаяСистема;
			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ТекСтрока.Терминал) тогда
			
			НовСтрока = Терминалы.Добавить();
			НовСтрока.Терминал 			= ТекСтрока.Терминал;
			НовСтрока.ПлатежнаяСистема 	= ТекСтрока.ПлатежнаяСистема;
			
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
Процедура Применить(Команда)

	СоответствиеПлатежныхСистем.Очистить();
	
	Для каждого ТекСтрока из Кассы Цикл
		НоваяСтрока = СоответствиеПлатежныхСистем.Добавить();
		НоваяСтрока.Касса 				= ТекСтрока.Касса;
		НоваяСтрока.ПлатежнаяСистема 	= ТекСтрока.ПлатежнаяСистема;
	КонецЦикла;
	
	Для каждого ТекСтрока из Терминалы Цикл
		НоваяСтрока = СоответствиеПлатежныхСистем.Добавить();
		НоваяСтрока.Терминал 			= ТекСтрока.Терминал;
		НоваяСтрока.ПлатежнаяСистема 	= ТекСтрока.ПлатежнаяСистема;
	КонецЦикла;
	
	Закрыть(СоответствиеПлатежныхСистем);
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ЗагрузитьПлатежныеСистемы(Команда)
	
	Попытка	
		СтрокаCML = ЗагрузитьПлатежныеСистемыСервер();
		
		РазборИЗаписьПлатежныхСистем(Объект, СтрокаCML);
	Исключение
		
		Сообщить("Не удалось получить данные с сайта");
		
	КонецПопытки;
	
КонецПроцедуры

&НаСервере 
Функция ЗагрузитьПлатежныеСистемыСервер()
	
	СтрокаCML = ПланыОбмена.Б_ОбменССайтом.ПолучитьСлужебныеДанныеССайта(Объект);

	Возврат СтрокаCML;
	
КонецФункции

&НаКлиенте
Процедура РазборИЗаписьПлатежныхСистем(УзелОбмена, СтрокаCML)
		
	ЧтениеXML = Новый ЧтениеXML;
		
	Попытка
		ЧтениеXML.УстановитьСтроку(СтрокаCML);
	Исключение
		ОписаниеОшибки = ОписаниеОшибки();
		Возврат;
	КонецПопытки;
	
	ВсеПлатежныеСистемы.Очистить();
	
	
	лЭтоПлатежныеСистемы= Ложь;
	лЭтоИд 				= Ложь;
	лЭтоНазвание		= Ложь;
	Пока ЧтениеXML.Прочитать() Цикл
			
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "ПлатежныеСистемы" тогда
			лЭтоПлатежныеСистемы = Истина;
		КонецЕсли;
		
		Если ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.ЛокальноеИмя = "ПлатежныеСистемы" тогда
			лЭтоПлатежныеСистемы = Ложь;
		КонецЕсли;
		
		Если лЭтоПлатежныеСистемы тогда
			
			Если ЧтениеXML.ТипУзла 	= ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Элемент" тогда
				СтруктураСтр = Новый Структура("ИдПлатежнойСистемы, НазваниеПлатежнойСистемы, Касса")
			КонецЕсли;
			
				Если ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Название" тогда
					лЭтоНазвание = Истина;
				ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.ЛокальноеИмя = "Название" тогда
					лЭтоНазвание = Ложь;
				ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.НачалоЭлемента И ЧтениеXML.ЛокальноеИмя = "Ид" тогда
					лЭтоИд = Истина;
				ИначеЕсли ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.ЛокальноеИмя = "Ид" тогда
					лЭтоИд = Ложь;
				КонецЕсли;
				
				Если лЭтоНазвание И ЧтениеXML.ТипУзла = ТипУзлаXML.Текст тогда
					СтруктураСтр.НазваниеПлатежнойСистемы = ЧтениеXML.Значение;
				КонецЕсли;
				
				Если лЭтоИд И ЧтениеXML.ТипУзла = ТипУзлаXML.Текст тогда
					СтруктураСтр.ИдПлатежнойСистемы = ЧтениеXML.Значение;
				КонецЕсли;
			
			Если ЧтениеXML.ТипУзла = ТипУзлаXML.КонецЭлемента И ЧтениеXML.ЛокальноеИмя = "Элемент" тогда
				
				НовСтр = ВсеПлатежныеСистемы.Добавить();
				НовСтр.ИдПлатежнойСистемы 		= СтруктураСтр.ИдПлатежнойСистемы;
				НовСтр.НазваниеПлатежнойСистемы = СтруктураСтр.НазваниеПлатежнойСистемы;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	ПлатежныеСистемы.Очистить();
	
	Для каждого ТекПС из ВсеПлатежныеСистемы Цикл
		
		Используется = Ложь;	
	
		Для каждого ТекКасса из Кассы Цикл
			Если ТекКасса.ПлатежнаяСистема.НайтиПоЗначению(ТекПС.ИдПлатежнойСистемы) <> Неопределено тогда
				Используется = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		
		Для каждого ТекТерминал из Терминалы Цикл
			Если ТекТерминал.ПлатежнаяСистема.НайтиПоЗначению(ТекПС.ИдПлатежнойСистемы) <> Неопределено тогда
				Используется = Истина;
				Прервать;
			КонецЕсли;
		КонецЦикла;
		
		
		Если Не Используется тогда
			ПлатежныеСистемы.Добавить(ТекПС.ИдПлатежнойСистемы, ТекПС.НазваниеПлатежнойСистемы); 	
		КонецЕсли;
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти


#Область ОбработчикиЭлементовФормы

&НаКлиенте
Процедура ДобавитьПС(Команда)
	
	ПлатежнаяСистема = Элементы.ПлатежныеСистемы.ТекущиеДанные;
	
	Если ПлатежнаяСистема = Неопределено тогда
		Возврат;
	КонецЕсли;
	
	Если Элементы.ГруппаОбъектов1С.ТекущаяСтраница.Заголовок = "Кассы" тогда
		
		Если Элементы.Кассы.ТекущиеДанные = Неопределено тогда
			Возврат;
		КонецЕсли;	
		
		НайденнаяСтрока = Кассы.НайтиПоИдентификатору(Элементы.Кассы.ТекущаяСтрока);
		
		Если НайденнаяСтрока <> Неопределено тогда
			
			НайденнаяСтрока.ПлатежнаяСистема.Добавить(ПлатежнаяСистема.Значение, ПлатежнаяСистема.Представление);	
			
		КонецЕсли;
		
	ИначеЕсли Элементы.ГруппаОбъектов1С.ТекущаяСтраница.Заголовок = "Эквайринговые терминалы" тогда	
		
		Если Элементы.Терминалы.ТекущиеДанные = Неопределено тогда
			Возврат;
		КонецЕсли;
		
		НайденнаяСтрока = Терминалы.НайтиПоИдентификатору(Элементы.Терминалы.ТекущаяСтрока);
		
		Если НайденнаяСтрока <> Неопределено тогда
			
			НайденнаяСтрока.ПлатежнаяСистема.Добавить(ПлатежнаяСистема.Значение, ПлатежнаяСистема.Представление);	
			
		КонецЕсли;
		
	КонецЕсли;
	
	НайденноеЗначение = ПлатежныеСистемы.НайтиПоИдентификатору(Элементы.ПлатежныеСистемы.ТекущаяСтрока);
	
	Если НайденноеЗначение <> Неопределено тогда
		
		ПлатежныеСистемы.Удалить(НайденноеЗначение);
			
	КонецЕсли;
		
КонецПроцедуры

&НаКлиенте
Процедура УбратьПС(Команда)
	
	Если Элементы.ГруппаОбъектов1С.ТекущаяСтраница.Заголовок = "Кассы" тогда
		
		Если Элементы.Кассы.ТекущиеДанные = Неопределено тогда
			Возврат;
		КонецЕсли;	
		
		Для каждого Элемент из Элементы.Кассы.ТекущиеДанные.ПлатежнаяСистема Цикл
			ПлатежныеСистемы.Добавить(Элемент.Значение, Элемент.Представление);
		КонецЦикла;
		
		Кассы.НайтиПоИдентификатору(Элементы.Кассы.ТекущаяСтрока).ПлатежнаяСистема.Очистить();
		
	ИначеЕсли Элементы.ГруппаОбъектов1С.ТекущаяСтраница.Заголовок = "Эквайринговые терминалы" тогда	
		
		Если Элементы.Терминалы.ТекущиеДанные = Неопределено тогда
			Возврат;
		КонецЕсли;	
		
		Для каждого Элемент из Элементы.Терминалы.ТекущиеДанные.ПлатежнаяСистема Цикл
			ПлатежныеСистемы.Добавить(Элемент.Значение, Элемент.Представление);
		КонецЦикла;
		
		Терминалы.НайтиПоИдентификатору(Элементы.Терминалы.ТекущаяСтрока).ПлатежнаяСистема.Очистить();
		
	КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура ТерминалыТерминалОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	//НайденныеСтроки = Терминалы.НайтиСтроки(Новый Структура("Терминал", ВыбранноеЗначение));
	//
	//Если НайденныеСтроки.Количество() > 0 тогда
	//	Сообщить("Эквайринговый терминал уже есть в списке.");
	//	СтандартнаяОбработка = Ложь;
	//КонецЕсли;
	
КонецПроцедуры


&НаКлиенте
Процедура КассыКассаОбработкаВыбора(Элемент, ВыбранноеЗначение, СтандартнаяОбработка)
	
	//НайденныеСтроки = Кассы.НайтиСтроки(Новый Структура("Касса", ВыбранноеЗначение));
	//
	//Если НайденныеСтроки.Количество() > 0 тогда
	//	Сообщить("Касса уже есть в списке.");
	//	СтандартнаяОбработка = Ложь;
	//КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

