	
Функция ГотовыйJSONЗапрос(Адрес)
	
	ТелоЗапроса = Новый ЗаписьJSON;
	ТелоЗапроса.ПроверятьСтруктуру = ЛОЖЬ;
	ТелоЗапроса.УстановитьСтроку();
	
	ТелоЗапроса.ЗаписатьНачалоОбъекта();
		ТелоЗапроса.ЗаписатьИмяСвойства("requests");
			ТелоЗапроса.ЗаписатьНачалоМассива();//requests
				ТелоЗапроса.ЗаписатьНачалоОбъекта();
				Телозапроса.ЗаписатьИмяСвойства("image");
					ТелоЗапроса.ЗаписатьНачалоОбъекта();
						Телозапроса.ЗаписатьИмяСвойства("content");
						ТелоЗапроса.ЗаписатьЗначение(Base64Строка(ПолучитьИзВременногоХранилища(Адрес)));//base64 image content	
					ТелоЗапроса.ЗаписатьКонецОбъекта();//end content
				Телозапроса.ЗаписатьИмяСвойства("features");
				ТелоЗапроса.ЗаписатьНачалоМассива();//begin features
					ТелоЗапроса.ЗаписатьНачалоОбъекта();
					Телозапроса.ЗаписатьИмяСвойства("type");
					Телозапроса.ЗаписатьЗначение("TEXT_DETECTION");
					ТелоЗапроса.ЗаписатьКонецОбъекта(); //end type
				ТелоЗапроса.ЗаписатьКонецМассива();//end features
				Телозапроса.ЗаписатьИмяСвойства("imageContext");
				ТелоЗапроса.ЗаписатьНачалоОбъекта();//begin languageHints
					Телозапроса.ЗаписатьИмяСвойства("languageHints");
					Телозапроса.ЗаписатьЗначение("ru");
				ТелоЗапроса.ЗаписатьКонецОбъекта(); //end languageHints
			ТелоЗапроса.ЗаписатьКонецОбъекта();//end requests
		ТелоЗапроса.ЗаписатьКонецМассива(); //end requests
	ТелоЗапроса.ЗаписатьКонецОбъекта();
	
	Возврат ТелоЗапроса.Закрыть();
	
КонецФункции
Функция ПрочитатьВГугле(Адрес)
	
	ИнетЗапрос = Новый HTTPЗапрос("/v1/images:annotate?key=AIzaSyDHLGvZ7-YFVvF2yKY1uNKfgBP0HLpIjMA");
	ИнетЗапрос.УстановитьТелоИзСтроки(ГотовыйJSONЗапрос(Адрес));
	ssl = Новый ЗащищенноеСоединениеOpenSSL;
	
	Соединение = новый HTTPСоединение("vision.googleapis.com",,,,,,ssl);
	Ответ = Соединение.ОтправитьДляОбработки(ИнетЗапрос);
	Возврат Ответ.ПолучитьТелоКакСтроку();
		
КонецФункции
Функция ПолучитьОписаниеИзОтветаГугла(ОтветГугл)
	
	ЧтениеОтвета = Новый ЧтениеJSON;
	ЧтениеОтвета.УстановитьСтроку(ОтветГугл);
	
	стр="";
	счч=0;
	Пока ЧтениеОтвета.Прочитать() цикл
		попытка
			ТекТипУзла = ЧтениеОтвета.ТипТекущегоЗначения;
			если текТипУзла = ТипЗначенияJSON.ИмяСвойства тогда
				ТекЗначение = ЧтениеОтвета.ТекущееЗначение;
				если ТекЗначение = "description" тогда
					
					если счч=0 тогда
						ЧтениеОтвета.Прочитать();
						стр = ЧтениеОтвета.ТекущееЗначение;
						
					конецесли;
					счч=счч+1;
				конецесли;			
			конецесли;
		исключение
		конецпопытки;
	конеццикла;
	
	ЧтениеОтвета.Закрыть();
	Возврат Стр;
	
КонецФункции

Функция РаспознатьТекст(Адрес) Экспорт
	
	Описание = НРег(ПолучитьОписаниеИзОтветаГугла(ПрочитатьВГугле(Адрес)));
	
	Возврат Новый Структура("ИНН, КПП",
						НайтиВТексте("инн", Описание),
						НайтиВТексте("кпп", Описание)); // kпп иногда так распознает
	
КонецФункции

Функция НайтиВТексте(строкаПоиска, Описание, СимволыПоиска = "01234567890")
	
	Строки = Новый Массив;
	НачПоз = 1;
	
	Поз = СтрНайти(Описание, строкаПоиска,,НачПоз);
	Если Поз Тогда
		
		Стрнач 		= Сред(Описание, Поз + СтрДлина(строкаПоиска));
		Стрнач		= Сред(стрНач, СледСимволЧерез(стрНач, СимволыПоиска));
		СтрДлина 	= СтрДлина(Стрнач);
		Для Ном = 1 По СтрДлина Цикл
			Если Не СтрНайти(СимволыПоиска, Сред(СтрНач, Ном, 1)) Тогда
				Строки.Добавить(Лев(Стрнач, Ном - 1));
			КонецЕсли;
		КонецЦикла;
		
	КонецЕсли;
	
	Возврат Строки;
	
КонецФункции
Функция СледСимволЧерез(Строка, СимволыПоиска)
	
	СтрДлина = СтрДлина(Строка);
	Для Ном = 1 По СтрДлина Цикл
		Если СтрНайти(СимволыПоиска, Сред(Строка, Ном, 1)) Тогда
			Возврат Ном;
		КонецЕсли;
	КонецЦикла;
	
	Возврат 0;
	
КонецФункции

Функция ПравилДляФормыНет(ИмяФормы) Экспорт
	
	Запрос = Новый Запрос(СтрШаблон("ВЫБРАТЬ ПЕРВЫЕ 1 ИСТИНА ИЗ Справочник.АТ_ПравилаЗаполненияРаспознанного.Формы ГДЕ НЕ Ссылка.ПометкаУдаления И ИмяФормы = ""%1""", ИмяФормы));
	Возврат Запрос.Выполнить().Пустой();
	
КонецФункции


Функция ИграМожетНачаться() Экспорт
	
	Играет = Ложь;
	
	Попытка
		Таб 	= АТ_ОбщегоНазначения.ПолучитьЭлементНастройки("game", "КтоВИгре");
		Шанс	= АТ_ОбщегоНазначения.ПолучитьЭлементНастройки("game", "Шанс");	// Вероятность
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
	Если 	ТипЗнч(Таб) = Тип("ТаблицаЗначений") И ТипЗнч(Шанс) = Тип("Число") И Шанс И
			Таб.Найти(ПараметрыСеанса.ТекущийПользователь) <> Неопределено	Тогда
	
		Генератор = Новый ГенераторСлучайныхЧисел;
		Число = Генератор.СлучайноеЧисло(1, 100);
		
		Играет = Число <= Шанс;
		
	КонецЕсли;
	
	Возврат Играет;
				
КонецФункции