
#Область ПрограммныйИнтерфейс

// Проверяет выбранные в табличной части статей расходов на соответствие виду деятельности НДС.
//
// Параметры:
// 	Объект - ДокументОбъект - Объект для проверки
// 	ИмяТабличнойЧасти - Строка - Имя табличной части со статьями расходов
// 	ИмяРеквизитаДеятельностьНДС - Строка - Имя реквизита, определяющего деятельность НДС
// 	Отказ - Булево - Отказ в проведении документа
//
Процедура ПроверитьСтатьиРасходовПоВидуДеятельностиНДС(Объект, ИмяТабличнойЧасти, ИмяРеквизитаДеятельностьНДС, Отказ) Экспорт
	
	ВводОСВЭксплуатацию = (Объект[ИмяРеквизитаДеятельностьНДС] = Перечисления.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию);
	ПоФактическомуИспользованию = (Объект[ИмяРеквизитаДеятельностьНДС] = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию);
	
	Если НЕ ВводОСВЭксплуатацию И НЕ ПоФактическомуИспользованию Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.НомерСтроки,
	|	ТЧ.СтатьяРасходов
	|ПОМЕСТИТЬ ТЧ
	|ИЗ
	|	&ТЧ КАК ТЧ
	|;
	|
	|ВЫБРАТЬ
	|	ТЧ.НомерСтроки
	|ИЗ
	|	ТЧ КАК ТЧ
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|	ПО
	|		ТЧ.СтатьяРасходов = СтатьиРасходов.Ссылка
	|ГДЕ
	|	&ВводОСВЭксплуатацию
	|	И НЕ СтатьиРасходов.ВидЦенностиНДС В (
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ОС),
	|		ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НМА))
	|;
	|
	|ВЫБРАТЬ
	|	ТЧ.НомерСтроки
	|ИЗ
	|	ТЧ КАК ТЧ
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|	ПО
	|		ТЧ.СтатьяРасходов = СтатьиРасходов.Ссылка
	|ГДЕ
	|	&ПоФактическомуИспользованию
	|	И &ПартионныйУчетВключен
	|	И СтатьиРасходов.ВариантРаздельногоУчетаНДС <> ЗНАЧЕНИЕ(Перечисление.ВариантыРаздельногоУчетаНДС.Распределение)
	|	И СтатьиРасходов.ВариантРаспределенияРасходовРегл В 
	|		(ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаНаправленияДеятельности),
	|		 ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаПроизводственныеЗатраты),
	|		 ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаРасходыБудущихПериодов))";
	Запрос.УстановитьПараметр("ТЧ", Объект[ИмяТабличнойЧасти]);
	Запрос.УстановитьПараметр("ВводОСВЭксплуатацию", ВводОСВЭксплуатацию);
	Запрос.УстановитьПараметр("ПоФактическомуИспользованию", ПоФактическомуИспользованию);
	Запрос.УстановитьПараметр("ПартионныйУчетВключен", УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПартионныйУчетВключен(НачалоМесяца(Объект.Дата)));
	
	Результат = Запрос.ВыполнитьПакет();
	
	Выборка = Результат[1].Выбрать();
	ТекстСообщения = НСтр("ru = 'При закупке под деятельность ""Определяется использованием ОС/НМА"" необходимо выбрать статью расходов с вариантом распределения ""На внеоборотные активы"" и аналитикой ""ОС"" или ""НМА""'");
	Пока Выборка.Следующий() Цикл
		
		Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТабличнойЧасти, Выборка.НомерСтроки, "СтатьяРасходов");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения, 
			Неопределено, 
			Поле, 
			"Объект",
			Отказ);
		
	КонецЦикла;
	
	Выборка = Результат[2].Выбрать();
	ТекстСообщения = НСтр("ru='При использовании учета НДС по фактическому использованию, у статьи расходов должен быть выбран раздельный учет НДС по расходам: ""НДС распределяется по видам налогообложения пропорционально выручке""'");
	Пока Выборка.Следующий() Цикл
		
		Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТабличнойЧасти, Выборка.НомерСтроки, "СтатьяРасходов");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения, 
			Неопределено, 
			Поле, 
			"Объект",
			Отказ);
		
	КонецЦикла;
	
КонецПроцедуры

// Проверяет выбранные в табличной части статей расходов на соответствие налогообложение документа.
//
// Параметры:
// 	Объект - ДокументОбъект - Объект для проверки
// 	ИмяТабличнойЧасти - Строка - Имя табличной части со статьями расходов
// 	ИмяРеквизитаНалогообложениеНДС - Строка - Имя реквизита, определяющего деятельность НДС
// 	Отказ - Булево - Отказ в проведении документа
//
Процедура ПроверитьСтатьиРасходовПоНалогообложениюНДС(Объект, ИмяТабличнойЧасти, ИмяРеквизитаНалогообложениеНДС, Отказ) Экспорт
	
	Если Объект[ИмяРеквизитаНалогообложениеНДС] <> Перечисления.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ТЧ.НомерСтроки,
	|	ТЧ.СтатьяРасходов
	|ПОМЕСТИТЬ ТЧ
	|ИЗ
	|	&ТЧ КАК ТЧ
	|;
	|
	|ВЫБРАТЬ
	|	ТЧ.НомерСтроки
	|ИЗ
	|	ТЧ КАК ТЧ
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|	ПО
	|		ТЧ.СтатьяРасходов = СтатьиРасходов.Ссылка
	|		И СтатьиРасходов.ВариантРаспределенияРасходовРегл = ЗНАЧЕНИЕ(Перечисление.ВариантыРаспределенияРасходов.НаВнеоборотныеАктивы)
	|";
	
	Запрос.УстановитьПараметр("ТЧ", Объект[ИмяТабличнойЧасти]);
	
	ШаблонСообщения = НСтр("ru = 'В строке ""%1"" выбрана статья расходов с вариантом распределения ""На внеоборотные активы"". Покупка внеоборотных активов с налогобложением ""Налоговый агент по НДС"" не поддерживается.'");
	
	Выборка = Запрос.Выполнить().Выбрать();
	Пока Выборка.Следующий() Цикл
		
		ТекстСообщения = СтрШаблон(ШаблонСообщения, Выборка.НомерСтроки);
		Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТабличнойЧасти, Выборка.НомерСтроки, "СтатьяРасходов");
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
			ТекстСообщения, 
			Неопределено, 
			Поле, 
			"Объект",
			Отказ);
		
	КонецЦикла;
	
КонецПроцедуры


// Проверяет выбранные в табличной части виды ценностей. Они не должны относиться одновременно к отгрузкам и оплатам.
//
// Параметры:
// 	Объект - ДокументОбъект - Объект для проверки
// 	ИмяТабличнойЧасти - Строка - Имя табличной части с видами ценностей
// 	Отказ - Булево - Отказ в проведении документа
//
Процедура ПроверитьСовместимостьВидовЦенностейТабличнойЧасти(Объект, ИмяТабличнойЧасти, Отказ) Экспорт
	
	Если Объект[ИмяТабличнойЧасти].Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СписокВидовЦенностейОплаты = СписокВидовЦенностейСвязанныхСОплатой();
	
	//Все виды ценностей в ТЧ должны быть связаны с отгрузкой или с оплатой.
	//Определяем, куда относится вид ценностей в первой строке, и считаем, что все остальные должны относиться туда же.
	ОсновнойВидЦенности = Объект[ИмяТабличнойЧасти][0].ВидЦенности;
	ТолькоОплаты = СписокВидовЦенностейОплаты.НайтиПоЗначению(ОсновнойВидЦенности) <> Неопределено;
	
	ШаблонСообщения = НСтр("ru = 'В строке ""%1"" выбран вид ценностей ""%2"", а в первой строке - """ + ОсновнойВидЦенности + """. 
		|В одном документе нельзя указывать виды ценностей связанные и не связанные с оплатой.'");
	
	
	Для Каждого СтрокаТЧ Из Объект[ИмяТабличнойЧасти] Цикл
		СвязанСОплатой = СписокВидовЦенностейОплаты.НайтиПоЗначению(СтрокаТЧ.ВидЦенности) <> Неопределено;
		Если ТолькоОплаты <> СвязанСОплатой Тогда
			ТекстСообщения = СтрШаблон(ШаблонСообщения, СтрокаТЧ.НомерСтроки, СтрокаТЧ.ВидЦенности);
			Поле = ОбщегоНазначенияКлиентСервер.ПутьКТабличнойЧасти(ИмяТабличнойЧасти, СтрокаТЧ.НомерСтроки, "ВидЦенности");
			ОбщегоНазначенияКлиентСервер.СообщитьПользователю(
				ТекстСообщения, 
				Неопределено, 
				Поле, 
				"Объект",
				Отказ);
			
		КонецЕсли;
	КонецЦикла;
	
КонецПроцедуры

// Выполняет отражение документов в учете НДС.
// 
// Параметры:
// 	 Период - Дата - Период по который необходимо выполнить отражение
// 	 МассивСсылок - Массив - Документы, которые небходимо отразить
//
Процедура ОтразитьДокументыВУчетеНДС(Период, МассивСсылок) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыОснования.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Основания.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.СчетФактураПолученный.ДокументыОснования КАК Основания
	|	ПО
	|		СчетФактураПолученный.СчетФактураОснование = Основания.Ссылка
	|ГДЕ
	|	СчетФактураПолученный.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыОснования.Ссылка КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученныйНалоговыйАгент.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	СчетФактураПолученный.Ссылка КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ДокументыОснования.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураВыданный.ДокументыОснования КАК ДокументыОснования
	|ГДЕ
	|	ДокументыОснования.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ЗаявлениеОВвозеТоваров.Ссылка КАК СчетФактура
	|ИЗ
	|	Документ.ЗаявлениеОВвозеТоваров КАК ЗаявлениеОВвозеТоваров
	|ГДЕ
	|	ЗаявлениеОВвозеТоваров.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ
	|	ТаможеннаяДекларацияИмпорт.Ссылка КАК СчетФактура
	|ИЗ
	|	Документ.ТаможеннаяДекларацияИмпорт КАК ТаможеннаяДекларацияИмпорт
	|ГДЕ
	|	ТаможеннаяДекларацияИмпорт.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КорректировкаПриобретения.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученный.ДокументыОснования КАК ДокументыОснования
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|	ПО
	|		ДокументыОснования.ДокументОснование = КорректировкаПриобретения.Ссылка
	|ГДЕ
	|	ДокументыОснования.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КорректировкаПриобретения.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.СчетФактураПолученныйНалоговыйАгент.ДокументыОснования КАК ДокументыОснования
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|	ПО
	|		ДокументыОснования.ДокументОснование = КорректировкаПриобретения.Ссылка
	|ГДЕ
	|	ДокументыОснования.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	КорректировкаПриобретения.ДокументОснование КАК СчетФактура
	|ИЗ
	|	Документ.КорректировкаПриобретения КАК КорректировкаПриобретения
	|ГДЕ
	|	КорректировкаПриобретения.Ссылка В (&МассивСсылок)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПартииПрочихРасходов.ДокументПоступленияРасходов КАК СчетФактура
	|ИЗ
	|	Документ.РаспределениеНДС КАК РаспределениеНДС
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
	|	ПО
	|		РаспределениеНДС.Ссылка = ПартииПрочихРасходов.Регистратор
	|ГДЕ
	|	РаспределениеНДС.Ссылка В (&МассивСсылок)
	|";
	Запрос.УстановитьПараметр("МассивСсылок", МассивСсылок);
	
	СчетаФактуры = Запрос.Выполнить().Выгрузить().ВыгрузитьКолонку("СчетФактура");
	
	Если СчетаФактуры.Количество() > 0 Тогда
		СформироватьЗаписиКнигиПокупокПродаж(КонецМесяца(Период), Неопределено, СчетаФактуры);
	КонецЕсли;
	
КонецПроцедуры

// Возвращает дату начала действия закона 150-ФЗ от 30.05.2016
// 
// Возвращаемое значение:
//   Дата - Дата - Дата начала применения закона
//
Функция ДатаНачалаДействия150ФЗ() Экспорт
	
	Возврат Дата("20160701");
	
КонецФункции

// Возвращает Истина, если указанная дата меньше даты начала действия закона 150-ФЗ
// В противном случае - Ложь.
// 
// Параметры:
//   Дата - проверяемая дата
// 
// Возвращаемое значение:
//   Результат - Булево
//
Функция УпрощенныйПорядокВычетаНДСПоНесырьевомуЭкспорту(Дата) Экспорт
	
	Возврат ДатаНачалаДействия150ФЗ() <= Дата;
	
КонецФункции

// Определяет, является ли страна членом Евразийского экономического союза
//
// Параметры:
//	Страна - СправочникСсылка.СтраныМира - Страна, для которой нужно определить членство в ЕАЭС
//	Период - Дата - Дата, на которую необходимо определить членство в ЕАЭС для страны. 
//			 Если не указано, то членство определяется на текущую дату
//
// Возвращаемое значение:
//	Булево - Истина, если страна является членом ЕАЭС, иначе - Ложь
//
Функция СтранаЯвляетсяЧленомЕАЭС(Страна, Период = Неопределено) Экспорт
	
	Если Не ЗначениеЗаполнено(Страна) 
		или ТипЗнч(Страна) <> Тип("СправочникСсылка.СтраныМира") Тогда
		
		Возврат Ложь;
		
	КонецЕсли;
	
	КодСтраны = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Страна, "Код");
	
	Если Период = Неопределено Тогда
		Период = ТекущаяДатаСеанса();
	КонецЕсли;
	
	Если Период >= '2015-01-01' 
			и (КодСтраны = "112" или КодСтраны = "398") Тогда // Казахстан, Беларусь
		Возврат Истина;
	КонецЕсли;
	
	Если Период >= '2015-01-02' и КодСтраны = "051" Тогда // Армения
		Возврат Истина;
	КонецЕсли;
	
	Если Период >= '2015-08-12' и КодСтраны = "417" Тогда // Киргизия
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции // СтранаЯвляетсяЧленомЕАЭС()

// Выполняет Формирование записей книг покупок и продаж.
// 
// Параметры:
// 	 КонецПериода - Дата - Период, по который необходимо выполнить отражение
// 	 МассивОрганизаций - Массив, Неопределено - Организации, по которым необходимо сформировать записи книг.
// 																Если Неопределено, то по всем организациям.
// 	 МассивСчетовФактур - Массив, Неопределено - Счета-фактуры (документы поступления), по которым необходимо сформировать записи книг.
// 																Если Неопределено, то по всем счетам-фактурам.
//
Процедура СформироватьЗаписиКнигиПокупокПродаж(КонецПериода, МассивОрганизаций = Неопределено, МассивСчетовФактур = Неопределено) Экспорт
	
	УстановитьПривилегированныйРежим(Истина);
	
	ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ();
	
	НомерЗаданияДоРасчета = РегистрыСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж.УвеличитьНомерЗадания();
	
	Месяц = МесяцДляРасчета(КонецПериода, НомерЗаданияДоРасчета, МассивОрганизаций, МассивСчетовФактур);  
	Пока Месяц <> Неопределено Цикл
		
		ПараметрыРасчета = Новый Структура;
		ПараметрыРасчета.Вставить("НомерЗадания",            НомерЗаданияДоРасчета);
		ПараметрыРасчета.Вставить("НачалоПериода",           НачалоМесяца(Месяц));
		ПараметрыРасчета.Вставить("КонецПериода",            КонецМесяца(Месяц));
		ПараметрыРасчета.Вставить("МассивОрганизаций",       МассивОрганизаций);
		ПараметрыРасчета.Вставить("МассивСчетовФактур",      МассивСчетовФактур);
		ПараметрыРасчета.Вставить("МенеджерВременныхТаблиц", Новый МенеджерВременныхТаблиц);
		
		Если НЕ ОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
			НачатьТранзакцию();
			Попытка
				ЗаблокироватьРегистрЗаданий(ПараметрыРасчета);
				ПолучитьЗадания(ПараметрыРасчета);
				ЗафиксироватьТранзакцию();
			Исключение
				ОтменитьТранзакцию();
				ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось выполнить по причине %1'"),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
				ЗаписьЖурналаРегистрации(
					НСтр("ru = 'Формирование записей книг покупок и продаж.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
					УровеньЖурналаРегистрации.Ошибка, , , ТекстСообщения); 
				ВызватьИсключение ТекстСообщения;
			КонецПопытки;
		Иначе
			ПолучитьЗадания(ПараметрыРасчета);
		КонецЕсли;
			
		НачатьТранзакцию();
		Попытка
			ВыполнитьРасчетСЗамеромВремени(ПараметрыРасчета);
			Если НЕ ОбщегоНазначения.ИнформационнаяБазаФайловая() Тогда
				ЗаблокироватьРегистрЗаданий(ПараметрыРасчета);
			КонецЕсли;
			ЗафиксироватьРезультат(ПараметрыРасчета);
			ЗафиксироватьТранзакцию();
			
		Исключение
			
			ОтменитьТранзакцию();
			ТекстСообщения = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
					НСтр("ru = 'Не удалось выполнить по причине %1'"),
					ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()));
					
			ЗаписьЖурналаРегистрации(
				НСтр("ru = 'Формирование записей книг покупок и продаж.'", ОбщегоНазначенияКлиентСервер.КодОсновногоЯзыка()), 
				УровеньЖурналаРегистрации.Ошибка, , , ТекстСообщения); 
				
			ВызватьИсключение ТекстСообщения;
			
		КонецПопытки;
		
		Месяц = МесяцДляРасчета(КонецПериода, НомерЗаданияДоРасчета, МассивОрганизаций, МассивСчетовФактур);
		
	КонецЦикла;
	
КонецПроцедуры

// Заполняет список выбора вида деятельности НДС в документе закупки
// 
// Параметры:
// 	Поле - ПолеФормы - Поле выбора деятельности НДС
// 	Дата - Дата - Дата документа
// 	ВидДеятельностиНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - Вид деятельности НДС организации
// 	УчетНДСПоФактическомуИспользованию - Булево - Признак использования учета НДС по фактическому использованию
//
Процедура ЗаполнитьСписокВыбораДеятельностиНДСПоступления(Поле, Дата, ВидДеятельностиНДСОрганизации, ХозяйственнаяОперация = Неопределено, Организация = Неопределено) Экспорт
	
	Поле.СписокВыбора.Очистить();
	СписокДоступных = СписокДоступныхВидовДеятельностиНДСПоступления(Дата, ВидДеятельностиНДСОрганизации, ХозяйственнаяОперация, Организация);
	Поле.Видимость = СписокДоступных.Количество() > 1;
	Для каждого Элемент Из СписокДоступных Цикл
		Поле.СписокВыбора.Добавить(Элемент.Значение, Элемент.Представление);
	КонецЦикла; 
	
КонецПроцедуры

// Проверяет корректность заполнения деятельности НДС поступления. Если значение не корректное, то очищается
//
// Параметры:
// 	 ВидДеятельностиНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - вид деятельности НДС
// 	 Дата - Дата - Дата документа
// 	 ВидДеятельностиНДСОрганизации - ПеречислениеСсылка.ТипыНалогообложенияНДС, Неопределено - текущий вид деятельности НДС организации
//
Процедура ПроверитьКорректностьДеятельностиНДСПоступления(ВидДеятельностиНДС, Дата, ВидДеятельностиНДСОрганизации, ХозяйственнаяОперация = Неопределено, Организация = Неопределено) Экспорт
	
	СписокДоступных = СписокДоступныхВидовДеятельностиНДСПоступления(Дата, ВидДеятельностиНДСОрганизации, ХозяйственнаяОперация, Организация);
	
	Если СписокДоступных.НайтиПоЗначению(ВидДеятельностиНДС) = Неопределено Тогда
		ВидДеятельностиНДС = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

// Заполняет список выбора вида деятельности НДС в документе потребления
// 
// Параметры:
// 	Поле - ПолеФормы - Поле выбора деятельности НДС
// 	Организация - СправочникСсылка.Организации - Организация документа
// 	Дата - Дата - Дата документа
// 	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - операция документа
//
Процедура ЗаполнитьСписокВыбораДеятельностиНДСПотребления(Поле, Организация, Дата, ХозяйственнаяОперация = Неопределено) Экспорт
	
	Поле.СписокВыбора.Очистить();
	СписокДоступных = СписокДоступныхВидовДеятельностиНДСПотребления(Организация, Дата, ХозяйственнаяОперация);
	Поле.Видимость = СписокДоступных.Количество() > 1;
	Для каждого Элемент Из СписокДоступных Цикл
		Поле.СписокВыбора.Добавить(Элемент.Значение, Элемент.Представление);
	КонецЦикла;
	
КонецПроцедуры

// Проверяет корректность заполнения деятельности НДС поступления. Если значение не корректное, то очищается
//
// Параметры:
// 	ВидДеятельностиНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - вид деятельности НДС
// 	Организация - СправочникСсылка.Организации - Организация документа
// 	Дата - Дата - Дата документа
// 	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - операция документа
//
Процедура ПроверитьКорректностьДеятельностиНДСПотребления(ВидДеятельностиНДС, Организация, Дата, ХозяйственнаяОперация = Неопределено) Экспорт
	
	СписокДоступных = СписокДоступныхВидовДеятельностиНДСПотребления(Организация, Дата, ХозяйственнаяОперация);
	
	Если СписокДоступных.НайтиПоЗначению(ВидДеятельностиНДС) = Неопределено Тогда
		ВидДеятельностиНДС = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

// Заполняет список выбора вида налогообложения НДС продажи
//
// Параметры:
//	Поле - ПолеФормы - Поле формы для выбора налогообложения
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа
//
Процедура ЗаполнитьСписокВыбораНалогообложенияПродажи(Поле, ХозяйственнаяОперация) Экспорт
	
	Поле.СписокВыбора.Очистить();
	СписокДоступных = СписокДоступныхВидовНалогообложенияПродажи(ХозяйственнаяОперация);
	Поле.Видимость = СписокДоступных.Количество() > 1;
	Для каждого Элемент Из СписокДоступных Цикл
		Поле.СписокВыбора.Добавить(Элемент.Значение, Элемент.Представление);
	КонецЦикла;
	
КонецПроцедуры

// Проверяет корректность заполнения налогообложения НДС продажи
//
// Параметры:
// 	НалогообложениеНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - налогообложение документа
//	ХозяйственнаяОперация - ПеречислениеСсылка.ХозяйственныеОперации - Хозяйственная операция документа
//
Процедура ПроверитьКорректностьНалогообложенияНДСПродажи(НалогообложениеНДС, ХозяйственнаяОперация) Экспорт
	
	СписокДоступных = СписокДоступныхВидовНалогообложенияПродажи(ХозяйственнаяОперация);
	
	Если СписокДоступных.НайтиПоЗначению(НалогообложениеНДС) = Неопределено Тогда
		НалогообложениеНДС = Неопределено;
	КонецЕсли;
	
КонецПроцедуры

// Проверяет возможность списания НДС на прочие расходы для указанной смены налогообложения.
//
// Параметры:
//	СтароеНалогообложение - ПеречислениеСсылка.ТипыНалогообложенияНДС
//	НовоеНалогообложение  - ПеречислениеСсылка.ТипыНалогообложенияНДС
//
// Возвращаемое значение:
//	Булево - признак того, что при такой смене налогообложения НДС может быть списан на прочие расходы,
//	 (если это предусмотрено учетной политикой организации)
//
Функция ВозможноСписаниеНДС(СтароеНалогообложение, НовоеНалогообложение) Экспорт
	
	Возврат (СтароеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС
	 	  	  ИЛИ СтароеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт
	 	  	  ИЛИ СтароеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг
	 	  	  ИЛИ СтароеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров
	 	  	  ИЛИ СтароеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию)
		И (НовоеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС
			ИЛИ НовоеНалогообложение = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД);
	
КонецФункции

// Устанавливает ограничения на типы запасов, которые можно продавать по указанному налогообложению
// 
// Параметры:
//   ОтборыВидовЗапасов - Структура - см. Справочники.ВидыЗапасов.ПараметрыОтбораВидовЗапасов
//   НалогообложениеНДС - ПеречислениеСсылка.ТипыНалогообложенияНДС - налогообложение реализации
//
Процедура ПараметрыЗаполненияВидовЗапасовПоНалогообложению(ОтборыВидовЗапасов, НалогообложениеНДС = Неопределено) Экспорт
	
	Если НалогообложениеНДС = Неопределено Тогда
		НалогообложениеНДС = ОтборыВидовЗапасов.НалогообложениеНДС;
	КонецЕсли;
	
	Если НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт Тогда
		
		ДоступныеТипыЗапасов = Новый Массив;
		ДоступныеТипыЗапасов.Добавить(Перечисления.ТипыЗапасов.Товар);
		ДоступныеТипыЗапасов.Добавить(Перечисления.ТипыЗапасов.ТоварНаХраненииСПравомПродажи);
		
		ОтборыВидовЗапасов.ТипЗапасов = ДоступныеТипыЗапасов;

	ИначеЕсли НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя Тогда
		
		ДоступныеТипыЗапасов = Новый Массив;
		ДоступныеТипыЗапасов.Добавить(Перечисления.ТипыЗапасов.Товар);
		ДоступныеТипыЗапасов.Добавить(Перечисления.ТипыЗапасов.ТоварНаХраненииСПравомПродажи);
		
		ОтборыВидовЗапасов.ТипЗапасов = ДоступныеТипыЗапасов;
		
	КонецЕсли;
	
КонецПроцедуры

// Устанавливаем условное оформление поля "Код ТН ВЭД" 
//
// Параметры:
//  Форма - Форма - Содержит данную форму
//  ИмяТЧ - Строка - Наименование ТЧ документа, если оно отличается от "Товары"
//
Процедура УстановитьУсловноеОформлениеКодаТНВЭД(Форма, ИмяТЧ = "Товары") Экспорт
	
	Если Не ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортНесырьевыхТоваров") 
		И Не ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортСырьевыхТоваровУслуг") Тогда
		Возврат;
	КонецЕсли;
	
	УсловноеОформление = Форма.УсловноеОформление;
	ЭлементыФормы = Форма.Элементы;
	
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяТЧ + "КодТНВЭД"].Имя);

	ГруппаОтбора1 = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаОтбора1.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИ;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров;
	
	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг;
	
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);	

	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();
	
	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяТЧ + "КодТНВЭД"].Имя);
	
	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект." + ИмяТЧ + ".ТипНоменклатуры");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.НеРавно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНоменклатуры.Товар;

	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ЦветТекста", ЦветаСтиля.ТекстЗапрещеннойЯчейкиЦвет);
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ОтметкаНезаполненного", Ложь);
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Текст", НСтр("ru = '<для товаров>'"));
	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
КонецПроцедуры

// Устанавливаем условное оформление для ставки НДС, суммы НДС, суммы с НДС
// в зависимости от того, облагается ли продажа НДС или ЕНВД
//
// Параметры:
//  Форма - Форма - Содержит данную форму
//  ИмяПоляВводаСтавкиНДС - Строка - Наименование элемента формы, содержащего ставку НДС,
//                                   если оно отличается от "ТоварыСтавкаНДС"
//  ИмяПоляВводаСуммыНДС - Строка - Наименование элемента формы, содержащего сумму НДС,
//                                  если оно отличается от "ТоварыСуммаНДС"
//  ИмяПоляВводаСуммыСНДС - Строка - Наименование элемента формы, содержащего сумму с НДС,
//                                   если оно отличается от "ТоварыСуммаСНДС"
//
Процедура УстановитьУсловноеОформлениеСуммНДС(Форма,
	                                          ИмяПоляВводаСтавкиНДС = "ТоварыСтавкаНДС",
	                                          ИмяПоляВводаСуммыНДС  = "ТоварыСуммаНДС",
	                                          ИмяПоляВводаСуммыСНДС = "ТоварыСуммаСНДС") Экспорт
	
	УсловноеОформление = Форма.УсловноеОформление;
	ЭлементыФормы = Форма.Элементы;
	
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСтавкиНДС].Имя);

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСуммыНДС].Имя);

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСуммыСНДС].Имя);

	ГруппаОтбора1 = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
	ГруппаОтбора1.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС;
	
	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.НалоговыйАгентПоНДС;

	ОтборЭлемента = ГруппаОтбора1.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя;

	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("Видимость", Ложь);
	
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСуммыНДС].Имя);

	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСтавкиНДС].ПутьКДанным);
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.ВСписке;
	СписокЗначений = Новый СписокЗначений;
	СписокЗначений.Добавить(Перечисления.СтавкиНДС.БезНДС);
	СписокЗначений.Добавить(Перечисления.СтавкиНДС.НДС0);
	ОтборЭлемента.ПравоеЗначение = СписокЗначений;

	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);

КонецПроцедуры

// Устанавливаем условное оформление для поля ставка НДС 
// в зависимости от налогообложения НДС документа
//
// Параметры:
//  Форма - Форма - Содержит данную форму 
//  ИмяПоляВводаСтавкаНДС - Строка - Наименование элемента формы, содержащего ставку НДС
//
Процедура УстановитьУсловноеОформлениеСтавкиНДС(Форма, ИмяПоляВводаСтавкаНДС = "ТоварыСтавкаНДС") Экспорт
	
	УсловноеОформление = Форма.УсловноеОформление;
	ЭлементыФормы = Форма.Элементы;
	
	ЭлементУсловногоОформления = УсловноеОформление.Элементы.Добавить();

	ПолеЭлемента = ЭлементУсловногоОформления.Поля.Элементы.Добавить();
	ПолеЭлемента.Поле = Новый ПолеКомпоновкиДанных(ЭлементыФормы[ИмяПоляВводаСтавкаНДС].Имя);

	ОтборЭлемента = ЭлементУсловногоОформления.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
	ОтборЭлемента.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Объект.НалогообложениеНДС");
	ОтборЭлемента.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
	ОтборЭлемента.ПравоеЗначение = Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт;

	ЭлементУсловногоОформления.Оформление.УстановитьЗначениеПараметра("ТолькоПросмотр", Истина);
	
КонецПроцедуры

// Устанавливает параметры запроса проведения по журналу счетов-фактур для счета-фактуры выставленного: 
//  ДатаВыставления и КодВидаОперацииКомиссия
//
// Параметры:
//  Реквизиты - ВыборкаИзРезультатаЗапроса - Выборка реквизитов шапки документа
//   *Необходимые реквизиты: Период, ДатаВыставления/ДатаПолучения, Исправление, ДатаСчетФактурыОснования, КодВидаОперации
//  Запрос - Запрос - Запрос проведения документа
//
Процедура УстановитьПараметрыЗапросаПроведенияПоЖурналуСчетаФактурыВыставленного(Реквизиты, Запрос) Экспорт
	
	ВерсияПостановления1137 = УчетНДСПереопределяемый.ВерсияПостановленияНДС1137(Макс(Реквизиты.ДатаВыставления,Реквизиты.Период));
	
	Если Не ЗначениеЗаполнено(Реквизиты.ДатаВыставления) Тогда
		ДатаВыставления = Реквизиты.Период;
	ИначеЕсли ВерсияПостановления1137 >= 4 Тогда
		ДатаВыставления = ?(Реквизиты.Исправление, Реквизиты.ДатаСчетФактурыОснования, Реквизиты.Период);
	Иначе
		ДатаВыставления = Реквизиты.ДатаВыставления;
	КонецЕсли;
		
	КодВидаОперацииКомиссия = 
		УчетНДСПереопределяемый.КодВидаОперацииКомиссия(Реквизиты.КодВидаОперации, ДатаВыставления);
	
	Запрос.УстановитьПараметр("ДатаВыставления",         ДатаВыставления);
	Запрос.УстановитьПараметр("КодВидаОперацииКомиссия", КодВидаОперацииКомиссия);
	
КонецПроцедуры

// Устанавливает параметры запроса проведения по журналу счетов-фактур для счета-фактуры полученного:
//  ДатаПолучения и КодВидаОперацииКомиссия
//
// Параметры:
//  Реквизиты - ВыборкаИзРезультатаЗапроса - Выборка реквизитов шапки документа
//   *Необходимые реквизиты: Период, ДатаПолучения, Исправление, ДатаИсправления, КодВидаОперации
//  Запрос - Запрос - Запрос проведения документа
//
Процедура УстановитьПараметрыЗапросаПроведенияПоЖурналуСчетаФактурыПолученного(Реквизиты, Запрос) Экспорт
	
	ВерсияПостановления1137 = УчетНДСПереопределяемый.ВерсияПостановленияНДС1137(Макс(Реквизиты.ДатаПолучения,Реквизиты.Период));
	
	Если Не ЗначениеЗаполнено(Реквизиты.ДатаПолучения) Тогда
		ДатаПолучения = Реквизиты.Период;
	ИначеЕсли ВерсияПостановления1137 >= 4 Тогда
		ДатаПолучения = ?(Реквизиты.Исправление, Реквизиты.ДатаИсправления, Реквизиты.Период);
	Иначе
		ДатаПолучения = Реквизиты.ДатаПолучения;
	КонецЕсли;
		
	КодВидаОперацииКомиссия = 
		УчетНДСПереопределяемый.КодВидаОперацииКомиссия(Реквизиты.КодВидаОперации, ДатаПолучения);
	
	Запрос.УстановитьПараметр("ДатаПолучения",           ДатаПолучения);
	Запрос.УстановитьПараметр("КодВидаОперацииКомиссия", КодВидаОперацииКомиссия);
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

#Область ФормированиеЗаписейКнигиПокупокПродаж

Процедура ВыполнитьРасчетСЗамеромВремени(ПараметрыРасчета)
	
	ОписаниеЗамера = ОценкаПроизводительности.НачатьЗамерДлительнойОперации("УчетНДС.ФормированиеЗаписейКнигПокупокИПродажПоПриобретеннымЦенностям");
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	КОЛИЧЕСТВО(*) КАК КоличествоЗаданий
	|ИЗ
	|	Задания";
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		КоличествоЗаданий = Выборка.КоличествоЗаданий;
	Иначе
		КоличествоЗаданий = 0;
	КонецЕсли;
	
	ВыполнитьРасчет(ПараметрыРасчета);
	
	ОценкаПроизводительности.ЗакончитьЗамерДлительнойОперации(ОписаниеЗамера, КоличествоЗаданий);
	
КонецПроцедуры

Процедура ВыполнитьРасчет(ПараметрыРасчета)
	
	СформироватьНДСПредъявленный(ПараметрыРасчета);
	СформироватьНДСЗаписиКнигиПокупок(ПараметрыРасчета);
	СформироватьНДСЗаписиКнигиПродаж(ПараметрыРасчета);
	
КонецПроцедуры

Функция МесяцДляРасчета(КонецПериода, НомерЗадания, МассивОрганизаций, МассивСчетовФактур)
	
	Месяц = Неопределено;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	НАЧАЛОПЕРИОДА(Задания.Месяц, МЕСЯЦ) КАК Месяц
	|ИЗ
	|	РегистрСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж КАК Задания
	|ГДЕ
	|	(Задания.Месяц <= &КонецПериода ИЛИ &КонецПериода = ДАТАВРЕМЯ(1,1,1))
	|	И Задания.НомерЗадания <= &НомерЗадания
	|	И (&ВсеОрганизации ИЛИ Задания.Организация В (&МассивОрганизаций))
	|	И (&ВсеСчетаФактуры ИЛИ Задания.СчетФактура В (&МассивСчетовФактур))
	|
	|УПОРЯДОЧИТЬ ПО
	|	НАЧАЛОПЕРИОДА(Задания.Месяц, МЕСЯЦ) ВОЗР
	|";
	
	Запрос.УстановитьПараметр("КонецПериода",       ?(КонецПериода = КонецМесяца(ТекущаяДатаСеанса()),'00010101',КонецПериода));
	Запрос.УстановитьПараметр("МассивОрганизаций",  МассивОрганизаций);
	Запрос.УстановитьПараметр("ВсеОрганизации",     Не ЗначениеЗаполнено(МассивОрганизаций));
	Запрос.УстановитьПараметр("МассивСчетовФактур", МассивСчетовФактур);
	Запрос.УстановитьПараметр("ВсеСчетаФактуры",    Не ЗначениеЗаполнено(МассивСчетовФактур));
	Запрос.УстановитьПараметр("НомерЗадания",       НомерЗадания);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Месяц = Выборка.Месяц;
	КонецЕсли;
	
	Возврат Месяц;
	
КонецФункции

Процедура ПолучитьЗадания(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Задания.Организация,
	|	Задания.СчетФактура
	|ПОМЕСТИТЬ Задания
	|ИЗ
	|	РегистрСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж КАК Задания
	|ГДЕ
	|	Задания.Месяц МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Задания.НомерЗадания <= &НомерЗадания
	|	И (&ВсеОрганизации ИЛИ Задания.Организация В (&МассивОрганизаций))
	|	И (&ВсеСчетаФактуры ИЛИ Задания.СчетФактура В (&МассивСчетовФактур)) 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|;
	|/////////////////////////////////////
	|ВЫБРАТЬ
	|	Задания.Месяц,
	|	Задания.НомерЗадания,
	|	Задания.Организация,
	|	Задания.СчетФактура
	|ПОМЕСТИТЬ ИсходныеЗадания
	|ИЗ
	|	РегистрСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж КАК Задания
	|ГДЕ
	|	Задания.Месяц МЕЖДУ &НачалоПериода И &КонецПериода
	|	И Задания.НомерЗадания <= &НомерЗадания
	|	И (&ВсеОрганизации ИЛИ Задания.Организация В (&МассивОрганизаций))
	|	И (&ВсеСчетаФактуры ИЛИ Задания.СчетФактура В (&МассивСчетовФактур)) 
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",      ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",       ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",  ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ВсеОрганизации",     Не ЗначениеЗаполнено(ПараметрыРасчета.МассивОрганизаций));
	Запрос.УстановитьПараметр("МассивСчетовФактур", ПараметрыРасчета.МассивСчетовФактур);
	Запрос.УстановитьПараметр("ВсеСчетаФактуры",    Не ЗначениеЗаполнено(ПараметрыРасчета.МассивСчетовФактур));
	Запрос.УстановитьПараметр("НомерЗадания",       ПараметрыРасчета.НомерЗадания);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ЗафиксироватьРезультат(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = "
	|ВЫБРАТЬ
	|	ЗаданияКОчистке.Месяц                               КАК Месяц,
	|	ЗаданияКОчистке.НомерЗадания                        КАК НомерЗадания,
	|	ЗаданияКОчистке.Организация                         КАК Организация,
	|	ЗаданияКОчистке.СчетФактура                         КАК СчетФактура
	|ИЗ
	|	ИсходныеЗадания КАК ЗаданияКОчистке
	|;
	|//////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Задания.Месяц                                 КАК Месяц,
	|	Задания.НомерЗадания                          КАК НомерЗадания,
	|	Задания.Организация                           КАК Организация,
	|	Задания.СчетФактура                           КАК СчетФактура
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		НАЧАЛОПЕРИОДА(НДСПредъявленный.Период, МЕСЯЦ) КАК Месяц,
	|		&НомерЗадания                                 КАК НомерЗадания,
	|		Задания.Организация                           КАК Организация,
	|		Задания.СчетФактура                           КАК СчетФактура
	|	ИЗ
	|		ИсходныеЗадания КАК Задания
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|		ПО НДСПредъявленный.Период > &КонецПериода
	|			И НДСПредъявленный.Организация = Задания.Организация
	|			И НДСПредъявленный.СчетФактура = Задания.СчетФактура
	|			И НДСПредъявленный.Активность
	|	
	|	ОБЪЕДИНИТЬ ВСЕ 
	|	
	|	ВЫБРАТЬ
	|		НАЧАЛОПЕРИОДА(НДССостояниеРеализации0.ДатаПодтверждения, МЕСЯЦ) КАК Месяц,
	|		&НомерЗадания                                КАК НомерЗадания,
	|		Партии.Организация                           КАК Организация,
	|		Партии.СчетФактура                           КАК СчетФактура
	|	ИЗ
	|		Партии КАК Партии
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.НДССостояниеРеализации0 КАК НДССостояниеРеализации0
	|		ПО Партии.Организация = НДССостояниеРеализации0.Организация
	|			И Партии.ДокументРеализации = НДССостояниеРеализации0.ДокументРеализации
	|			И НДССостояниеРеализации0.Состояние В (
	|				ЗНАЧЕНИЕ(Перечисление.НДССостоянияРеализация0.ПодтвержденаРеализация0),
	|				ЗНАЧЕНИЕ(Перечисление.НДССостоянияРеализация0.НеПодтвержденаРеализация0))
	|			И НДССостояниеРеализации0.ДатаПодтверждения > &КонецПериода
	|
	|	) КАК Задания
	|;
	|/////////////////////////////
	|УНИЧТОЖИТЬ ИсходныеЗадания
	|;
	|/////////////////////////////
	|УНИЧТОЖИТЬ Задания
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("НомерЗадания",      ПараметрыРасчета.НомерЗадания);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Результат = Запрос.ВыполнитьПакет();
	ВыборкаДляУдаления = Результат[0].Выбрать();
	ВыборкаДляЗаписи = Результат[1].Выбрать();
	
	Пока ВыборкаДляУдаления.Следующий() Цикл
		МенеджерЗаписи = РегистрыСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(МенеджерЗаписи, ВыборкаДляУдаления);
		МенеджерЗаписи.Удалить();
	КонецЦикла;
	
	Пока ВыборкаДляЗаписи.Следующий() Цикл
		МенеджерЗаписи = РегистрыСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж.СоздатьМенеджерЗаписи();
		ЗаполнитьЗначенияСвойств(МенеджерЗаписи, ВыборкаДляЗаписи);
		МенеджерЗаписи.Записать();
	КонецЦикла;
	
КонецПроцедуры

Процедура ПолучитьПартии(ПараметрыРасчета)
	
	Запрос = Новый Запрос();
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Партии.МоментВремени КАК МоментВремени,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	АналитикаУчетаПартий.Контрагент КАК Контрагент,
	|	Партии.ДокументПоступления КАК СчетФактура,
	|	ВЫБОР 
	|		КОГДА Партии.ДокументПоступления ССЫЛКА Документ.СчетФактураПолученныйНалоговыйАгент
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТоварыНалоговыйАгент)
	|		КОГДА Партии.ДокументПоступления ССЫЛКА Документ.СчетФактураНалоговыйАгент ТОГДА
	|			ВЫБОР 
	|				КОГДА ВЫРАЗИТЬ(Партии.ДокументПоступления КАК Документ.СчетФактураНалоговыйАгент).ВидАгентскогоДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.Аренда)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентАренда)
	|				КОГДА ВЫРАЗИТЬ(Партии.ДокументПоступления КАК Документ.СчетФактураНалоговыйАгент).ВидАгентскогоДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.РеализацияИмущества)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентРеализацияИмущества)
	|				КОГДА ВЫРАЗИТЬ(Партии.ДокументПоступления КАК Документ.СчетФактураНалоговыйАгент).ВидАгентскогоДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.НерезидентЭлектронныеУслуги)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентЭлектронныеУслуги)
	|				КОГДА ВЫРАЗИТЬ(Партии.ДокументПоступления КАК Документ.СчетФактураНалоговыйАгент).ВидАгентскогоДоговора = ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.Нерезидент)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентИностранцы)
	|			КОНЕЦ
	|		КОГДА Партии.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
	|		КОГДА Партии.ДокументПоступления ССЫЛКА Документ.ЗаявлениеОВвозеТоваров 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныйСоюз)
	|		ИНАЧЕ Партии.ВидЦенности 
	|	КОНЕЦ КАК ВидЦенности,
	|	АналитикаУчетаПартий.СтавкаНДС КАК СтавкаНДС,
	|	(ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИНАЧЕ Партии.НалогообложениеПартии
	|	КОНЕЦ) КАК НалогообложениеФинПартии,
	|
	|	(ВЫБОР
	|		КОГДА Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИНАЧЕ Партии.НалогообложениеНДС
	|	КОНЕЦ) КАК НалогообложениеПартии,
	|	
	|	Партии.СтатьяСписанияНДС КАК СтатьяСписанияНДС,
	|	ВЫБОР 
	|		КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 
	|			ТОГДА Партии.АналитикаСписанияНДС
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК АналитикаСписанияНДС,
	|	ВЫБОР 
	|		КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 
	|			ТОГДА Партии.НаправлениеДеятельностиСписанияНДС
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК НаправлениеДеятельностиСписанияНДС,
	|	ВЫБОР 
	|		КОГДА Партии.СтатьяСписанияНДС <> ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) 
	|			ТОГДА Партии.ПодразделениеСписанияНДС
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ КАК ПодразделениеСписанияНДС,
	|	
	|	Партии.ДокументРеализации КАК ДокументРеализации,
	|	
	|	СУММА(ВЫБОР КОГДА ТИПЗНАЧЕНИЯ(Партии.ДокументПоступления) В 
	|			(ТИП(Документ.ТаможеннаяДекларацияИмпорт),
	|			 ТИП(Документ.ЗаявлениеОВвозеТоваров),
	|			 ТИП(Документ.СчетФактураПолученныйНалоговыйАгент),
	|			 ТИП(Документ.СчетФактураНалоговыйАгент)) ТОГДА 
	|			0
	|		ИНАЧЕ
	|			Партии.СтоимостьРегл 
	|	КОНЕЦ) КАК СуммаБезНДС,
	|	СУММА(Партии.НДСРегл) КАК НДС,
	|	СУММА(Партии.НДСУпр) КАК НДСУпр
	|
	|ПОМЕСТИТЬ ПартииПредварительная
	|ИЗ (
	|	ВЫБРАТЬ
	|		Партии.МоментВремени,
	|		Партии.Период,
	|		Партии.Регистратор,
	|		Партии.Организация,
	|		Партии.СтоимостьРегл,
	|		Партии.НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.ДокументПоступления,
	|		Партии.АналитикаУчетаПартий,
	|		ВЫБОР 
	|			КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета ТОГДА
	|				ЕСТЬNULL(Партии.ВидЗапасов.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары))
	|			ИНАЧЕ ЕСТЬNULL(Партии.АналитикаУчетаНоменклатуры.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС ,ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)) 
	|		КОНЕЦ КАК ВидЦенности,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности КАК НаправлениеДеятельностиСписанияНДС,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ВЫРАЗИТЬ(Партии.АналитикаУчетаНоменклатуры.Склад КАК Справочник.Склады).Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА Партии.АналитикаУчетаНоменклатуры.Склад
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ПодразделениеСписанияНДС,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.РеализацияТоваровУслуг), 
	|					ТИП(Документ.АктВыполненныхРабот))
	|				ТОГДА Партии.Регистратор
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) = ТИП(Документ.КорректировкаРеализации)
	|				ТОГДА ВЫРАЗИТЬ(Партии.Регистратор КАК Документ.КорректировкаРеализации).ДокументОснование
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровОрганизаций КАК Партии
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаПартий КАК АналитикаПартий
	|		ПО 
	|			АналитикаПартий.Ссылка = Партии.АналитикаУчетаПартий
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО 
	|			АналитикаНоменклатуры.Ссылка = Партии.АналитикаУчетаНоменклатуры
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступления
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0.
	|		И Партии.ВидЗапасов.ТипЗапасов = ЗНАЧЕНИЕ(Перечисление.ТипыЗапасов.Товар)
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Партии.МоментВремени КАК МоментВремени,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.СтоимостьРегл КАК СтоимостьРегл,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.ДокументПоступления КАК ДокументПоступления,
	|		Партии.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ВЫБОР КОГДА Партии.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА 
	|				ВЫБОР 
	|					КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета ТОГДА
	|						ЕСТЬNULL(Партии.ВидЗапасов.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары))
	|					ИНАЧЕ ЕСТЬNULL(Партии.АналитикаУчетаНоменклатуры.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)) 
	|				КОНЕЦ
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ КАК ВидЦенности,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС КАК НалогообложениеНДС,
	|		Партии.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ВЫРАЗИТЬ(Партии.АналитикаУчетаНоменклатуры.Склад КАК Справочник.Склады).Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА Партии.АналитикаУчетаНоменклатуры.Склад
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.РеализацияТоваровУслуг), 
	|					ТИП(Документ.АктВыполненныхРабот))
	|				ТОГДА Партии.Регистратор
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) = ТИП(Документ.КорректировкаРеализации)
	|				ТОГДА ВЫРАЗИТЬ(Партии.Регистратор КАК Документ.КорректировкаРеализации).ДокументОснование
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииЗатратНаВыпуск КАК Партии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаПартий КАК АналитикаПартий
	|		ПО 
	|			АналитикаПартий.Ссылка = Партии.АналитикаУчетаПартий
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО 
	|			АналитикаНоменклатуры.Ссылка = Партии.АналитикаУчетаНоменклатуры
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступления
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Партии.МоментВремени КАК МоментВремени,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		(ВЫБОР
	|			КОГДА Партии.ДокументПоступления ССЫЛКА Документ.ТаможеннаяДекларацияИмпорт ТОГДА
	|				(ВЫБОР Партии.АналитикаУчетаПартий.СтавкаНДС
	|					КОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18) ТОГДА Партии.НДСРегл * 100 / 18
	|					КОГДА ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10) ТОГДА Партии.НДСРегл * 100 / 10
	|					ИНАЧЕ 0 КОНЕЦ)
	|			ИНАЧЕ Партии.СтоимостьРегл КОНЕЦ) КАК СтоимостьРегл,
	|		Партии.НДСРегл КАК НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.ДокументПоступленияРасходов КАК ДокументПоступления,
	|		Партии.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ВЫБОР 
	|			КОГДА НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL 
	|				ТОГДА СтатьиРасходов.ВидЦенностиНДС
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|				ТОГДА 
	|					ВЫБОР 
	|						КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета ТОГДА
	|							ЕСТЬNULL(Партии.ВидЗапасов.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары))
	|						ИНАЧЕ ЕСТЬNULL(Партии.АналитикаУчетаНоменклатуры.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)) 
	|					КОНЕЦ
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги)
	|		КОНЕЦ КАК ВидЦенности,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС КАК НалогообложениеНДС,
	|		Партии.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ВЫРАЗИТЬ(Партии.АналитикаУчетаНоменклатуры.Склад КАК Справочник.Склады).Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА Партии.АналитикаУчетаНоменклатуры.Склад
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.РеализацияТоваровУслуг), 
	|					ТИП(Документ.АктВыполненныхРабот))
	|				ТОГДА Партии.Регистратор
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) = ТИП(Документ.КорректировкаРеализации)
	|				ТОГДА ВЫРАЗИТЬ(Партии.Регистратор КАК Документ.КорректировкаРеализации).ДокументОснование
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииРасходовНаСебестоимостьТоваров КАК Партии
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаПартий КАК АналитикаПартий
	|		ПО 
	|			АналитикаПартий.Ссылка = Партии.АналитикаУчетаПартий
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|			Справочник.КлючиАналитикиУчетаНоменклатуры КАК АналитикаНоменклатуры
	|		ПО 
	|			АналитикаНоменклатуры.Ссылка = Партии.АналитикаУчетаНоменклатуры
	|		
	|		ЛЕВОЕ СОЕДИНЕНИЕ 
	|			ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО 
	|			Партии.СтатьяРасходов = СтатьиРасходов.Ссылка
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступленияРасходов
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		Партии.МоментВремени КАК МоментВремени,
	|		Партии.Период КАК Период,
	|		Партии.Регистратор КАК Регистратор,
	|		Партии.Организация КАК Организация,
	|		Партии.СтоимостьРегл КАК СтоимостьРегл,
	|		Партии.НДСРегл КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.ДокументПоступленияРасходов КАК ДокументПоступления,
	|		Партии.АналитикаУчетаПартий КАК АналитикаУчетаПартий,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаПартий.ВидЦенности <> ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПустаяСсылка)
	|				ТОГДА Партии.АналитикаУчетаПартий.ВидЦенности        // Версия ПартионногоУчета 2.2
	|			КОГДА НЕ СпрНоменклатура.ТипНоменклатуры ЕСТЬ NULL ТОГДА
	|				ВЫБОР 
	|					КОГДА СпрНоменклатура.ТипНоменклатуры В (
	|								ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|								ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|						ТОГДА ЕСТЬNULL(СпрНоменклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары))
	|					ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги)
	|				КОНЕЦ
	|			КОГДА НЕ СтатьиРасходов.Ссылка ЕСТЬ NULL
	|				ТОГДА СтатьиРасходов.ВидЦенностиНДС
	|			ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги)
	|		КОНЕЦ КАК ВидЦенности,
	|		ВЫБОР
	|			КОГДА Партии.ВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|				ТОГДА Партии.ВидДеятельностиНДС // Версия ПартионногоУчета 2.2
	|			ИНАЧЕ Партии.АналитикаУчетаПартий.НалогообложениеНДС     // Версия ПартионногоУчета 2.1             
	|		КОНЕЦ                     КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС КАК НалогообложениеНДС,
	|		НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК ПодразделениеСписанияНДС,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
	|		Партии.ДокументРеализации КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииПрочихРасходов КАК Партии
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступленияРасходов
	|		
	|		ЛЕВОЕ СОЕДИНЕНИЕ
	|			ПланВидовХарактеристик.СтатьиРасходов КАК СтатьиРасходов
	|		ПО 
	|			Партии.СтатьяРасходов = СтатьиРасходов.Ссылка
	|		
	|		ЛЕВОЕ СОЕДИНЕНИЕ
	|			Справочник.Номенклатура КАК СпрНоменклатура
	|		ПО
	|			Партии.АналитикаУчетаНоменклатуры.Номенклатура = СпрНоменклатура.Ссылка
	|		
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Партии.МоментВремени,
	|		Партии.Период,
	|		Партии.Регистратор,
	|		Партии.Организация,
	|		Партии.СтоимостьРегл,
	|		Партии.НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.ДокументПоступления,
	|		Партии.АналитикаУчетаПартий,
	|		ВЫБОР КОГДА Партии.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары) 
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ КАК ВидЦенности,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		Партии.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ВЫРАЗИТЬ(Партии.АналитикаУчетаНоменклатуры.Склад КАК Справочник.Склады).Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА Партии.АналитикаУчетаНоменклатуры.Склад
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.РеализацияТоваровУслуг), 
	|					ТИП(Документ.АктВыполненныхРабот))
	|				ТОГДА Партии.Регистратор
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) = ТИП(Документ.КорректировкаРеализации)
	|				ТОГДА ВЫРАЗИТЬ(Партии.Регистратор КАК Документ.КорректировкаРеализации).ДокументОснование
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииПроизводственныхЗатрат КАК Партии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступления
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	ВЫБРАТЬ
	|		Партии.МоментВремени,
	|		Партии.Период,
	|		Партии.Регистратор,
	|		Партии.Организация,
	|		Партии.СтоимостьРегл,
	|		Партии.НДСРегл,
	|		0 КАК НДСУпр,
	|		Партии.ДокументПоступления,
	|		Партии.АналитикаУчетаПартий,
	|		ВЫБОР КОГДА Партии.АналитикаУчетаНоменклатуры.Номенклатура.ТипНоменклатуры В (
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.Товар),
	|							ЗНАЧЕНИЕ(Перечисление.ТипыНоменклатуры.МногооборотнаяТара))
	|			ТОГДА 
	|				ВЫБОР 
	|					КОГДА &ФормироватьВидыЗапасовПоГруппамФинансовогоУчета ТОГДА
	|						ЕСТЬNULL(Партии.ВидЗапасов.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары))
	|					ИНАЧЕ ЕСТЬNULL(Партии.АналитикаУчетаНоменклатуры.Номенклатура.ГруппаФинансовогоУчета.ВидЦенностиНДС, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)) 
	|				КОНЕЦ 
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ПрочиеРаботыИУслуги) 
	|		КОНЕЦ КАК ВидЦенности,
	|		Партии.АналитикаУчетаПартий.НалогообложениеНДС КАК НалогообложениеПартии,
	|		Партии.НалогообложениеНДС,
	|		НЕОПРЕДЕЛЕНО КАК НаправлениеДеятельностиСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК ПодразделениеСписанияНДС,
	|		ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка) КАК СтатьяСписанияНДС,
	|		НЕОПРЕДЕЛЕНО КАК АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.ОтчетКомиссионера), 
	|					ТИП(Документ.ОтчетПоКомиссииМеждуОрганизациями))
	|				ТОГДА Партии.Регистратор
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ПартииТоваровПереданныеНаКомиссию КАК Партии
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступления
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДСРегл <> 0
	|		И Партии.НалогообложениеНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	ВЫБРАТЬ
	|		Партии.МоментВремени,
	|		Партии.Период,
	|		Партии.Регистратор,
	|		Партии.Организация,
	|		Партии.СтоимостьБезНДС КАК СтоимостьРегл,
	|		Партии.НДС КАК НДСРегл,
	|		Партии.НДСУпр КАК НДСУпр,
	|		Партии.ДокументПоступления,
	|		Партии.АналитикаУчетаПартий,
	|		ЕСТЬNULL(Партии.АналитикаУчетаПартий.ВидЦенности, ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.Товары)) КАК ВидЦенности,
	|		Партии.ВидДеятельностиНДС КАК НалогообложениеПартии,
	|		Партии.КорВидДеятельностиНДС КАК НалогообложениеНДС,
	|		Партии.АналитикаУчетаНоменклатуры.Назначение.НаправлениеДеятельности,
	|		ВЫБОР 
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.Склады
	|				ТОГДА ВЫРАЗИТЬ(Партии.АналитикаУчетаНоменклатуры.Склад КАК Справочник.Склады).Подразделение
	|			КОГДА Партии.АналитикаУчетаНоменклатуры.Склад ССЫЛКА Справочник.СтруктураПредприятия
	|				ТОГДА Партии.АналитикаУчетаНоменклатуры.Склад
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ,
	|		Партии.СтатьяСписанияНДС,
	|		Партии.АналитикаСписанияНДС,
	|		ВЫБОР 
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) В (
	|					ТИП(Документ.РеализацияТоваровУслуг), 
	|					ТИП(Документ.АктВыполненныхРабот))
	|				ТОГДА Партии.Регистратор
	|			КОГДА ТИПЗНАЧЕНИЯ(Партии.Регистратор) = ТИП(Документ.КорректировкаРеализации)
	|				ТОГДА ВЫРАЗИТЬ(Партии.Регистратор КАК Документ.КорректировкаРеализации).ДокументОснование
	|			ИНАЧЕ НЕОПРЕДЕЛЕНО
	|		КОНЕЦ КАК ДокументРеализации
	|	ИЗ
	|		РегистрНакопления.ДетализацияПартийТоваровДляНДСиУСН КАК Партии
	|		
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			Задания.Организация = Партии.Организация
	|			И Задания.СчетФактура = Партии.ДокументПоступления
	|	ГДЕ
	|		Партии.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Партии.Активность
	|		И Партии.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|		И Партии.НДС <> 0
	|		И Партии.КорВидДеятельностиНДС <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	) КАК Партии
	|	
	|ГДЕ
	|	Партии.НалогообложениеПартии <> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)
	|	
	|
	|СГРУППИРОВАТЬ ПО
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	АналитикаУчетаПартий.Контрагент,
	|	Партии.ДокументПоступления,
	|	Партии.ВидЦенности,
	|	АналитикаУчетаПартий.СтавкаНДС,
	|
	|	(ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИНАЧЕ Партии.НалогообложениеПартии
	|	КОНЕЦ),
	|	(ВЫБОР
	|		КОГДА Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|		КОГДА Партии.НалогообложениеНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИНАЧЕ Партии.НалогообложениеНДС
	|	КОНЕЦ),
	|	Партии.НаправлениеДеятельностиСписанияНДС,
	|	Партии.ПодразделениеСписанияНДС,
	|	Партии.СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС,
	|	Партии.ДокументРеализации
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.МоментВремени КАК МоментВремени,
	|	Партии.Период КАК Период,
	|	Партии.Регистратор КАК Регистратор,
	|	Партии.Организация КАК Организация,
	|	Партии.Контрагент КАК Контрагент,
	|	Партии.СчетФактура КАК СчетФактура,
	|	ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1, 1, 1)) КАК ДатаПоступления,
	|	Партии.ВидЦенности КАК ВидЦенности,
	|	Партии.СтавкаНДС КАК СтавкаНДС,
	|	Партии.НалогообложениеФинПартии КАК НалогообложениеФинПартии,
	|	Партии.НалогообложениеПартии КАК НалогообложениеПартии,
	|	Партии.СтатьяСписанияНДС КАК СтатьяСписанияНДС,
	|	Партии.АналитикаСписанияНДС КАК АналитикаСписанияНДС,
	|	Партии.НаправлениеДеятельностиСписанияНДС КАК НаправлениеДеятельностиСписанияНДС,
	|	Партии.ПодразделениеСписанияНДС КАК ПодразделениеСписанияНДС,
	|	Партии.ДокументРеализации КАК ДокументРеализации,
	|	Партии.СуммаБезНДС КАК СуммаБезНДС,
	|	Партии.НДС КАК НДС,
	|	Партии.НДСУпр КАК НДСУпр
	|ПОМЕСТИТЬ Партии
	|ИЗ
	|	ПартииПредварительная КАК Партии
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО Партии.Организация = ДанныеПервичныхДокументов.Организация
	|			И Партии.СчетФактура = ДанныеПервичныхДокументов.Документ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ПартииПредварительная
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",           ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",            ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",       ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ДатаНачалаДействия150ФЗ", ДатаНачалаДействия150ФЗ());
	Запрос.УстановитьПараметр("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета", ПолучитьФункциональнуюОпцию("ФормироватьВидыЗапасовПоГруппамФинансовогоУчета"));
	
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

#Область ФормированиеДвиженияНДСПредъявленный

Функция СформироватьНДСПредъявленный(ПараметрыРасчета)
	
	ПолучитьТекущиеРегистраторыНДСПредъявленный(ПараметрыРасчета);
	ПолучитьСчетаФактурыДокументы(ПараметрыРасчета);
	ПолучитьИсправительныеСчетаФактурыДокументы(ПараметрыРасчета);
	
	ПолучитьПартии(ПараметрыРасчета);
	
	ПолучитьСписанияНДСНаРасходы(ПараметрыРасчета);
	ПолучитьБлокировкиВычетаНДС(ПараметрыРасчета);
	
	ПолучитьНДСПредъявленныйОстатокНаНачало(ПараметрыРасчета);
	ПолучитьНДСПредъявленныйОнлайнДвижения(ПараметрыРасчета);
	
	РассчитатьЗаписиНДСПредъявленныйПоИСФ(ПараметрыРасчета);
	РассчитатьЗаписиНДСПредъявленныйИзменениеВидаДеятельности(ПараметрыРасчета);
	РассчитатьЗаписиНДСПредъявленныйВосстановлениеПодВидДеятельности(ПараметрыРасчета);
	
	ПолучитьОстаткиНДСПредъявленныйНаКонецПериода(ПараметрыРасчета);
	
	РассчитатьЗаписиНДСПредъявленныйПринятиеКВычету(ПараметрыРасчета);
	РассчитатьЗаписиНДСПредъявленныйВосстановлениеПоКСФ(ПараметрыРасчета);
	
	РассчитатьЗаписиНДСПредъявленныйСохранение(ПараметрыРасчета);
	
	ЗаписатьНДСПредъявленный(ПараметрыРасчета);
	ОчиститьНДСПредъявленный(ПараметрыРасчета);
	
Конецфункции

Процедура ПолучитьСчетаФактурыДокументы(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Задания.Организация 									КАК Организация,
	|	Задания.СчетФактура 									КАК СчетФактура,
	|	ПодтверждениеОплатыНДСВБюджет.ДатаПодтвержденияОплаты 	КАК ДатаПодтвержденияОплаты
	|ПОМЕСТИТЬ ПодтвержденияОплаты
	|ИЗ
	|	РегистрСведений.ПодтверждениеОплатыНДСВБюджет КАК ПодтверждениеОплатыНДСВБюджет
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО ПодтверждениеОплатыНДСВБюджет.СчетФактура = Задания.СчетФактура
	|ГДЕ
	|	ПодтверждениеОплатыНДСВБюджет.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОплатыНДСВБюджет.ПолученоПодтверждение)
	|	И ПодтверждениеОплатыНДСВБюджет.ДатаПодтвержденияОплаты <= &КонецПериода
	|;
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Задания.Организация КАК Организация,
	|	Задания.СчетФактура КАК СчетФактура,
	|	Операция.Ссылка     КАК Ссылка,
	|	Операция.Дата       КАК Дата,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL
	|			ТОГДА КОНЕЦПЕРИОДА(Операция.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		КОГДА Операция.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА Операция.Дата
	|		ИНАЧЕ
	|			Операция.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ)              КАК ДатаЗаписиКнигиПокупок,
	|	НЕОПРЕДЕЛЕНО        КАК ДокументОплаты,
	|	НЕОПРЕДЕЛЕНО        КАК ДоговорКонтрагента
	|ПОМЕСТИТЬ СчетаФактурыДокументы
	|ИЗ
	|	Документ.СчетФактураПолученный КАК Операция
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Документ.СчетФактураПолученный.ДокументыОснования КАК Строки
	|	ПО 
	|		Операция.Ссылка = Строки.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Задания КАК Задания
	|	ПО 
	|		Операция.Организация = Задания.Организация
	|		И Строки.ДокументОснование = Задания.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
	|	ПО
	|		Операция.Корректировочный
	|		И ПартииПрочихРасходов.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Строки.ДокументОснование = ПартииПрочихРасходов.Регистратор
	|		И ПартииПрочихРасходов.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|ГДЕ
	|	Операция.Проведен
	|	И НЕ Операция.Исправление
	|
	|СГРУППИРОВАТЬ ПО
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	Операция.Ссылка,
	|	Операция.Дата 
	|
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL
	|			ТОГДА КОНЕЦПЕРИОДА(Операция.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		КОГДА Операция.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА Операция.Дата
	|		ИНАЧЕ
	|			Операция.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ) <= &КонецПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Задания.Организация КАК Организация,
	|	Задания.СчетФактура КАК СчетФактура,
	|	Операция.Ссылка     КАК Ссылка,
	|	Операция.Дата       КАК Дата,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL
	|			ТОГДА КОНЕЦПЕРИОДА(Операция.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		КОГДА Операция.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА Операция.Дата
	|		ИНАЧЕ
	|			Операция.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ)              КАК ДатаЗаписиКнигиПокупок,
	|	НЕОПРЕДЕЛЕНО        КАК ДокументОплаты,
	|	НЕОПРЕДЕЛЕНО        КАК ДоговорКонтрагента
	|ИЗ
	|	Документ.СчетФактураПолученныйНалоговыйАгент КАК Операция
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		Задания КАК Задания
	|	ПО 
	|		Операция.Организация = Задания.Организация
	|		И Операция.Ссылка = Задания.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
	|	ПО
	|		Операция.Корректировочный
	|		И ПартииПрочихРасходов.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И Операция.Ссылка = ПартииПрочихРасходов.ДокументПоступленияРасходов
	|		И ПартииПрочихРасходов.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|ГДЕ
	|	Операция.Проведен
	|	И НЕ Операция.Исправление
	|
	|СГРУППИРОВАТЬ ПО
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	Операция.Ссылка,
	|	Операция.Дата 
	|
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL
	|			ТОГДА КОНЕЦПЕРИОДА(Операция.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		КОГДА Операция.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА Операция.Дата
	|		ИНАЧЕ
	|			Операция.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ) <= &КонецПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Задания.Организация КАК Организация,
	|	Задания.СчетФактура КАК СчетФактура,
	|	Операция.Ссылка     КАК Ссылка,
	|	Операция.ДатаВыставления КАК Дата,
	|	Операция.ДатаВыставления КАК ДатаЗаписиКнигиПокупок,
	|	НЕОПРЕДЕЛЕНО        КАК ДокументОплаты,
	|	НЕОПРЕДЕЛЕНО        КАК ДоговорКонтрагента
	|ИЗ
	|	Документ.СчетФактураВыданный КАК Операция
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК Строки
	|		ПО Операция.Ссылка = Строки.Ссылка
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО Операция.Контрагент = Задания.Организация
	|		И Строки.ДокументОснование = Задания.СчетФактура
	|		И ВЫРАЗИТЬ(Строки.ДокументОснование КАК Документ.ПередачаТоваровМеждуОрганизациями).НалогообложениеНДС 
	|			<> ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя)
	|ГДЕ
	|	Операция.ДатаВыставления <= &КонецПериода
	|	И Операция.ДатаВыставления <> ДАТАВРЕМЯ(1, 1, 1)
	|	И Операция.Проведен
	|	И НЕ Операция.Исправление
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПодтвержденияОплаты.Организация КАК Организация,
	|	ПодтвержденияОплаты.СчетФактура КАК СчетФактура,
	|	Операция.Ссылка     КАК Ссылка,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > Операция.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		Операция.Дата 
	|	КОНЕЦ КАК Дата,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > Операция.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		Операция.Дата 
	|	КОНЕЦ КАК ДатаЗаписиКнигиПокупок,
	|	НЕОПРЕДЕЛЕНО        КАК ДокументОплаты,
	|	НЕОПРЕДЕЛЕНО        КАК ДоговорКонтрагента
	|ИЗ
	|	Документ.ТаможеннаяДекларацияИмпорт КАК Операция
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПодтвержденияОплаты КАК ПодтвержденияОплаты
	|	ПО
	|		Операция.Ссылка = ПодтвержденияОплаты.СчетФактура
	|ГДЕ
	|	Операция.Статус = ЗНАЧЕНИЕ(Перечисление.СтатусыТаможенныхДеклараций.ВыпущеноСТаможни)
	|	И Операция.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПодтвержденияОплаты.Организация           КАК Организация,
	|	ПодтвержденияОплаты.СчетФактура           КАК СчетФактура,
	|	ЗаявлениеОВвозеТоваров.Ссылка 			  КАК Ссылка,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > ЗаявлениеОВвозеТоваров.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		ЗаявлениеОВвозеТоваров.Дата 
	|	КОНЕЦ КАК Дата,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > ЗаявлениеОВвозеТоваров.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		ЗаявлениеОВвозеТоваров.Дата 
	|	КОНЕЦ КАК ДатаЗаписиКнигиПокупок,
	|	НЕОПРЕДЕЛЕНО                  КАК ДокументОплаты,
	|	НЕОПРЕДЕЛЕНО                  КАК ДоговорКонтрагента
	|ИЗ
	|	Документ.ЗаявлениеОВвозеТоваров КАК ЗаявлениеОВвозеТоваров
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПодтвержденияОплаты КАК ПодтвержденияОплаты
	|	ПО
	|		ЗаявлениеОВвозеТоваров.Ссылка = ПодтвержденияОплаты.СчетФактура
	|ГДЕ
	|	ЗаявлениеОВвозеТоваров.Проведен
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ПодтвержденияОплаты.Организация КАК Организация,
	|	ПодтвержденияОплаты.СчетФактура КАК СчетФактура,
	|	СчетФактураНалоговыйАгент.Ссылка  КАК Ссылка,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > СчетФактураНалоговыйАгент.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		СчетФактураНалоговыйАгент.Дата 
	|	КОНЕЦ КАК Дата,
	|	ВЫБОР КОГДА КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ) > СчетФактураНалоговыйАгент.Дата ТОГДА
	|		КОНЕЦПЕРИОДА(ПодтвержденияОплаты.ДатаПодтвержденияОплаты, ДЕНЬ)
	|	ИНАЧЕ 
	|		СчетФактураНалоговыйАгент.Дата 
	|	КОНЕЦ КАК ДатаЗаписиКнигиПокупок,
	|	СчетФактураНалоговыйАгент.ДокументОснование              КАК ДокументОплаты,
	|	СчетФактураНалоговыйАгент.Договор                        КАК ДоговорКонтрагента
	|ИЗ
	|	Документ.СчетФактураНалоговыйАгент КАК СчетФактураНалоговыйАгент
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПодтвержденияОплаты КАК ПодтвержденияОплаты
	|	ПО
	|		СчетФактураНалоговыйАгент.Ссылка = ПодтвержденияОплаты.СчетФактура
	|ГДЕ
	|	СчетФактураНалоговыйАгент.Проведен
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьИсправительныеСчетаФактурыДокументы(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	0 КАК Приоритет,
	|	Задания.Организация КАК Организация,
	|	Задания.СчетФактура КАК СчетФактура,
	|	КорректировкаПриобретенияИсправление.Ссылка КАК ИсправительныйСчетФактура,
	|	ИсправительныйСчетФактура.Ссылка КАК Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления КАК НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаИсправления КАК ДатаИсправления,
	|	ВЫБОР
	|		КОГДА ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаИсправления
	|		ИНАЧЕ ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ КАК ДатаЗаписиКнигиПокупок,
	|	КорректировкаПриобретенияИсправление.МоментВремени КАК МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата КАК ДатаПолучения,
	|	ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу КАК ЗаписьДополнительногоЛиста,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ КАК КорректируемыйПериод
	|ПОМЕСТИТЬ ВсеИсправительныеСчетаФактуры
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК КорректировкаПриобретенияИсправление
	|		ПО Задания.СчетФактура = КорректировкаПриобретенияИсправление.ДокументОснование
	|			И (КорректировкаПриобретенияИсправление.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ИсправлениеОшибок))
	|			И (КорректировкаПриобретенияИсправление.Проведен)
	|			И (КорректировкаПриобретенияИсправление.Дата <= &КонецПериода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК ИсправительныйСчетФактура
	|		ПО (КорректировкаПриобретенияИсправление.Ссылка = ИсправительныйСчетФактура.ДокументОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|			И (НЕ ИсправительныйСчетФактура.Ссылка.Корректировочный)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК ДругиеИсправительныеСчетаФактуры
	|		ПО (ИсправительныйСчетФактура.Ссылка.СчетФактураОснование = ДругиеИсправительныеСчетаФактуры.СчетФактураОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.НомерИсправления > ДругиеИсправительныеСчетаФактуры.НомерИсправления)
	|			И (ДругиеИсправительныеСчетаФактуры.Проведен)
	|			И (ДругиеИсправительныеСчетаФактуры.Исправление)
	|			И (ДругиеИсправительныеСчетаФактуры.Дата <= &КонецПериода)
	|			И (НЕ ДругиеИсправительныеСчетаФактуры.Корректировочный)
	|ГДЕ
	|	ДругиеИсправительныеСчетаФактуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	0 КАК Приоритет,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	КорректировкаПриобретенияИсправление.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаИсправления,
	|	ВЫБОР
	|		КОГДА ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок = ДАТАВРЕМЯ(1, 1, 1)
	|			ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаИсправления
	|		ИНАЧЕ ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ,
	|	КорректировкаПриобретенияИсправление.МоментВремени КАК МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК КорректировкаПриобретенияПоСогласованию
	|		ПО Задания.СчетФактура = КорректировкаПриобретенияПоСогласованию.Ссылка
	|			И (КорректировкаПриобретенияПоСогласованию.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон))
	|			И (КорректировкаПриобретенияПоСогласованию.Проведен)
	|			И (КорректировкаПриобретенияПоСогласованию.Дата <= &КонецПериода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.КорректировкаПриобретения КАК КорректировкаПриобретенияИсправление
	|		ПО (КорректировкаПриобретенияПоСогласованию.ДокументОснование = КорректировкаПриобретенияИсправление.ДокументОснование)
	|			И (КорректировкаПриобретенияПоСогласованию.Дата < КорректировкаПриобретенияИсправление.Дата)
	|			И (КорректировкаПриобретенияИсправление.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ИсправлениеОшибок))
	|			И (КорректировкаПриобретенияИсправление.Проведен)
	|			И (КорректировкаПриобретенияИсправление.Дата <= &КонецПериода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК ИсправительныйСчетФактура
	|		ПО (КорректировкаПриобретенияИсправление.Ссылка = ИсправительныйСчетФактура.ДокументОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|			И (ИсправительныйСчетФактура.Ссылка.Корректировочный)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК ДругиеИсправительныеСчетаФактуры
	|		ПО (ИсправительныйСчетФактура.Ссылка.СчетФактураОснование = ДругиеИсправительныеСчетаФактуры.СчетФактураОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.НомерИсправления > ДругиеИсправительныеСчетаФактуры.НомерИсправления)
	|			И (ДругиеИсправительныеСчетаФактуры.Проведен)
	|			И (ДругиеИсправительныеСчетаФактуры.Исправление)
	|			И (ДругиеИсправительныеСчетаФактуры.Дата <= &КонецПериода)
	|			И (НЕ ДругиеИсправительныеСчетаФактуры.Корректировочный)
	|ГДЕ
	|	ДругиеИсправительныеСчетаФактуры.Ссылка ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	1 КАК Приоритет,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок,
	|	ИсправительныйСчетФактура.Ссылка.МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК ИсправительныйСчетФактура
	|		ПО Задания.СчетФактура = ИсправительныйСчетФактура.ДокументОснование
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	1,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок,
	|	ИсправительныйСчетФактура.Ссылка.МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный.ДокументыОснования КАК СчетФактураПолученныйОснования
	|		ПО Задания.СчетФактура = СчетФактураПолученныйОснования.ДокументОснование
	|			И (СчетФактураПолученныйОснования.Ссылка.Проведен)
	|			И (СчетФактураПолученныйОснования.Ссылка.Дата <= &КонецПериода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученный КАК ИсправительныйСчетФактура
	|		ПО (СчетФактураПолученныйОснования.Ссылка = ИсправительныйСчетФактура.СчетФактураОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	0 КАК Приоритет,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.НомерИсправления,
	|	ИсправительныйСчетФактура.ДатаИсправления,
	|	ИсправительныйСчетФактура.ДатаЗаписиКнигиПокупок,
	|	ИсправительныйСчетФактура.МоментВремени,
	|	ИсправительныйСчетФактура.Дата,
	|	ИсправительныйСчетФактура.ОтнестиКПредыдущемуОтчетномуКварталу,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК ИсправительныйСчетФактура
	|		ПО Задания.СчетФактура = ИсправительныйСчетФактура.СчетФактураОснование
	|			И (ИсправительныйСчетФактура.Проведен)
	|			И (ИсправительныйСчетФактура.Исправление)
	|			И (ИсправительныйСчетФактура.Дата <= &КонецПериода)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	1,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаИсправления,
	|	ИсправительныйСчетФактура.Ссылка.ДатаЗаписиКнигиПокупок,
	|	ИсправительныйСчетФактура.Ссылка.МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу,
	|	ВЫБОР КОГДА ИсправительныйСчетФактура.Ссылка.ОтнестиКПредыдущемуОтчетномуКварталу 
	|		ТОГДА ИсправительныйСчетФактура.Ссылка.ДатаСоставления
	|	ИНАЧЕ ДАТАВРЕМЯ(1,1,1) КОНЕЦ
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент.ДокументыОснования КАК СчетФактураПолученныйОснования
	|		ПО Задания.СчетФактура = СчетФактураПолученныйОснования.ДокументОснование
	|			И (СчетФактураПолученныйОснования.Ссылка.Проведен)
	|			И (СчетФактураПолученныйОснования.Ссылка.Дата <= &КонецПериода)
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураПолученныйНалоговыйАгент КАК ИсправительныйСчетФактура
	|		ПО (СчетФактураПолученныйОснования.Ссылка = ИсправительныйСчетФактура.СчетФактураОснование)
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	1 КАК Приоритет,
	|	Задания.Организация,
	|	Задания.СчетФактура,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка,
	|	ИсправительныйСчетФактура.Ссылка.НомерИсправления,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ИсправительныйСчетФактура.Ссылка.МоментВремени,
	|	ИсправительныйСчетФактура.Ссылка.Дата,
	|	ЛОЖЬ,
	|	ДАТАВРЕМЯ(1,1,1)
	|ИЗ
	|	Задания КАК Задания
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.СчетФактураВыданный.ДокументыОснования КАК ИсправительныйСчетФактура
	|		ПО Задания.СчетФактура = ИсправительныйСчетФактура.ДокументОснование
	|			И (ИсправительныйСчетФактура.Ссылка.Проведен)
	|			И (ИсправительныйСчетФактура.Ссылка.Исправление)
	|			И (ИсправительныйСчетФактура.Ссылка.Дата <= &КонецПериода)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ИсправительныеСчетаФактуры.Приоритет КАК Приоритет,
	|	ИсправительныеСчетаФактуры.Организация КАК Организация,
	|	ИсправительныеСчетаФактуры.СчетФактура КАК СчетФактура,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура КАК ИсправительныйСчетФактура,
	|	ИсправительныеСчетаФактуры.Ссылка КАК Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаИсправления КАК ДатаИсправления,
	|	ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок КАК ДатаЗаписиКнигиПокупок,
	|	ИсправительныеСчетаФактуры.МоментВремени КАК МоментВремени,
	|	ИсправительныеСчетаФактуры.ДатаПолучения,
	|	ИсправительныеСчетаФактуры.ЗаписьДополнительногоЛиста,
	|	ИсправительныеСчетаФактуры.КорректируемыйПериод
	|ПОМЕСТИТЬ ИсправительныеСчетаФактурыПредварительная
	|ИЗ
	|	ВсеИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ ВсеИсправительныеСчетаФактуры КАК ОтборПоследнееИсправление
	|		ПО ИсправительныеСчетаФактуры.Организация = ОтборПоследнееИсправление.Организация
	|			И ИсправительныеСчетаФактуры.СчетФактура = ОтборПоследнееИсправление.СчетФактура
	|			И ИсправительныеСчетаФактуры.НомерИсправления < ОтборПоследнееИсправление.НомерИсправления
	|
	|ГДЕ
	|	ОтборПоследнееИсправление.ИсправительныйСчетФактура ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	ИсправительныеСчетаФактуры.Организация КАК Организация,
	|	ИсправительныеСчетаФактуры.СчетФактура КАК СчетФактура,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура КАК ИсправительныйСчетФактура,
	|	ИсправительныеСчетаФактуры.Ссылка КАК Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаИсправления КАК ДатаИсправления,
	|	ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок КАК ДатаЗаписиКнигиПокупок,
	|	ИсправительныеСчетаФактуры.МоментВремени КАК МоментВремени,
	|	ИсправительныеСчетаФактуры.ДатаПолучения,
	|	ИсправительныеСчетаФактуры.ЗаписьДополнительногоЛиста,
	|	ИсправительныеСчетаФактуры.КорректируемыйПериод
	|ПОМЕСТИТЬ ИсправительныеСчетаФактурыПоследние
	|ИЗ
	|	ИсправительныеСчетаФактурыПредварительная КАК ИсправительныеСчетаФактуры
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактурыПредварительная КАК ОтборПриоритет
	|		ПО ИсправительныеСчетаФактуры.Организация = ОтборПриоритет.Организация
	|			И ИсправительныеСчетаФактуры.СчетФактура = ОтборПриоритет.СчетФактура
	|			И ИсправительныеСчетаФактуры.Приоритет > ОтборПриоритет.Приоритет
	|
	|ГДЕ
	|	ОтборПриоритет.Ссылка ЕСТЬ NULL
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	ИсправительныйСчетФактура
	|;
	|
	|ВЫБРАТЬ
	|	ИсправительныеСчетаФактуры.Организация КАК Организация,
	|	ИсправительныеСчетаФактуры.СчетФактура КАК СчетФактура,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура КАК ИсправительныйСчетФактура,
	|	ИсправительныеСчетаФактуры.Ссылка КАК Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаИсправления КАК ДатаИсправления,
	|	ИсправительныеСчетаФактуры.МоментВремени КАК МоментВремени,
	|	ИсправительныеСчетаФактуры.ДатаПолучения КАК ДатаПолучения,
	|	МАКСИМУМ(ВЫБОР 
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL 
	|			ТОГДА КОНЕЦПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		ИНАЧЕ ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ) КАК ДатаЗаписиКнигиПокупок,
	|	ИсправительныеСчетаФактуры.ЗаписьДополнительногоЛиста,
	|	ИсправительныеСчетаФактуры.КорректируемыйПериод
	|
	|ПОМЕСТИТЬ ИсправительныеСчетаФактуры
	|ИЗ
	|	ИсправительныеСчетаФактурыПоследние КАК ИсправительныеСчетаФактуры
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.ПартииПрочихРасходов КАК ПартииПрочихРасходов
	|	ПО
	|		ПартииПрочихРасходов.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И ИсправительныеСчетаФактуры.ИсправительныйСчетФактура = ПартииПрочихРасходов.Регистратор
	|		И ПартииПрочихРасходов.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением)
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсправительныеСчетаФактуры.Организация,
	|	ИсправительныеСчетаФактуры.СчетФактура,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура,
	|	ИсправительныеСчетаФактуры.Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаИсправления,
	|	ИсправительныеСчетаФактуры.МоментВремени,
	|	ИсправительныеСчетаФактуры.ДатаПолучения,
	|	ИсправительныеСчетаФактуры.ЗаписьДополнительногоЛиста,
	|	ИсправительныеСчетаФактуры.КорректируемыйПериод
	|
	|ИМЕЮЩИЕ
	|	МАКСИМУМ(ВЫБОР 
	|		КОГДА НЕ ПартииПрочихРасходов.Регистратор ЕСТЬ NULL 
	|			ТОГДА КОНЕЦПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, КВАРТАЛ)
	|		ИНАЧЕ ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок
	|	КОНЕЦ) <= &КонецПериода
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура,
	|	ИсправительныйСчетФактура
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ВсеИсправительныеСчетаФактуры
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИсправительныеСчетаФактурыПредварительная
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ ИсправительныеСчетаФактурыПоследние
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьДокументыОплаты(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	СчетаФактурыДокументы.Организация КАК Организация,
	|	СчетаФактурыДокументы.СчетФактура КАК СчетФактура,
	|	ДокументыОплаты.НомерДокументаПеречисленияНалога КАК НомерДокументаОплаты,
	|	ДокументыОплаты.ДатаДокументаПеречисленияНалога КАК ДатаДокументаОплаты
	|ПОМЕСТИТЬ ДокументыОплаты
	|ИЗ
	|	СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПодтверждениеОплатыНДСВБюджет КАК ДокументыОплаты
	|		ПО СчетаФактурыДокументы.Ссылка = ДокументыОплаты.СчетФактура
	|			И (ДокументыОплаты.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОплатыНДСВБюджет.Оплачено))
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура";
	
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();

КонецПроцедуры

Процедура ПолучитьСписанияНДСНаРасходы(ПараметрыРасчета) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Задания.Организация                          КАК Организация,
	|	Задания.СчетФактура                          КАК СчетФактура,
	|	СписаниеНДСНаРасходы.Ссылка                  КАК СписаниеНДСНаРасходы,
	|	СписаниеНДСНаРасходы.Подразделение           КАК Подразделение,
	|	СписаниеНДСНаРасходы.СтатьяРасходов          КАК СтатьяРасходов,
	|	СписаниеНДСНаРасходы.АналитикаРасходов       КАК АналитикаРасходов
	|ПОМЕСТИТЬ СписанияНДСНаРасходы 
	|ИЗ
	|	Задания КАК Задания
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.СписаниеНДСНаРасходы КАК СписаниеНДСНаРасходы
	|	ПО
	|		СписаниеНДСНаРасходы.Дата < &КонецПериода
	|		И Задания.Организация = СписаниеНДСНаРасходы.Организация
	|		И Задания.СчетФактура = СписаниеНДСНаРасходы.СчетФактура
	|		И СписаниеНДСНаРасходы.Проведен
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;

	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьБлокировкиВычетаНДС(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	БлокировкаВычетаНДС.Организация КАК Организация,
	|	БлокировкаВычетаНДС.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ БлокировкаВычетаНДС
	|ИЗ
	|	РегистрСведений.СостоянияБлокировкиВычетаНДСПоСчетамФактурам.СрезПоследних(
	|		&КонецПериода,
	|		(Организация, СчетФактура) В
	|			(ВЫБРАТЬ
	|				Задания.Организация,
	|				Задания.СчетФактура
	|			ИЗ
	|				Задания КАК Задания)
	|			) КАК БлокировкаВычетаНДС
	|ГДЕ
	|	БлокировкаВычетаНДС.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияБлокировкиВычетаНДС.Установлена)
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация,
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      Новый Граница(ПараметрыРасчета.КонецПериода));
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьНДСПредъявленныйОстатокНаНачало(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДД.Организация             КАК Организация,
	|	ДД.СчетФактура             КАК СчетФактура,
	|	ДД.Поставщик               КАК Поставщик,
	|	ДД.ВидЦенности             КАК ВидЦенности,
	|	ДД.СтавкаНДС               КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС      КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	ДД.СуммаБезНДСОстаток      КАК СуммаБезНДС,
	|	ДД.НДСОстаток              КАК НДС,
	|	ДД.НДСУпрОстаток           КАК НДСУпр
	|ПОМЕСТИТЬ НДСПредъявленныйОстатокНаНачало 
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный.Остатки(
	|		&НачалоПериода, 
	|		(Организация, СчетФактура) В (
	|			ВЫБРАТЬ
	|				Задания.Организация,
	|				Задания.СчетФактура
	|			ИЗ
	|				Задания)) КАК ДД
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьНДСПредъявленныйОнлайнДвижения(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДД.МоментВремени           КАК МоментВремени,
	|	ДД.Период                  КАК Период,
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Организация             КАК Организация,
	|	ДД.СчетФактура             КАК СчетФактура,
	|	ДД.Поставщик               КАК Поставщик,
	|	ДД.ВидЦенности             КАК ВидЦенности,
	|	ДД.СтавкаНДС               КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС  КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.СуммаБезНДС
	|		ИНАЧЕ -ДД.СуммаБезНДС
	|	КОНЕЦ                      КАК СуммаБезНДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДС
	|		ИНАЧЕ -ДД.НДС
	|	КОНЕЦ                      КАК НДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДСУпр
	|		ИНАЧЕ -ДД.НДСУпр
	|	КОНЕЦ                      КАК НДСУпр
	|ПОМЕСТИТЬ НДСПредъявленныйОнлайнДвижения
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный КАК ДД
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		ДД.Организация = Задания.Организация
	|		И ДД.СчетФактура = Задания.СчетФактура
	|ГДЕ
	|	ДД.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И НЕ ДД.РегламентнаяОперация
	|	И ДД.Активность
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьТекущиеРегистраторыНДСПредъявленный(ПараметрыРасчета) 
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор КАК Регистратор,
	|	НДСПредъявленный.Организация КАК Организация,
	|	НДСПредъявленный.Период КАК Период
	|ПОМЕСТИТЬ ТекущиеРегистраторыНДСПредъявленный
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО (Задания.Организация = НДСПредъявленный.Организация)
	|			И (Задания.СчетФактура = НДСПредъявленный.СчетФактура)
	|ГДЕ
	|	НДСПредъявленный.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И НДСПредъявленный.РегламентнаяОперация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйИзменениеВидаДеятельности(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"
	// Обработаем смены вида деятельнсти партий с (на) ПродажаОблагаетсяНДС 
	|ВЫБРАТЬ
	|	2                                      КАК Приоритет,
	|	Партии.МоментВремени                   КАК МоментВремени,
	|	Партии.Период                          КАК Период,
	|	Партии.Регистратор                     КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Партии.Организация                     КАК Организация,
	|	Партии.СчетФактура                     КАК СчетФактура,
	|	Партии.Контрагент                      КАК Поставщик,
	|	Партии.ВидЦенности                     КАК ВидЦенности,
	|	Партии.СтавкаНДС                       КАК СтавкаНДС,
	|	Партии.НалогообложениеФинПартии        КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО) КАК ИсправленныйСчетФактура,
	|	НЕОПРЕДЕЛЕНО                           КАК РеализацияЭкспорт,
	|	Партии.СуммаБезНДС                     КАК СуммаБезНДС,
	|	Партии.НДС                             КАК НДС,
	|	Партии.НДСУпр                          КАК НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС) ТОГДА
	|			ВЫБОР 
	|				КОГДА Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВключениеНДСВСтоимость)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы)
	|			КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ                                  КАК Событие,
	|	Партии.НалогообложениеПартии           КАК КорВидДеятельностиНДС,
	|	Партии.ПодразделениеСписанияНДС           КАК Подразделение,
	|	Партии.НаправлениеДеятельностиСписанияНДС КАК НаправлениеДеятельности,
	|	Партии.СтатьяСписанияНДС                  КАК СтатьяРасходов,
	|	Партии.АналитикаСписанияНДС               КАК АналитикаРасходов,
	|	""""                                   КАК ИдентификаторСтроки,
	|	ИСТИНА                                 КАК РегламентнаяОперация
	|ПОМЕСТИТЬ НДСПредъявленныйИзменениеВидаДеятельности
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И НЕ (Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|			И Партии.ДатаПоступления >= &ДатаНачалаДействия150ФЗ)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИсключениеНДСИзСтоимости)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ,
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО                      КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                      КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                      КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                      КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|	
	|ГДЕ
	|	Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И НЕ (Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|			И Партии.ДатаПоступления >= &ДатаНачалаДействия150ФЗ)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Обработаем смены вида деятельнсти партий с (на) ОпределяетсяРаспределением, ПоФактическомуИспользованию, ВводОСВЭксплуатацию 
	|ВЫБРАТЬ
	|	2                                      КАК Приоритет,
	|	Партии.МоментВремени                   КАК МоментВремени,
	|	Партии.Период                          КАК Период,
	|	Партии.Регистратор                     КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) КАК ВидДвижения,
	|	Партии.Организация                     КАК Организация,
	|	Партии.СчетФактура                     КАК СчетФактура,
	|	Партии.Контрагент                      КАК Поставщик,
	|	Партии.ВидЦенности                     КАК ВидЦенности,
	|	Партии.СтавкаНДС                       КАК СтавкаНДС,
	|	Партии.НалогообложениеФинПартии        КАК ВидДеятельностиНДС,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО) КАК ИсправленныйСчетФактура,
	|	НЕОПРЕДЕЛЕНО                           КАК РеализацияЭкспорт,
	|	Партии.СуммаБезНДС                     КАК СуммаБезНДС,
	|	Партии.НДС                             КАК НДС,
	|	Партии.НДСУпр                          КАК НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС) ТОГДА
	|			ВЫБОР 
	|				КОГДА Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВключениеНДСВСтоимость)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы)
	|			КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ                                  КАК Событие,
	|	Партии.НалогообложениеПартии           КАК КорВидДеятельностиНДС,
	|	Партии.ПодразделениеСписанияНДС           КАК Подразделение,
	|	Партии.НаправлениеДеятельностиСписанияНДС КАК НаправлениеДеятельности,
	|	Партии.СтатьяСписанияНДС                  КАК СтатьяРасходов,
	|	Партии.АналитикаСписанияНДС               КАК АналитикаРасходов,
	|	""""                                      КАК ИдентификаторСтроки,
	|	ИСТИНА                                    КАК РегламентнаяОперация
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИсключениеНДСИзСтоимости)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ,
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО                           КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                           КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                           КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеПартии В ( 
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ОпределяетсяРаспределением),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ВводОСВЭксплуатацию))
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Обработаем смены вида деятельнсти партий с (на) ПродажаНаЭкспорт, ЭкспортСырьевыхТоваровУслуг 
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеФинПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО
	|				И Партии.НалогообложениеПартии В (
	|					ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг),
	|					ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)) 
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.РеализацияПоСтавке0)
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС) ТОГДА
	|			ВЫБОР 
	|				КОГДА Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВключениеНДСВСтоимость)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы)
	|			КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ,
	|	Партии.НалогообложениеПартии,
	|	Партии.ПодразделениеСписанияНДС            КАК Подразделение,
	|	Партии.НаправлениеДеятельностиСписанияНДС  КАК НаправлениеДеятельности,
	|	Партии.СтатьяСписанияНДС                   КАК СтатьяРасходов,
	|	Партии.АналитикаСписанияНДС                КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг))
	|	И (Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии 
	|			ИЛИ Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	Партии.ДокументРеализации,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР 
	|		КОГДА Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.РеализацияПоСтавке0)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ,
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО                           КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                           КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                           КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеПартии В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг))
	|	И (Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|			ИЛИ Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Обработаем смены вида деятельнсти партий с (на) ЭкспортНесырьевыхТоваров
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеФинПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР
	|		КОГДА Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС) ТОГДА
	|			ВЫБОР 
	|				КОГДА Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|					ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВключениеНДСВСтоимость)
	|				ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы)
	|			КОНЕЦ
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ                                  КАК Событие,
	|	Партии.НалогообложениеПартии,
	|	Партии.ПодразделениеСписанияНДС            КАК Подразделение,
	|	Партии.НаправлениеДеятельностиСписанияНДС  КАК НаправлениеДеятельности,
	|	Партии.СтатьяСписанияНДС                   КАК СтатьяРасходов,
	|	Партии.АналитикаСписанияНДС                КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И НЕ (Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|			И Партии.ДатаПоступления >= &ДатаНачалаДействия150ФЗ)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеФинПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.РеализацияПоСтавке0),
	|	Партии.НалогообложениеПартии,
	|	НЕОПРЕДЕЛЕНО                           КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                           КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                           КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|
	|ГДЕ
	|	Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО
	|	И Партии.ДатаПоступления < &ДатаНачалаДействия150ФЗ
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	ВЫБОР 
	|		КОГДА Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО И Партии.ДатаПоступления < &ДатаНачалаДействия150ФЗ
	|			ТОГДА Партии.ДокументРеализации
	|		ИНАЧЕ НЕОПРЕДЕЛЕНО
	|	КОНЕЦ,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ВЫБОР 
	|		КОГДА Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО И Партии.ДатаПоступления < &ДатаНачалаДействия150ФЗ
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.РеализацияПоСтавке0)
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИзменениеВидаДеятельностиНДС)
	|	КОНЕЦ,
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО                           КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                           КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                           КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.НалогообложениеФинПартии <> Партии.НалогообложениеПартии
	|	И НЕ (Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|			И Партии.ДатаПоступления >= &ДатаНачалаДействия150ФЗ)
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	Партии.ДокументРеализации,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.РеализацияПоСтавке0),
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО                           КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                           КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО                           КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|		ПО Партии.Организация = ИсправительныеCФ.Организация
	|			И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ СписанияНДСНаРасходы
	|		ПО Партии.Организация = СписанияНДСНаРасходы.Организация
	|			И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.ДокументРеализации <> НЕОПРЕДЕЛЕНО
	|	И Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|	И Партии.ДатаПоступления < &ДатаНачалаДействия150ФЗ
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL
	|
	// Обработаем смены вида деятельнсти партий, по которым НДС был списан документом СписаниеНДСНаРасходы
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеФинПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	-Партии.СуммаБезНДС,
	|	-Партии.НДС,
	|	-Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы),
	|	НЕОПРЕДЕЛЕНО,
	|	СписанияНДСНаРасходы.Подразделение     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	СписанияНДСНаРасходы.СтатьяРасходов    КАК СтатьяРасходов,
	|	СписанияНДСНаРасходы.АналитикаРасходов КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		СписанияНДСНаРасходы
	|	ПО 
	|		Партии.Организация = СписанияНДСНаРасходы.Организация
	|		И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|
	|ГДЕ
	|	Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеФинПартии
	|	И Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	3,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеФинПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВключениеНДСВСтоимость),
	|	НЕОПРЕДЕЛЕНО,
	|	НЕОПРЕДЕЛЕНО     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО     КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО     КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО     КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		СписанияНДСНаРасходы
	|	ПО 
	|		Партии.Организация = СписанияНДСНаРасходы.Организация
	|		И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеФинПартии
	|	И Партии.СтатьяСписанияНДС = ЗНАЧЕНИЕ(ПланВидовХарактеристик.СтатьиРасходов.ПустаяСсылка)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ИсключениеНДСИзСтоимости),
	|	Партии.НалогообложениеФинПартии,
	|	НЕОПРЕДЕЛЕНО     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО     КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО     КАК СтатьяРасходов,
	|	НЕОПРЕДЕЛЕНО     КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		СписанияНДСНаРасходы
	|	ПО 
	|		Партии.Организация = СписанияНДСНаРасходы.Организация
	|		И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеФинПартии
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	2,
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход),
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.НалогообложениеПартии,
	|	ЕСТЬNULL(ИсправительныеCФ.ИсправительныйСчетФактура, НЕОПРЕДЕЛЕНО),
	|	НЕОПРЕДЕЛЕНО,
	|	Партии.СуммаБезНДС,
	|	Партии.НДС,
	|	Партии.НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.СписаниеНДСНаРасходы),
	|	НЕОПРЕДЕЛЕНО,
	|	СписанияНДСНаРасходы.Подразделение     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                           КАК НаправлениеДеятельности,
	|	СписанияНДСНаРасходы.СтатьяРасходов    КАК СтатьяРасходов,
	|	СписанияНДСНаРасходы.АналитикаРасходов КАК АналитикаРасходов,
	|	"""",
	|	ИСТИНА
	|ИЗ
	|	Партии КАК Партии
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		ИсправительныеСчетаФактуры КАК ИсправительныеCФ
	|	ПО 
	|		Партии.Организация = ИсправительныеCФ.Организация
	|		И Партии.СчетФактура = ИсправительныеCФ.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
	|		СписанияНДСНаРасходы
	|	ПО 
	|		Партии.Организация = СписанияНДСНаРасходы.Организация
	|		И Партии.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|ГДЕ
	|	Партии.НалогообложениеФинПартии = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС)
	|	И Партии.НалогообложениеПартии <> Партии.НалогообложениеФинПартии
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",           ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",            ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",       ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ДатаНачалаДействия150ФЗ", ДатаНачалаДействия150ФЗ());
	
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйПоИСФ(ПараметрыРасчета)
	 
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ИсправительныеСчетаФактуры.МоментВремени   КАК МоментВремени,
	|	ИсправительныеСчетаФактуры.Ссылка          КАК Регистратор,
	|	ИсправительныеСчетаФактуры.ДатаПолучения   КАК Период,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура КАК ИсправительныйСчетФактура,
	|	НДСПредъявленный.ВидДвижения               КАК ВидДвижения,
	|	НДСПредъявленный.Организация               КАК Организация,
	|	НДСПредъявленный.СчетФактура               КАК СчетФактура,
	|	НДСПредъявленный.Поставщик                 КАК Поставщик,
	|	НДСПредъявленный.ВидЦенности               КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                 КАК СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС        КАК ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура   КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт         КАК РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС               КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                       КАК НДС,
	|	НДСПредъявленный.НДСУпр                    КАК НДСУпр,
	|	НДСПредъявленный.Событие                   КАК Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС     КАК КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение             КАК Подразделение,
	|	НДСПредъявленный.ИдентификаторСтроки       КАК ИдентификаторСтроки,
	|	НДСПредъявленный.НаправлениеДеятельности   КАК НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов            КАК СтатьяРасходов,
	|	НДСПредъявленный.АналитикаРасходов         КАК АналитикаРасходов
	|ПОМЕСТИТЬ НДСПредъявленныйИсправительныеСчетаФактуры
	|ИЗ
	|	ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|	ПО
	|		НДСПредъявленный.Организация = ИсправительныеСчетаФактуры.Организация
	|		И НДСПредъявленный.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И НДСПредъявленный.Период < &НачалоПериода
	|		И НДСПредъявленный.ИсправленныйСчетФактура <> ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|		И НДСПредъявленный.Активность
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ИсправительныеСчетаФактуры.МоментВремени КАК МоментВремени,
	|	ИсправительныеСчетаФактуры.Ссылка КАК Регистратор,
	|	ИсправительныеСчетаФактуры.ДатаПолучения КАК Период,
	|	ИсправительныеСчетаФактуры.ИсправительныйСчетФактура,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,
	|	НДСПредъявленный.АналитикаРасходов
	|
	|ИЗ
	|	ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|	ПО
	|		НДСПредъявленный.Организация = ИсправительныеСчетаФактуры.Организация
	|		И НДСПредъявленный.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И НДСПредъявленный.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|		И НДСПредъявленный.ИсправленныйСчетФактура <> ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|		И НЕ НДСПредъявленный.РегламентнаяОперация
	|		И НДСПредъявленный.Активность
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Событие
	|;
	|
	|ВЫБРАТЬ
	|	1                                          КАК Приоритет,
	|	НДСПредъявленный.МоментВремени             КАК МоментВремени,
	|	НДСПредъявленный.Регистратор               КАК Регистратор,
	|	НДСПредъявленный.Период                    КАК Период,
	|	НДСПредъявленный.ВидДвижения               КАК ВидДвижения,
	|	НДСПредъявленный.Организация               КАК Организация,
	|	НДСПредъявленный.СчетФактура               КАК СчетФактура,
	|	НДСПредъявленный.Поставщик                 КАК Поставщик,
	|	НДСПредъявленный.ВидЦенности               КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                 КАК СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС        КАК ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура   КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт         КАК РеализацияЭкспорт,
	|	СУММА(НДСПредъявленный.СуммаБезНДС)        КАК СуммаБезНДС,
	|	СУММА(НДСПредъявленный.НДС)                КАК НДС,
	|	СУММА(НДСПредъявленный.НДСУпр)             КАК НДСУпр,
	|	НДСПредъявленный.Событие                   КАК Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС     КАК КорВидДеятельностиНДС,
	|	ИСТИНА                                     КАК РегламентнаяОперация,
	|	НДСПредъявленный.Подразделение             КАК Подразделение,
	|	НДСПредъявленный.ИдентификаторСтроки       КАК ИдентификаторСтроки,
	|	НДСПредъявленный.НаправлениеДеятельности   КАК НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов            КАК СтатьяРасходов,
	|	НДСПредъявленный.АналитикаРасходов         КАК АналитикаРасходов
	|ПОМЕСТИТЬ НДСПредъявленныйПоИСФ
	|ИЗ
	|	(ВЫБРАТЬ
	|		НДСПредъявленный.МоментВремени,
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.Период,
	|		НДСПредъявленный.ВидДвижения,
	|		НДСПредъявленный.Организация,
	|		НДСПредъявленный.СчетФактура,
	|		НДСПредъявленный.Поставщик,
	|		НДСПредъявленный.ВидЦенности,
	|		НДСПредъявленный.СтавкаНДС,
	|		НДСПредъявленный.ВидДеятельностиНДС,
	|		НДСПредъявленный.ИсправленныйСчетФактура,
	|		НДСПредъявленный.РеализацияЭкспорт,
	|		- НДСПредъявленный.СуммаБезНДС КАК СуммаБезНДС,
	|		- НДСПредъявленный.НДС КАК НДС,
	|		- НДСПредъявленный.НДСУпр КАК НДСУпр,
	|		НДСПредъявленный.Событие,
	|		НДСПредъявленный.КорВидДеятельностиНДС,
	|		НДСПредъявленный.ИдентификаторСтроки,
	|		НДСПредъявленный.Подразделение,
	|		НДСПредъявленный.НаправлениеДеятельности,
	|		НДСПредъявленный.СтатьяРасходов,
	|		НДСПредъявленный.АналитикаРасходов
	|	ИЗ
	|		НДСПредъявленныйИсправительныеСчетаФактуры КАК НДСПредъявленный
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|		
	|	ВЫБРАТЬ
	|		НДСПредъявленный.МоментВремени,
	|		НДСПредъявленный.Регистратор,
	|		НДСПредъявленный.Период,
	|		НДСПредъявленный.ВидДвижения,
	|		НДСПредъявленный.Организация,
	|		НДСПредъявленный.СчетФактура,
	|		НДСПредъявленный.Поставщик,
	|		НДСПредъявленный.ВидЦенности,
	|		НДСПредъявленный.СтавкаНДС,
	|		НДСПредъявленный.ВидДеятельностиНДС,
	|		НДСПредъявленный.ИсправительныйСчетФактура,
	|		НДСПредъявленный.РеализацияЭкспорт,
	|		НДСПредъявленный.СуммаБезНДС КАК СуммаБезНДС,
	|		НДСПредъявленный.НДС КАК НДС,
	|		НДСПредъявленный.НДСУпр КАК НДСУпр,
	|		НДСПредъявленный.Событие,
	|		НДСПредъявленный.КорВидДеятельностиНДС,
	|		НДСПредъявленный.ИдентификаторСтроки,
	|		НДСПредъявленный.Подразделение,
	|		НДСПредъявленный.НаправлениеДеятельности,
	|		НДСПредъявленный.СтатьяРасходов,
	|		НДСПредъявленный.АналитикаРасходов
	|	ИЗ
	|		НДСПредъявленныйИсправительныеСчетаФактуры КАК НДСПредъявленный
	|	ГДЕ
	|		НЕ НДСПредъявленный.Событие В (
	|				ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету),
	|				ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0),
	|				ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0),
	|				ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВосстановлениеНДСПоКСФ)
	|				)
	|	) КАК НДСПредъявленный
	|
	|СГРУППИРОВАТЬ ПО
	|	НДСПредъявленный.МоментВремени,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,
	|	НДСПредъявленный.АналитикаРасходов
	|
	|ИМЕЮЩИЕ 
	|	СУММА(НДСПредъявленный.НДС) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ НДСПредъявленныйИсправительныеСчетаФактуры
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода", ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйВосстановлениеПодВидДеятельности(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	0                          КАК Приоритет,
	|	ДД.МоментВремени           КАК МоментВремени,
	|	ДД.Период                  КАК Период,
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Организация             КАК Организация,
	|	ДД.СчетФактура             КАК СчетФактура,
	|	ДД.Поставщик               КАК Поставщик,
	|	ДД.ВидЦенности             КАК ВидЦенности,
	|	ДД.СтавкаНДС               КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС      КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	ДД.СуммаБезНДС             КАК СуммаБезНДС,
	|	ДД.НДС                     КАК НДС,
	|	ДД.НДСУпр                  КАК НДСУпр
	|ПОМЕСТИТЬ НДСПредъявленныйДвиженияЗаПериод
	|ИЗ
	|	НДСПредъявленныйОнлайнДвижения КАК ДД
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	ДД.Приоритет               КАК Приоритет,
	|	ДД.МоментВремени           КАК МоментВремени,
	|	ДД.Период                  КАК Период,
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Организация             КАК Организация,
	|	ДД.СчетФактура             КАК СчетФактура,
	|	ДД.Поставщик               КАК Поставщик,
	|	ДД.ВидЦенности             КАК ВидЦенности,
	|	ДД.СтавкаНДС               КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС      КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.СуммаБезНДС
	|		ИНАЧЕ -ДД.СуммаБезНДС
	|	КОНЕЦ                      КАК СуммаБезНДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДС
	|		ИНАЧЕ -ДД.НДС
	|	КОНЕЦ                      КАК НДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДСУпр
	|		ИНАЧЕ -ДД.НДСУпр
	|	КОНЕЦ                      КАК НДСУпр
	|ИЗ
	|	НДСПредъявленныйИзменениеВидаДеятельности  КАК ДД
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	ДД.Приоритет               КАК Приоритет,
	|	ДД.МоментВремени           КАК МоментВремени,
	|	ДД.Период                  КАК Период,
	|	ДД.Регистратор             КАК Регистратор,
	|	ДД.Организация             КАК Организация,
	|	ДД.СчетФактура             КАК СчетФактура,
	|	ДД.Поставщик               КАК Поставщик,
	|	ДД.ВидЦенности             КАК ВидЦенности,
	|	ДД.СтавкаНДС               КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС      КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.СуммаБезНДС
	|		ИНАЧЕ -ДД.СуммаБезНДС
	|	КОНЕЦ                      КАК СуммаБезНДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДС
	|		ИНАЧЕ -ДД.НДС
	|	КОНЕЦ                      КАК НДС,
	|	ВЫБОР
	|		КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|			ТОГДА ДД.НДСУпр
	|		ИНАЧЕ -ДД.НДСУпр
	|	КОНЕЦ                      КАК НДСУпр
	|ИЗ
	|	НДСПредъявленныйПоИСФ  КАК ДД
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура
	|;
	|
	|ВЫБРАТЬ
	|	1                                       КАК Приоритет,
	|	ДД.Период                               КАК Период,
	|	ДД.Регистратор                          КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)  КАК ВидДвижения,
	|	ДД.Организация                          КАК Организация,
	|	ДД.СчетФактура                          КАК СчетФактура,
	|	ДД.Поставщик                            КАК Поставщик,
	|	ДД.ВидЦенности                          КАК ВидЦенности,
	|	ДД.СтавкаНДС                            КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                   КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура              КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт                    КАК РеализацияЭкспорт,
	|	(ДД.СуммаБезНДС) 
	|		- ВЫБОР КОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.СуммаБезНДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.СуммаБезНДС, 0)) > 0
	|			ТОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.СуммаБезНДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.СуммаБезНДС, 0))
	|				ИНАЧЕ 0
	|			КОНЕЦ                           КАК СуммаБезНДС,
	|	(ДД.НДС) 
	|		- ВЫБОР КОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДС, 0)) > 0
	|			ТОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДС, 0))
	|				ИНАЧЕ 0
	|			КОНЕЦ                            КАК НДС,
	|	(ДД.НДСУпр) 
	|		- ВЫБОР КОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДСУпр, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДСУпр, 0)) > 0
	|			ТОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДСУпр, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДСУпр, 0))
	|				ИНАЧЕ 0
	|			КОНЕЦ                            КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВосстановлениеНДСПодВидДеятельности) КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)       КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                     КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                     КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                     КАК АналитикаРасходов,
	|	""""                                     КАК ИдентификаторСтроки,
	|	ИСТИНА                                   КАК РегламентнаяОперация
	|	
	|ПОМЕСТИТЬ НДСПредъявленныйВосстановлениеПодВидДеятельности
	|ИЗ
	|	НДСПредъявленныйИзменениеВидаДеятельности КАК ДД
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйОстатокНаНачало КАК НДСПредъявленныйОстатокНаНачало
	|	ПО
	|		ДД.Организация   = НДСПредъявленныйОстатокНаНачало.Организация
	|		И ДД.СчетФактура = НДСПредъявленныйОстатокНаНачало.СчетФактура
	|		И ДД.Поставщик   = НДСПредъявленныйОстатокНаНачало.Поставщик
	|		И ДД.ВидЦенности = НДСПредъявленныйОстатокНаНачало.ВидЦенности
	|		И ДД.СтавкаНДС = НДСПредъявленныйОстатокНаНачало.СтавкаНДС
	|		И ДД.ВидДеятельностиНДС = НДСПредъявленныйОстатокНаНачало.ВидДеятельностиНДС
	|		И ДД.ИсправленныйСчетФактура = НДСПредъявленныйОстатокНаНачало.ИсправленныйСчетФактура
	|		И ДД.РеализацияЭкспорт = НДСПредъявленныйОстатокНаНачало.РеализацияЭкспорт
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйДвиженияЗаПериод КАК НДСПредъявленныйДвиженияЗаПериод
	|	ПО
	|		ДД.Организация   = НДСПредъявленныйДвиженияЗаПериод.Организация
	|		И ДД.СчетФактура = НДСПредъявленныйДвиженияЗаПериод.СчетФактура
	|		И ДД.Поставщик   = НДСПредъявленныйДвиженияЗаПериод.Поставщик
	|		И ДД.ВидЦенности = НДСПредъявленныйДвиженияЗаПериод.ВидЦенности
	|		И ДД.СтавкаНДС = НДСПредъявленныйДвиженияЗаПериод.СтавкаНДС
	|		И ДД.ВидДеятельностиНДС = НДСПредъявленныйДвиженияЗаПериод.ВидДеятельностиНДС
	|		И ДД.ИсправленныйСчетФактура = НДСПредъявленныйДвиженияЗаПериод.ИсправленныйСчетФактура
	|		И ДД.РеализацияЭкспорт = НДСПредъявленныйДвиженияЗаПериод.РеализацияЭкспорт
	|		И (НДСПредъявленныйДвиженияЗаПериод.Приоритет = 0 // Онлайн движения
	|			ИЛИ НДСПредъявленныйДвиженияЗаПериод.НДС > 0  // Приход
	|			ИЛИ ДД.МоментВремени > НДСПредъявленныйДвиженияЗаПериод.МоментВремени // Более ранее движения 
	|			ИЛИ (ДД.МоментВремени = НДСПредъявленныйДвиженияЗаПериод.МоментВремени 
	|					И НДСПредъявленныйДвиженияЗаПериод.Приоритет < ДД.Приоритет))
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СписанияНДСНаРасходы КАК СписанияНДСНаРасходы
	|	ПО
	|		ДД.Организация = СписанияНДСНаРасходы.Организация
	|		И ДД.СчетФактура = СписанияНДСНаРасходы.СчетФактура
	|	
	|ГДЕ
	|	ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) 
	|	И СписанияНДСНаРасходы.СчетФактура ЕСТЬ NULL 
	|	
	|СГРУППИРОВАТЬ ПО
	|	ДД.Период,
	|	ДД.Регистратор,
	|	ДД.Организация,
	|	ДД.СчетФактура,
	|	ДД.Поставщик,
	|	ДД.ВидЦенности,
	|	ДД.СтавкаНДС,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.КорВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт,
	|	ДД.СуммаБезНДС,
	|	ДД.НДС,
	|	ДД.НДСУпр
	|
	|ИМЕЮЩИЕ
	|	((ДД.НДС) 
	|		- ВЫБОР КОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДС, 0)) > 0
	|			ТОГДА СУММА(ЕСТЬNULL(НДСПредъявленныйОстатокНаНачало.НДС, 0) + ЕСТЬNULL(НДСПредъявленныйДвиженияЗаПериод.НДС, 0))
	|				ИНАЧЕ 0
	|			КОНЕЦ) > 0
	|
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПолучитьОстаткиНДСПредъявленныйНаКонецПериода(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	СУММА(НДСПредъявленный.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(НДСПредъявленный.НДС) КАК НДС,
	|	СУММА(НДСПредъявленный.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ НДСПредъявленныйОстаткиНаКонецПериода 
	|ИЗ
	|	(ВЫБРАТЬ
	|		ДД.Организация             КАК Организация,
	|		ДД.СчетФактура             КАК СчетФактура,
	|		ДД.Поставщик               КАК Поставщик,
	|		ДД.ВидЦенности             КАК ВидЦенности,
	|		ДД.СтавкаНДС               КАК СтавкаНДС,
	|		ДД.ВидДеятельностиНДС  КАК ВидДеятельностиНДС,
	|		ДД.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|		ДД.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|		ДД.СуммаБезНДС             КАК СуммаБезНДС,
	|		ДД.НДС                     КАК НДС,
	|		ДД.НДСУпр                  КАК НДСУпр
	|	ИЗ
	|		НДСПредъявленныйОстатокНаНачало КАК ДД
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СчетФактура,
	|		ДД.Поставщик,
	|		ДД.ВидЦенности,
	|		ДД.СтавкаНДС,
	|		ДД.ВидДеятельностиНДС,
	|		ДД.ИсправленныйСчетФактура,
	|		ДД.РеализацияЭкспорт,
	|		ДД.СуммаБезНДС,
	|		ДД.НДС,
	|		ДД.НДСУпр
	|	ИЗ
	|		НДСПредъявленныйОнлайнДвижения КАК ДД
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СчетФактура,
	|		ДД.Поставщик,
	|		ДД.ВидЦенности,
	|		ДД.СтавкаНДС,
	|		ДД.ВидДеятельностиНДС,
	|		ДД.ИсправленныйСчетФактура,
	|		ДД.РеализацияЭкспорт,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.СуммаБезНДС
	|			ИНАЧЕ -ДД.СуммаБезНДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДС
	|			ИНАЧЕ -ДД.НДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДСУпр
	|			ИНАЧЕ -ДД.НДСУпр
	|		КОНЕЦ
	|	ИЗ
	|		НДСПредъявленныйПоИСФ КАК ДД
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СчетФактура,
	|		ДД.Поставщик,
	|		ДД.ВидЦенности,
	|		ДД.СтавкаНДС,
	|		ДД.ВидДеятельностиНДС,
	|		ДД.ИсправленныйСчетФактура,
	|		ДД.РеализацияЭкспорт,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.СуммаБезНДС
	|			ИНАЧЕ -ДД.СуммаБезНДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДС
	|			ИНАЧЕ -ДД.НДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДСУпр
	|			ИНАЧЕ -ДД.НДСУпр
	|		КОНЕЦ
	|	ИЗ
	|		НДСПредъявленныйИзменениеВидаДеятельности КАК ДД
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		ДД.Организация,
	|		ДД.СчетФактура,
	|		ДД.Поставщик,
	|		ДД.ВидЦенности,
	|		ДД.СтавкаНДС,
	|		ДД.ВидДеятельностиНДС,
	|		ДД.ИсправленныйСчетФактура,
	|		ДД.РеализацияЭкспорт,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.СуммаБезНДС
	|			ИНАЧЕ -ДД.СуммаБезНДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДС
	|			ИНАЧЕ -ДД.НДС
	|		КОНЕЦ,
	|		ВЫБОР
	|			КОГДА ДД.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	|				ТОГДА ДД.НДСУпр
	|			ИНАЧЕ -ДД.НДСУпр
	|		КОНЕЦ
	|	ИЗ
	|		НДСПредъявленныйВосстановлениеПодВидДеятельности КАК ДД
	|) КАК НДСПредъявленный
	|
	|СГРУППИРОВАТЬ ПО
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт
	|
	|ИМЕЮЩИЕ
	|	СУММА(НДСПредъявленный.СуммаБезНДС) <> 0 
	|		ИЛИ СУММА(НДСПредъявленный.НДС) <> 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура,
	|	ИсправленныйСчетФактура
	|";
	
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйПринятиеКВычету(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр
	|ПОМЕСТИТЬ НДСПредъявленныйОстатки
	|ИЗ
	|	НДСПредъявленныйОстаткиНаКонецПериода КАК НДСПредъявленный
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Документ.КорректировкаПриобретения КАК КорректировкаПоСогласованиюСторон
	|	ПО
	|		НДСПредъявленный.СчетФактура = КорректировкаПоСогласованиюСторон.Ссылка
	|		И НДСПредъявленный.Организация = КорректировкаПоСогласованиюСторон.Организация
	|		И КорректировкаПоСогласованиюСторон.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Документ.СчетФактураПолученныйНалоговыйАгент КАК КорректировочныйСчетФактура
	|	ПО
	|		НДСПредъявленный.СчетФактура = КорректировочныйСчетФактура.Ссылка
	|		И НДСПредъявленный.Организация = КорректировочныйСчетФактура.Организация
	|		И КорректировочныйСчетФактура.Корректировочный
	|ГДЕ
	|	ВЫБОР 
	|		КОГДА НЕ КорректировкаПоСогласованиюСторон.Ссылка ЕСТЬ NULL 
	|			ТОГДА НДСПредъявленный.НДС > 0
	|		КОГДА НЕ КорректировочныйСчетФактура.Ссылка ЕСТЬ NULL 
	|			ТОГДА НДСПредъявленный.НДС > 0
	|		ИНАЧЕ ИСТИНА
	|	КОНЕЦ
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НДСПредъявленный.Организация, 
	|	СчетФактура,
	|	Поставщик,
	|	ВидЦенности,
	|	СтавкаНДС,
	|	ВидДеятельностиНДС,
	|	ИсправленныйСчетФактура,
	|	РеализацияЭкспорт
	|;
	|
	|///////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	Партии.МоментВремени              КАК МоментВремени,
	|	Партии.Период                     КАК Период,
	|	Партии.Регистратор                КАК Регистратор,
	|	Партии.Организация                КАК Организация,
	|	Партии.СчетФактура                КАК СчетФактура,
	|	Партии.ДатаПоступления            КАК ДатаПоступления,
	|	Партии.Контрагент                 КАК Поставщик,
	|	Партии.ВидЦенности                КАК ВидЦенности,
	|	Партии.СтавкаНДС                  КАК СтавкаНДС,
	|	Партии.ВидДеятельностиНДС         КАК ВидДеятельностиНДС,
	|	СУММА(Партии.СуммаБезНДС)         КАК СуммаБезНДС,
	|	СУММА(Партии.НДС)                 КАК НДС,
	|	СУММА(Партии.НДСУпр)              КАК НДСУпр
	|ПОМЕСТИТЬ ПартииНаПродажаОблагаетсяНДС
	|ИЗ
	|	(ВЫБРАТЬ
	|		Партии.МоментВремени              КАК МоментВремени,
	|		Партии.Период                     КАК Период,
	|		Партии.Регистратор                КАК Регистратор,
	|		Партии.Организация                КАК Организация,
	|		Партии.СчетФактура                КАК СчетФактура,
	|		Партии.ДатаПоступления            КАК ДатаПоступления,
	|		Партии.Контрагент                 КАК Контрагент,
	|		Партии.ВидЦенности                КАК ВидЦенности,
	|		Партии.НалогообложениеПартии      КАК ВидДеятельностиНДС,
	|		Партии.СтавкаНДС                  КАК СтавкаНДС,
	|		Партии.СуммаБезНДС                КАК СуммаБезНДС,
	|		Партии.НДС                        КАК НДС,
	|		Партии.НДСУпр                     КАК НДСУпр
	|	ИЗ
	|		Партии КАК Партии
	|	ГДЕ
	|		Партии.НалогообложениеПартии В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|		И НЕ Партии.НалогообложениеФинПартии В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|		И (Партии.НДС > 0) 
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Партии.МоментВремени,
	|		Партии.Период,
	|		Партии.Регистратор,
	|		Партии.Организация,
	|		Партии.СчетФактура,
	|		Партии.ДатаПоступления,
	|		Партии.Контрагент,
	|		Партии.ВидЦенности,
	|		Партии.СтавкаНДС,
	|		Партии.НалогообложениеФинПартии,
	|		-Партии.СуммаБезНДС,
	|		-Партии.НДС,
	|		-Партии.НДСУпр
	|	ИЗ
	|		Партии КАК Партии
	|	ГДЕ
	|		Партии.НалогообложениеФинПартии В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|		И НЕ Партии.НалогообложениеПартии В (
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|				ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|		И (Партии.НДС < 0)
	|	) КАК Партии
	|	
	|СГРУППИРОВАТЬ ПО
	|	Партии.МоментВремени,
	|	Партии.Период,
	|	Партии.Регистратор,
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.ДатаПоступления,
	|	Партии.Контрагент,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.ВидДеятельностиНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура,
	|	Поставщик,
	|	ВидЦенности,
	|	СтавкаНДС,
	|	ВидДеятельностиНДС
	|;
	|
	|ВЫБРАТЬ
	|	Партии.Организация                КАК Организация,
	|	Партии.СчетФактура                КАК СчетФактура,
	|	Партии.ДатаПоступления            КАК ДатаПоступления,
	|	Партии.Поставщик                  КАК Поставщик,
	|	Партии.ВидЦенности                КАК ВидЦенности,
	|	Партии.СтавкаНДС                  КАК СтавкаНДС,
	|	Партии.ВидДеятельностиНДС         КАК ВидДеятельностиНДС,
	|	СУММА(Партии.СуммаБезНДС)         КАК СуммаБезНДС,
	|	СУММА(Партии.НДС)                 КАК НДС,
	|	СУММА(Партии.НДСУпр)              КАК НДСУпр
	|ПОМЕСТИТЬ ПартииНаПродажаОблагаетсяНДСИтоги 
	|ИЗ
	|	ПартииНаПродажаОблагаетсяНДС КАК Партии
	|СГРУППИРОВАТЬ ПО
	|	Партии.Организация,
	|	Партии.СчетФактура,
	|	Партии.ДатаПоступления,
	|	Партии.Поставщик,
	|	Партии.ВидЦенности,
	|	Партии.СтавкаНДС,
	|	Партии.ВидДеятельностиНДС
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Организация, 
	|	СчетФактура,
	|	Поставщик,
	|	ВидЦенности,
	|	СтавкаНДС,
	|	ВидДеятельностиНДС
	|;
	|
	// "Обычные" Вычеты НДС по СФ и ИСФ, полученным в данном месяце, если не было изменений вида деятельности 
	|ВЫБРАТЬ
	|	2                                                                         КАК Приоритет,
	|	ВЫБОР 
	|		КОГДА ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) >= &НачалоПериода
	|			ТОГДА ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) 
	|		ИНАЧЕ
	|			&КонецПериода
	|	КОНЕЦ                                                                     КАК Период,
	|	ЕСТЬNULL(ИсправительныеСчетаФактуры.Ссылка, СчетаФактурыДокументы.Ссылка) КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
	|	ДД.Организация                                                   КАК Организация,
	|	ДД.СчетФактура                                                   КАК СчетФактура,
	|	ДД.Поставщик                                                     КАК Поставщик,
	|	ДД.ВидЦенности                                                   КАК ВидЦенности,
	|	ДД.СтавкаНДС                                                     КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                                            КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура                                       КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт                                             КАК РеализацияЭкспорт,
	|	ДД.СуммаБезНДС - ЕСТЬNULL(ДанныеПартий.СуммаБезНДС, 0)           КАК СуммаБезНДС,
	|	ДД.НДС - ЕСТЬNULL(ДанныеПартий.НДС, 0)                           КАК НДС,
	|	ДД.НДСУпр - ЕСТЬNULL(ДанныеПартий.НДСУпр, 0)                     КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)  КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)       КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                     КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                     КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                     КАК АналитикаРасходов,
	|	""""                                                             КАК ИдентификаторСтроки,
	|	ИСТИНА                                                           КАК РегламентнаяОперация
	|ПОМЕСТИТЬ НДСПредъявленныйПринятиеКВычету
	|ИЗ
	|	НДСПредъявленныйОстатки КАК ДД
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		ДД.Организация = СчетаФактурыДокументы.Организация
	|		И ДД.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = НЕОПРЕДЕЛЕНО
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ПО
	|		ДД.Организация = ИсправительныеСчетаФактуры.Организация
	|		И ДД.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ПартииНаПродажаОблагаетсяНДСИтоги КАК ДанныеПартий
	|	ПО
	|		ДД.Организация = ДанныеПартий.Организация
	|		И ДД.СчетФактура = ДанныеПартий.СчетФактура
	|		И ДД.Поставщик = ДанныеПартий.Поставщик
	|		И ДД.ВидЦенности = ДанныеПартий.ВидЦенности
	|		И ДД.СтавкаНДС = ДанныеПартий.СтавкаНДС
	|		И ДД.ВидДеятельностиНДС = ДанныеПартий.ВидДеятельностиНДС
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = ДД.Организация
	|		И ДанныеПервичныхДокументов.Документ = ДД.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		БлокировкаВычетаНДС КАК БлокировкаВычетаНДС
	|	ПО
	|		БлокировкаВычетаНДС.Организация = ДД.Организация
	|		И БлокировкаВычетаНДС.СчетФактура = ДД.СчетФактура
	|	
	|ГДЕ
	|	(НЕ СчетаФактурыДокументы.СчетФактура ЕСТЬ NULL
	|		ИЛИ НЕ ИсправительныеСчетаФактуры.СчетФактура ЕСТЬ NULL)
	|	И (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИЛИ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|				И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) >= &ДатаНачалаДействия150ФЗ))
	|	И ВЫБОР 
	|		КОГДА ДД.НДС < 0 ТОГДА
	|			ИСТИНА
	|		КОГДА ЕСТЬNULL(ДанныеПартий.НДС, 0) <> 0 ТОГДА
	|			(ДД.НДС - ЕСТЬNULL(ДанныеПартий.НДС, 0)) > 0
	|		ИНАЧЕ
	|			ИСТИНА
	|	КОНЕЦ
	|	И БлокировкаВычетаНДС.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Вычеты НДС, отложенного под экспорт по данным подтверждения ставки 0%. 
	|ВЫБРАТЬ
	|	2                                                                КАК Приоритет,
	|	ВЫБОР 
	|		КОГДА ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) < &НачалоПериода
	|					И НДССостояниеРеализации0.ДатаПодтверждения < &НачалоПериода 
	|			ТОГДА &КонецПериода
	|		КОГДА ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) > НДССостояниеРеализации0.ДатаПодтверждения 
	|			ТОГДА ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок)
	|		ИНАЧЕ НДССостояниеРеализации0.ДатаПодтверждения
	|	КОНЕЦ                                                            КАК Период,
	|	ВЫБОР 
	|		КОГДА ТИПЗНАЧЕНИЯ(ДД.РеализацияЭкспорт) В (ТИП(Документ.РеализацияТоваровУслуг), ТИП(Документ.АктВыполненныхРабот)) 
	|			ТОГДА ДД.РеализацияЭкспорт 
	|		ИНАЧЕ ЕСТЬNULL(ИсправительныеСчетаФактуры.Ссылка, СчетаФактурыДокументы.Ссылка)
	|	КОНЕЦ                                                            КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
	|	ДД.Организация                                                   КАК Организация,
	|	ДД.СчетФактура                                                   КАК СчетФактура,
	|	ДД.Поставщик                                                     КАК Поставщик,
	|	ДД.ВидЦенности                                                   КАК ВидЦенности,
	|	ДД.СтавкаНДС                                                     КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                                            КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура                                       КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт                                             КАК РеализацияЭкспорт,
	|	ДД.СуммаБезНДС                                                   КАК СуммаБезНДС,
	|	ДД.НДС                                                           КАК НДС,
	|	ДД.НДСУпр                                                        КАК НДСУпр,
	|	ВЫБОР 
	|		КОГДА НДССостояниеРеализации0.Состояние = ЗНАЧЕНИЕ(Перечисление.НДССостоянияРеализация0.ПодтвержденаРеализация0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0) 
	|		ИНАЧЕ ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0) 
	|	КОНЕЦ                                                            КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)       КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                     КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                     КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                     КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                     КАК АналитикаРасходов,
	|	""""                                                             КАК ИдентификаторСтроки,
	|	ИСТИНА                                                           КАК РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйОстатки КАК ДД
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		ДД.Организация = СчетаФактурыДокументы.Организация
	|		И ДД.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = НЕОПРЕДЕЛЕНО
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ПО
	|		ДД.Организация = ИсправительныеСчетаФактуры.Организация
	|		И ДД.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрСведений.НДССостояниеРеализации0 КАК НДССостояниеРеализации0
	|	ПО
	|		ДД.Организация = НДССостояниеРеализации0.Организация
	|		И ДД.РеализацияЭкспорт = НДССостояниеРеализации0.ДокументРеализации
	|		И НДССостояниеРеализации0.Состояние В (
	|				ЗНАЧЕНИЕ(Перечисление.НДССостоянияРеализация0.ПодтвержденаРеализация0),
	|				ЗНАЧЕНИЕ(Перечисление.НДССостоянияРеализация0.НеПодтвержденаРеализация0))
	|		И НДССостояниеРеализации0.ДатаПодтверждения <= &КонецПериода 
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|	ПО
	|		ДанныеПервичныхДокументов.Организация = ДД.Организация
	|		И ДанныеПервичныхДокументов.Документ = ДД.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		БлокировкаВычетаНДС КАК БлокировкаВычетаНДС
	|	ПО
	|		БлокировкаВычетаНДС.Организация = ДД.Организация
	|		И БлокировкаВычетаНДС.СчетФактура = ДД.СчетФактура
	|
	|ГДЕ
	|	(НЕ СчетаФактурыДокументы.СчетФактура ЕСТЬ NULL
	|		ИЛИ НЕ ИсправительныеСчетаФактуры.СчетФактура ЕСТЬ NULL)
	|	И (ДД.ВидДеятельностиНДС В (
	|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|			ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг))
	|		ИЛИ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|					И ЕСТЬNULL(ДанныеПервичныхДокументов.ДатаРегистратора, ДАТАВРЕМЯ(1,1,1)) < &ДатаНачалаДействия150ФЗ))
	|	И БлокировкаВычетаНДС.СчетФактура ЕСТЬ NULL
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Вычеты НДС по результатам изменения вида деятельности НДС на ПродажаОблагаетсяНДС
	|ВЫБРАТЬ
	|	4                                                                КАК Приоритет,
	|	ДанныеПартий.Период                                              КАК Период,
	|	ДанныеПартий.Регистратор                                         КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)                           КАК ВидДвижения,
	|	ДД.Организация                                                   КАК Организация,
	|	ДД.СчетФактура                                                   КАК СчетФактура,
	|	ДД.Поставщик                                                     КАК Поставщик,
	|	ДД.ВидЦенности                                                   КАК ВидЦенности,
	|	ДД.СтавкаНДС                                                     КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                                            КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура                                       КАК ИсправленныйСчетФактура,
	|	НЕОПРЕДЕЛЕНО                                                     КАК РеализацияЭкспорт,
	|	ВЫБОР 
	|		КОГДА МАКСИМУМ(ДанныеПартий.СуммаБезНДС) <= 
	|				(МАКСИМУМ(ДД.СуммаБезНДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.СуммаБезНДС, 0)))
	|			ТОГДА МАКСИМУМ(ДанныеПартий.СуммаБезНДС)
	|		ИНАЧЕ МАКСИМУМ(ДД.СуммаБезНДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.СуммаБезНДС, 0))
	|	КОНЕЦ                                                             КАК СуммаБезНДС,
	|	ВЫБОР 
	|		КОГДА МАКСИМУМ(ДанныеПартий.НДС) <= 
	|				(МАКСИМУМ(ДД.НДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДС, 0)))
	|			ТОГДА МАКСИМУМ(ДанныеПартий.НДС)
	|		ИНАЧЕ МАКСИМУМ(ДД.НДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДС, 0))
	|	КОНЕЦ                                                             КАК НДС,
	|	ВЫБОР 
	|		КОГДА МАКСИМУМ(ДанныеПартий.НДСУпр) <= 
	|				(МАКСИМУМ(ДД.НДСУпр) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДСУпр, 0)))
	|			ТОГДА МАКСИМУМ(ДанныеПартий.НДСУпр)
	|		ИНАЧЕ МАКСИМУМ(ДД.НДСУпр) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДСУпр, 0))
	|	КОНЕЦ                                                             КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)   КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)        КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                      КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                      КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                      КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                      КАК АналитикаРасходов,
	|	""""                                                              КАК ИдентификаторСтроки,
	|	ИСТИНА                                                            КАК РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйОстатки КАК ДД
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		ДД.Организация = СчетаФактурыДокументы.Организация
	|		И ДД.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = НЕОПРЕДЕЛЕНО
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ПО
	|		ДД.Организация = ИсправительныеСчетаФактуры.Организация
	|		И ДД.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ПартииНаПродажаОблагаетсяНДС КАК ДанныеПартий
	|	ПО
	|		ДД.Организация = ДанныеПартий.Организация
	|		И ДД.СчетФактура = ДанныеПартий.СчетФактура
	|		И ДД.Поставщик = ДанныеПартий.Поставщик
	|		И ДД.ВидЦенности = ДанныеПартий.ВидЦенности
	|		И ДД.СтавкаНДС = ДанныеПартий.СтавкаНДС
	|		И ДД.ВидДеятельностиНДС = ДанныеПартий.ВидДеятельностиНДС
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ПартииНаПродажаОблагаетсяНДС КАК ДанныеПартийУменьшение
	|	ПО
	|		ДанныеПартий.Организация = ДанныеПартийУменьшение.Организация
	|		И ДанныеПартий.СчетФактура = ДанныеПартийУменьшение.СчетФактура
	|		И ДанныеПартий.Поставщик = ДанныеПартийУменьшение.Поставщик
	|		И ДанныеПартий.ВидЦенности = ДанныеПартийУменьшение.ВидЦенности
	|		И ДанныеПартий.СтавкаНДС = ДанныеПартийУменьшение.СтавкаНДС
	|		И ДанныеПартий.ВидДеятельностиНДС = ДанныеПартийУменьшение.ВидДеятельностиНДС
	|		И ДанныеПартий.МоментВремени < ДанныеПартийУменьшение.МоментВремени
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеСчетовФактур
	|	ПО
	|		ДанныеСчетовФактур.Организация = ДД.Организация
	|		И ДанныеСчетовФактур.Документ = ДД.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		БлокировкаВычетаНДС КАК БлокировкаВычетаНДС
	|	ПО
	|		БлокировкаВычетаНДС.Организация = ДД.Организация
	|		И БлокировкаВычетаНДС.СчетФактура = ДД.СчетФактура
	|
	|ГДЕ
	|	(НЕ СчетаФактурыДокументы.СчетФактура ЕСТЬ NULL
	|		ИЛИ НЕ ИсправительныеСчетаФактуры.СчетФактура ЕСТЬ NULL)
	|	И (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС)
	|		ИЛИ (ДД.ВидДеятельностиНДС = ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров)
	|				И ДанныеПартий.ДатаПоступления >= &ДатаНачалаДействия150ФЗ))
	|	И БлокировкаВычетаНДС.СчетФактура ЕСТЬ NULL
	|
	|СГРУППИРОВАТЬ ПО
	|	ДанныеПартий.Период,
	|	ДанныеПартий.Регистратор,
	|	ДД.Организация,
	|	ДД.СчетФактура,
	|	ДД.Поставщик,
	|	ДД.ВидЦенности,
	|	ДД.СтавкаНДС,
	|	ДД.ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура
	|
	|ИМЕЮЩИЕ
	|	(ВЫБОР 
	|		КОГДА МАКСИМУМ(ДанныеПартий.НДС) <= (МАКСИМУМ(ДД.НДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДС, 0)))
	|			ТОГДА МАКСИМУМ(ДанныеПартий.НДС)
	|		ИНАЧЕ МАКСИМУМ(ДД.НДС) - СУММА(ЕСТЬNULL(ДанныеПартийУменьшение.НДС, 0))
	|	КОНЕЦ > 0)
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",           ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",            ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",       ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ДатаНачалаДействия150ФЗ", ДатаНачалаДействия150ФЗ());
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйВосстановлениеПоКСФ(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	2                                                                         КАК Приоритет,
	|	ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) КАК Период,
	|	ЕСТЬNULL(ИсправительныеСчетаФактуры.Ссылка, СчетаФактурыДокументы.Ссылка) КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                                    КАК ВидДвижения,
	|	ДД.Организация                                                            КАК Организация,
	|	ДД.СчетФактура                                                            КАК СчетФактура,
	|	ДД.Поставщик                                                              КАК Поставщик,
	|	ДД.ВидЦенности                                                            КАК ВидЦенности,
	|	ДД.СтавкаНДС                                                              КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                                                     КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура                                                КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт                                                      КАК РеализацияЭкспорт,
	|	-ДД.СуммаБезНДС                                                           КАК СуммаБезНДС,
	|	-ДД.НДС                                                                   КАК НДС,
	|	-ДД.НДСУпр                                                                КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВосстановлениеНДСПоКСФ)     КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)                КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                              КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                              КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                              КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                              КАК АналитикаРасходов,
	|	""""                                                                      КАК ИдентификаторСтроки,
	|	ИСТИНА                                                                    КАК РегламентнаяОперация
	|	
	|ПОМЕСТИТЬ НДСПредъявленныйВосстановлениеПоКСФ
	|ИЗ
	|	НДСПредъявленныйОстаткиНаКонецПериода КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.КорректировкаПриобретения КАК КорректировкаПоСогласованиюСторон
	|	ПО
	|		ДД.СчетФактура = КорректировкаПоСогласованиюСторон.Ссылка
	|		И ДД.Организация = КорректировкаПоСогласованиюСторон.Организация
	|		И КорректировкаПоСогласованиюСторон.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		ДД.Организация = СчетаФактурыДокументы.Организация
	|		И ДД.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ПО
	|		ДД.Организация = ИсправительныеСчетаФактуры.Организация
	|		И ДД.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|ГДЕ
	|	ДД.ВидДеятельностиНДС В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|	И ДД.НДС < 0
	|	
	|ОБЪЕДИНИТЬ ВСЕ
	|	
	|ВЫБРАТЬ
	|	2                                                                         КАК Приоритет,
	|	ЕСТЬNULL(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, СчетаФактурыДокументы.ДатаЗаписиКнигиПокупок) КАК Период,
	|	ЕСТЬNULL(ИсправительныеСчетаФактуры.Ссылка, СчетаФактурыДокументы.Ссылка) КАК Регистратор,
	|	ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)                                    КАК ВидДвижения,
	|	ДД.Организация                                                            КАК Организация,
	|	ДД.СчетФактура                                                            КАК СчетФактура,
	|	ДД.Поставщик                                                              КАК Поставщик,
	|	ДД.ВидЦенности                                                            КАК ВидЦенности,
	|	ДД.СтавкаНДС                                                              КАК СтавкаНДС,
	|	ДД.ВидДеятельностиНДС                                                     КАК ВидДеятельностиНДС,
	|	ДД.ИсправленныйСчетФактура                                                КАК ИсправленныйСчетФактура,
	|	ДД.РеализацияЭкспорт                                                      КАК РеализацияЭкспорт,
	|	-ДД.СуммаБезНДС                                                           КАК СуммаБезНДС,
	|	-ДД.НДС                                                                   КАК НДС,
	|	-ДД.НДСУпр                                                                КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВосстановлениеНДСПоКСФ)     КАК Событие,
	|	ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПустаяСсылка)                КАК КорВидДеятельностиНДС,
	|	НЕОПРЕДЕЛЕНО                                                              КАК Подразделение,
	|	НЕОПРЕДЕЛЕНО                                                              КАК НаправлениеДеятельности,
	|	НЕОПРЕДЕЛЕНО                                                              КАК СтатьяРасходов,        
	|	НЕОПРЕДЕЛЕНО                                                              КАК АналитикаРасходов,
	|	""""                                                                      КАК ИдентификаторСтроки,
	|	ИСТИНА                                                                    КАК РегламентнаяОперация
	|	
	|ИЗ
	|	НДСПредъявленныйОстаткиНаКонецПериода КАК ДД
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.СчетФактураПолученныйНалоговыйАгент КАК КорректировочныйСчетФактура
	|	ПО
	|		ДД.СчетФактура = КорректировочныйСчетФактура.Ссылка
	|		И ДД.Организация = КорректировочныйСчетФактура.Организация
	|		И КорректировочныйСчетФактура.Корректировочный
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		ДД.Организация = СчетаФактурыДокументы.Организация
	|		И ДД.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ПО
	|		ДД.Организация = ИсправительныеСчетаФактуры.Организация
	|		И ДД.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И ДД.ИсправленныйСчетФактура = ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|ГДЕ
	|	ДД.ВидДеятельностиНДС В (
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПоФактическомуИспользованию),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ПродажаНаЭкспорт),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг),
	|		ЗНАЧЕНИЕ(Перечисление.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров))
	|	И ДД.НДС < 0
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",           ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",            ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",       ПараметрыРасчета.МассивОрганизаций);
	Запрос.УстановитьПараметр("ДатаНачалаДействия150ФЗ", ДатаНачалаДействия150ФЗ());
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьЗаписиНДСПредъявленныйСохранение(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ПОМЕСТИТЬ РегистраторыЗапись
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ИЗ
	|	НДСПредъявленныйИзменениеВидаДеятельности КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПодВидДеятельности КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПоКСФ КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ИЗ
	|	НДСПредъявленныйПоИСФ КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСПредъявленный.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСПредъявленный КАК НДСПредъявленный
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|;
	|
	|/////////////////////////////////////////////
	|ВЫБРАТЬ
	|	0                                        КАК Приоритет,
	|	НДСПредъявленный.Период                  КАК Период,
	|	НДСПредъявленный.Регистратор             КАК Регистратор,
	|	НДСПредъявленный.ВидДвижения             КАК ВидДвижения,
	|	НДСПредъявленный.Организация             КАК Организация,
	|	НДСПредъявленный.СчетФактура             КАК СчетФактура,
	|	НДСПредъявленный.Поставщик               КАК Поставщик,
	|	НДСПредъявленный.ВидЦенности             КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС               КАК СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС      КАК ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт       КАК РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС             КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                     КАК НДС,
	|	НДСПредъявленный.НДСУпр                  КАК НДСУпр,
	|	НДСПредъявленный.Событие                 КАК Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС   КАК КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение           КАК Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов          КАК СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов       КАК АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки     КАК ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация    КАК РегламентнаяОперация
	|ПОМЕСТИТЬ НДСПредъявленныйСохранение
	|ИЗ
	|	РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистраторыЗапись КАК РегистраторыЗапись
	|	ПО 
	|		НДСПредъявленный.Регистратор = РегистраторыЗапись.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		Задания.Организация = НДСПредъявленный.Организация
	|		И Задания.СчетФактура = НДСПредъявленный.СчетФактура
	|ГДЕ
	|	НЕ РегистраторыЗапись.Регистратор ЕСТЬ NULL
	|	И (НДСПредъявленный.Период < &НачалоПериода
	|			ИЛИ НДСПредъявленный.Период > &КонецПериода
	|			ИЛИ НЕ НДСПредъявленный.РегламентнаяОперация
	|			ИЛИ Задания.СчетФактура ЕСТЬ NULL)
	|;
	|
	|/////////////////////////////////////////////
	|УНИЧТОЖИТЬ РегистраторыЗапись
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ЗаписатьНДСПредъявленный(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет КАК Приоритет,
	|	НДСПредъявленный.Период КАК Период,
	|	НДСПредъявленный.Регистратор КАК Регистратор,
	|	НДСПредъявленный.ВидДвижения КАК ВидДвижения,
	|	НДСПредъявленный.Организация КАК Организация,
	|	НДСПредъявленный.СчетФактура КАК СчетФактура,
	|	НДСПредъявленный.Поставщик КАК Поставщик,
	|	НДСПредъявленный.ВидЦенности КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС КАК СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт КАК РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС КАК НДС,
	|	НДСПредъявленный.НДСУпр КАК НДСУпр,
	|	НДСПредъявленный.Событие КАК Событие, 
	|	НДСПредъявленный.КорВидДеятельностиНДС КАК КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение  КАК Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности КАК НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов КАК СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов КАК АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки КАК ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация КАК РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйИзменениеВидаДеятельности КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйПоИСФ КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПодВидДеятельности КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПоКСФ КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет,
	|	НДСПредъявленный.Период,
	|	НДСПредъявленный.Регистратор,
	|	НДСПредъявленный.ВидДвижения,
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ВидДеятельностиНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	НДСПредъявленный.РеализацияЭкспорт,
	|	НДСПредъявленный.СуммаБезНДС,
	|	НДСПредъявленный.НДС,
	|	НДСПредъявленный.НДСУпр,
	|	НДСПредъявленный.Событие,
	|	НДСПредъявленный.КорВидДеятельностиНДС,
	|	НДСПредъявленный.Подразделение,
	|	НДСПредъявленный.НаправлениеДеятельности,
	|	НДСПредъявленный.СтатьяРасходов,        
	|	НДСПредъявленный.АналитикаРасходов,
	|	НДСПредъявленный.ИдентификаторСтроки,
	|	НДСПредъявленный.РегламентнаяОперация
	|ИЗ
	|	НДСПредъявленныйСохранение КАК НДСПредъявленный
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Период,
	|	Приоритет
	|
	|ИТОГИ ПО
	|	Регистратор
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ДокументыСОсобымПорядкомУплатыНДС = Новый ОписаниеТипов(
	"ДокументСсылка.СчетФактураНалоговыйАгент,
	|ДокументСсылка.ТаможеннаяДекларацияИмпорт,
	|ДокументСсылка.ЗаявлениеОВвозеТоваров");
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСПредъявленный.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		
		// проверка дат запрета производится при изменении данных об оплате в бюджет (РС ПодтверждениеОплатыНДСВБюджет)
		Если ДокументыСОсобымПорядкомУплатыНДС.СодержитТип(ТипЗнч(ВыборкаДокумент.Регистратор)) Тогда
			НаборЗаписей.ДополнительныеСвойства.Вставить("ПропуститьПроверкуЗапретаИзменения", Истина);
		КонецЕсли;
		
		Выборка = ВыборкаДокумент.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
			
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
	КонецЦикла;
	
КонецПроцедуры

Процедура ОчиститьНДСПредъявленный(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УстаревшиеРегистраторы.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСПредъявленный КАК УстаревшиеРегистраторы
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйИзменениеВидаДеятельности КАК НДСПредъявленныйИзменениеВидаДеятельности
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСПредъявленныйИзменениеВидаДеятельности.Регистратор
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленныйПринятиеКВычету
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСПредъявленныйПринятиеКВычету.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйПоИСФ КАК НДСПредъявленныйПоИСФ
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСПредъявленныйПоИСФ.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйВосстановлениеПоКСФ КАК НДСПредъявленныйВосстановлениеПоКСФ
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСПредъявленныйВосстановлениеПоКСФ.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСПредъявленныйСохранение КАК НДСПредъявленныйСохранение
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСПредъявленныйСохранение.Регистратор
	|	
	|
	|ГДЕ
	|	НДСПредъявленныйИзменениеВидаДеятельности.Регистратор ЕСТЬ NULL
	|	И НДСПредъявленныйПринятиеКВычету.Регистратор ЕСТЬ NULL
	|	И НДСПредъявленныйПоИСФ.Регистратор ЕСТЬ NULL
	|	И НДСПредъявленныйВосстановлениеПоКСФ.Регистратор ЕСТЬ NULL
	|	И НДСПредъявленныйСохранение.Регистратор ЕСТЬ NULL
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать();
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСПредъявленный.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		НаборЗаписей.Записать(Истина);
		
	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ФормированиеДвиженияНДСЗаписиКнигиПокупок

Процедура СформироватьНДСЗаписиКнигиПокупок(ПараметрыРасчета)
	
	ПолучитьТекущиеРегистраторыНДСЗаписиКнигиПокупок(ПараметрыРасчета);
	
	ПолучитьДокументыОплаты(ПараметрыРасчета);
	
	РассчитатьНДСЗаписиКнигиПокупокПоНДСПредъявленный(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПокупокСторноПоИСФ(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПокупокСохранение(ПараметрыРасчета);
	
	ЗаписатьНДСЗаписиКнигиПокупок(ПараметрыРасчета);
	ОчиститьНДСЗаписиКнигиПокупок(ПараметрыРасчета);
	
КонецПроцедуры

Процедура ПолучитьТекущиеРегистраторыНДСЗаписиКнигиПокупок(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПокупок.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ТекущиеРегистраторыНДСЗаписиКнигиПокупок
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО НДСЗаписиКнигиПокупок.Организация = Задания.Организация
	|			И НДСЗаписиКнигиПокупок.СчетФактура = Задания.СчетФактура
	|ГДЕ
	|	НДСЗаписиКнигиПокупок.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПокупокПоНДСПредъявленный(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура,
	|	СУММА(НДСПредъявленный.СуммаБезНДС) КАК СуммаБезНДС,
	|	СУММА(НДСПредъявленный.НДС) КАК НДС,
	|	СУММА(НДСПредъявленный.НДСУпр) КАК НДСУпр
	|ПОМЕСТИТЬ ВосстановленияНДС
	|ИЗ (ВЫБРАТЬ
	|		НДСПредъявленный.Организация,
	|		НДСПредъявленный.СчетФактура,
	|		НДСПредъявленный.Поставщик,
	|		НДСПредъявленный.ВидЦенности,
	|		НДСПредъявленный.СтавкаНДС,
	|		НДСПредъявленный.ИсправленныйСчетФактура,
	|		НДСПредъявленный.СуммаБезНДС КАК СуммаБезНДС,
	|		НДСПредъявленный.НДС КАК НДС,
	|		НДСПредъявленный.НДСУпр КАК НДСУпр
	|	ИЗ 
	|		РегистрНакопления.НДСПредъявленный КАК НДСПредъявленный
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			НДСПредъявленный.Организация = Задания.Организация
	|			И НДСПредъявленный.СчетФактура = Задания.СчетФактура
	|	ГДЕ
	|		НДСПредъявленный.Период < &НачалоПериода
	|		И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ВосстановлениеНДСПодВидДеятельности)
	|		И НДСПредъявленный.Активность
	|
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ
	|		НДСПредъявленный.Организация,
	|		НДСПредъявленный.СчетФактура,
	|		НДСПредъявленный.Поставщик,
	|		НДСПредъявленный.ВидЦенности,
	|		НДСПредъявленный.СтавкаНДС,
	|		НДСПредъявленный.ИсправленныйСчетФактура,
	|		НДСПредъявленный.СуммаБезНДС,
	|		НДСПредъявленный.НДС,
	|		НДСПредъявленный.НДСУпр
	|	ИЗ
	|		НДСПредъявленныйВосстановлениеПодВидДеятельности КАК НДСПредъявленный
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		НДСЗаписиКнигиПокупок.Организация,
	|		НДСЗаписиКнигиПокупок.СчетФактура,
	|		НДСЗаписиКнигиПокупок.Поставщик,
	|		НДСЗаписиКнигиПокупок.ВидЦенности,
	|		НДСЗаписиКнигиПокупок.СтавкаНДС,
	|		НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|		-НДСЗаписиКнигиПокупок.СуммаБезНДС КАК СуммаБезНДС,
	|		-НДСЗаписиКнигиПокупок.НДС КАК НДС,
	|		-НДСЗаписиКнигиПокупок.НДСУпр КАК НДСУпр
	|	ИЗ 
	|		РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|			Задания КАК Задания
	|		ПО
	|			НДСЗаписиКнигиПокупок.Организация = Задания.Организация
	|			И НДСЗаписиКнигиПокупок.СчетФактура = Задания.СчетФактура
	|	ГДЕ
	|		НДСЗаписиКнигиПокупок.Период < &НачалоПериода
	|		И НДСЗаписиКнигиПокупок.КодВидаОперации = ""25""
	|	) КАК НДСПредъявленный
	|
	|СГРУППИРОВАТЬ ПО
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура,
	|	НДСПредъявленный.Поставщик,
	|	НДСПредъявленный.ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС,
	|	НДСПредъявленный.ИсправленныйСчетФактура
	|
	|ИМЕЮЩИЕ
	|	СУММА(НДСПредъявленный.НДС) > 0
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	НДСПредъявленный.Организация,
	|	НДСПредъявленный.СчетФактура
	|;
	|
	// Записи по событию НДСПринятКВычету
	|///////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет                                      КАК Приоритет,
	|	НДСПредъявленный.Период                                         КАК Период,
	|	НДСПредъявленный.Регистратор                                    КАК Регистратор,
	|	НДСПредъявленный.Организация                                    КАК Организация,
	|	НДСПредъявленный.Поставщик                                      КАК Поставщик,
	|	НДСПредъявленный.СчетФактура                                    КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                    КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                      КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                                КАК ДатаОплаты,
	|	СчетаФактурыДокументы.ДокументОплаты                            КАК ДокументОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету0)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НеПодтвержденаСтавка0)
	|	КОНЕЦ                                                           КАК Событие,
	|	КОНЕЦПЕРИОДА(НДСПредъявленный.Период, КВАРТАЛ)                  КАК ДатаСобытия,
	|	ЕСТЬNULL(ИСФ.ЗаписьДополнительногоЛиста, ЛОЖЬ)                  КАК ЗаписьДополнительногоЛиста,
	|	ЕСТЬNULL(ИСФ.КорректируемыйПериод, ДАТАВРЕМЯ(1,1,1))            КАК КорректируемыйПериод,
	|	СчетаФактурыДокументы.ДоговорКонтрагента                        КАК ДоговорКонтрагента,
	|	НДСПредъявленный.ИсправленныйСчетФактура                        КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.СуммаБезНДС                                    КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                                            КАК НДС,
	|	НДСПредъявленный.НДСУпр                                         КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПринятиеНДСкВычету) КАК ХозяйственнаяОперация,
	|	""""                                                            КАК НомерДокументаОплаты,
	|	""""                                                            КАК ДатаДокументаОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
	|			ТОГДА ""20""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныйСоюз)
	|			ТОГДА ""19""
	|		ИНАЧЕ """"
	|	КОНЕЦ                                                           КАК КодВидаОперации,
	|	НДСПредъявленный.РегламентнаяОперация                           КАК РегламентнаяОперация,
	|	НДСПредъявленный.РеализацияЭкспорт                              КАК ДокументОтгрузки,
	|	НДСПредъявленный.ВидДеятельностиНДС                             КАК ВидДеятельностиНДС
	|ПОМЕСТИТЬ НДСЗаписиКнигиПокупокПоНДСПредъявленный
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|		И НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИСФ
	|	ПО
	|		НДСПредъявленный.Организация = ИСФ.Организация
	|		И НДСПредъявленный.СчетФактура = ИСФ.СчетФактура
	|		И НДСПредъявленный.ИсправленныйСчетФактура = ИСФ.ИсправительныйСчетФактура
	|	
	|ГДЕ
	|	НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Записи по событию НеПодтвержденаСтавка0
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет                                      КАК Приоритет,
	|	НДСПредъявленный.Период                                         КАК Период,
	|	НДСПредъявленный.Регистратор                                    КАК Регистратор,
	|	НДСПредъявленный.Организация                                    КАК Организация,
	|	НДСПредъявленный.Поставщик                                      КАК Поставщик,
	|	НДСПредъявленный.СчетФактура                                    КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                    КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                      КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                                КАК ДатаОплаты,
	|	СчетаФактурыДокументы.ДокументОплаты                            КАК ДокументОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету0)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НеПодтвержденаСтавка0)
	|	КОНЕЦ                                                           КАК Событие,
	|	КОНЕЦПЕРИОДА(НДСПредъявленный.Период, КВАРТАЛ)                  КАК ДатаСобытия,
	|	ЕСТЬNULL(ИСФ.ЗаписьДополнительногоЛиста, ЛОЖЬ)                  КАК ЗаписьДополнительногоЛиста,
	|	ЕСТЬNULL(ИСФ.КорректируемыйПериод, ДАТАВРЕМЯ(1,1,1))            КАК КорректируемыйПериод,
	|	СчетаФактурыДокументы.ДоговорКонтрагента                        КАК ДоговорКонтрагента,
	|	НДСПредъявленный.ИсправленныйСчетФактура                        КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.СуммаБезНДС                                    КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                                            КАК НДС,
	|	НДСПредъявленный.НДСУпр                                         КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПринятиеНДСкВычету) КАК ХозяйственнаяОперация,
	|	""""                                                            КАК НомерДокументаОплаты,
	|	""""                                                            КАК ДатаДокументаОплаты,
	|	""24""                                                          КАК КодВидаОперации,
	|	НДСПредъявленный.РегламентнаяОперация                           КАК РегламентнаяОперация,
	|	НДСПредъявленный.РеализацияЭкспорт                              КАК ДокументОтгрузки,
	|	НДСПредъявленный.ВидДеятельностиНДС                             КАК ВидДеятельностиНДС
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|		И НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИСФ
	|	ПО
	|		НДСПредъявленный.Организация = ИСФ.Организация
	|		И НДСПредъявленный.СчетФактура = ИСФ.СчетФактура
	|		И НДСПредъявленный.ИсправленныйСчетФактура = ИСФ.ИсправительныйСчетФактура
	|	
	|ГДЕ
	|	НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Записи по событию ПодтвержденаСтавка0
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет                                      КАК Приоритет,
	|	НДСПредъявленный.Период                                         КАК Период,
	|	НДСПредъявленный.Регистратор                                    КАК Регистратор,
	|	НДСПредъявленный.Организация                                    КАК Организация,
	|	НДСПредъявленный.Поставщик                                      КАК Поставщик,
	|	НДСПредъявленный.СчетФактура                                    КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                    КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                      КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                                КАК ДатаОплаты,
	|	СчетаФактурыДокументы.ДокументОплаты                            КАК ДокументОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету0)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НеПодтвержденаСтавка0)
	|	КОНЕЦ                                                           КАК Событие,
	|	КОНЕЦПЕРИОДА(НДСПредъявленный.Период, КВАРТАЛ)                  КАК ДатаСобытия,
	|	ЕСТЬNULL(ИСФ.ЗаписьДополнительногоЛиста, ЛОЖЬ)                  КАК ЗаписьДополнительногоЛиста,
	|	ЕСТЬNULL(ИСФ.КорректируемыйПериод, ДАТАВРЕМЯ(1,1,1))            КАК КорректируемыйПериод,
	|	СчетаФактурыДокументы.ДоговорКонтрагента                        КАК ДоговорКонтрагента,
	|	НДСПредъявленный.ИсправленныйСчетФактура                        КАК ИсправленныйСчетФактура,
	|	НДСПредъявленный.СуммаБезНДС - ЕСТЬNULL(ВосстановленияНДС.СуммаБезНДС, 0) КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС - ЕСТЬNULL(ВосстановленияНДС.НДС, 0)       КАК НДС,
	|	НДСПредъявленный.НДСУпр - ЕСТЬNULL(ВосстановленияНДС.НДСУпр, 0) КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПринятиеНДСкВычету) КАК ХозяйственнаяОперация,
	|	""""                                                            КАК НомерДокументаОплаты,
	|	""""                                                            КАК ДатаДокументаОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
	|			ТОГДА ""20""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныйСоюз)
	|			ТОГДА ""19""
	|		ИНАЧЕ """"
	|	КОНЕЦ                                                           КАК КодВидаОперации,
	|	НДСПредъявленный.РегламентнаяОперация                           КАК РегламентнаяОперация,
	|	НДСПредъявленный.РеализацияЭкспорт                              КАК ДокументОтгрузки,
	|	НДСПредъявленный.ВидДеятельностиНДС                             КАК ВидДеятельностиНДС
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|		И НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВосстановленияНДС КАК ВосстановленияНДС
	|	ПО
	|		НДСПредъявленный.Организация = ВосстановленияНДС.Организация
	|		И НДСПредъявленный.СчетФактура = ВосстановленияНДС.СчетФактура
	|		И НДСПредъявленный.Поставщик = НДСПредъявленный.Поставщик
	|		И НДСПредъявленный.ВидЦенности = НДСПредъявленный.ВидЦенности
	|		И НДСПредъявленный.СтавкаНДС = НДСПредъявленный.СтавкаНДС
	|		И НДСПредъявленный.ИсправленныйСчетФактура = НДСПредъявленный.ИсправленныйСчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИСФ
	|	ПО
	|		НДСПредъявленный.Организация = ИСФ.Организация
	|		И НДСПредъявленный.ИсправленныйСчетФактура = ИСФ.ИсправительныйСчетФактура
	|ГДЕ
	|	НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|	И (НДСПредъявленный.НДС - ЕСТЬNULL(ВосстановленияНДС.НДС, 0)) > 0
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет                                      КАК Приоритет,
	|	НДСПредъявленный.Период                                         КАК Период,
	|	НДСПредъявленный.Регистратор                                    КАК Регистратор,
	|	НДСПредъявленный.Организация                                    КАК Организация,
	|	НДСПредъявленный.Поставщик                                      КАК Поставщик,
	|	НДСПредъявленный.СчетФактура                                    КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                    КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                      КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                                КАК ДатаОплаты,
	|	СчетаФактурыДокументы.ДокументОплаты                            КАК ДокументОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету0)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НеПодтвержденаСтавка0)
	|	КОНЕЦ                                                           КАК Событие,
	|	КОНЕЦПЕРИОДА(НДСПредъявленный.Период, КВАРТАЛ)                  КАК ДатаСобытия,
	|	ЕСТЬNULL(ИСФ.ЗаписьДополнительногоЛиста, ЛОЖЬ)                  КАК ЗаписьДополнительногоЛиста,
	|	ЕСТЬNULL(ИСФ.КорректируемыйПериод, ДАТАВРЕМЯ(1,1,1))            КАК КорректируемыйПериод,
	|	СчетаФактурыДокументы.ДоговорКонтрагента                        КАК ДоговорКонтрагента,
	|	НДСПредъявленный.ИсправленныйСчетФактура                        КАК ИсправленныйСчетФактура,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.СуммаБезНДС < ВосстановленияНДС.СуммаБезНДС
	|			ТОГДА НДСПредъявленный.СуммаБезНДС 
	|		ИНАЧЕ
	|			ВосстановленияНДС.СуммаБезНДС
	|	КОНЕЦ                                                           КАК СуммаБезНДС,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.НДС < ВосстановленияНДС.НДС
	|			ТОГДА НДСПредъявленный.НДС 
	|		ИНАЧЕ
	|			ВосстановленияНДС.НДС
	|	КОНЕЦ                                                           КАК НДС,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.НДСУпр < ВосстановленияНДС.НДСУпр
	|			ТОГДА НДСПредъявленный.НДСУпр 
	|		ИНАЧЕ
	|			ВосстановленияНДС.НДСУпр
	|	КОНЕЦ                                                           КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПринятиеНДСкВычету) КАК ХозяйственнаяОперация,
	|	""""                                                            КАК НомерДокументаОплаты,
	|	""""                                                            КАК ДатаДокументаОплаты,
	|	""25""                                                          КАК КодВидаОперации,
	|	НДСПредъявленный.РегламентнаяОперация                           КАК РегламентнаяОперация,
	|	НДСПредъявленный.РеализацияЭкспорт                              КАК ДокументОтгрузки,
	|	НДСПредъявленный.ВидДеятельностиНДС                             КАК ВидДеятельностиНДС
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|		И НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ВосстановленияНДС КАК ВосстановленияНДС
	|	ПО
	|		НДСПредъявленный.Организация = ВосстановленияНДС.Организация
	|		И НДСПредъявленный.СчетФактура = ВосстановленияНДС.СчетФактура
	|		И НДСПредъявленный.Поставщик = НДСПредъявленный.Поставщик
	|		И НДСПредъявленный.ВидЦенности = НДСПредъявленный.ВидЦенности
	|		И НДСПредъявленный.СтавкаНДС = НДСПредъявленный.СтавкаНДС
	|		И НДСПредъявленный.ИсправленныйСчетФактура = НДСПредъявленный.ИсправленныйСчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИСФ
	|	ПО
	|		НДСПредъявленный.Организация = ИСФ.Организация
	|		И НДСПредъявленный.ИсправленныйСчетФактура = ИСФ.ИсправительныйСчетФактура
	|	
	|ГДЕ
	|	НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	// Регистрация документов оплаты
	|ВЫБРАТЬ
	|	НДСПредъявленный.Приоритет                                      КАК Приоритет,
	|	НДСПредъявленный.Период                                         КАК Период,
	|	НДСПредъявленный.Регистратор                                    КАК Регистратор,
	|	НДСПредъявленный.Организация                                    КАК Организация,
	|	НДСПредъявленный.Поставщик                                      КАК Поставщик,
	|	НДСПредъявленный.СчетФактура                                    КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                    КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                      КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                                КАК ДатаОплаты,
	|	СчетаФактурыДокументы.ДокументОплаты                            КАК ДокументОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.ПредъявленНДСКВычету0)
	|		КОГДА НДСПредъявленный.Событие = ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0)
	|			ТОГДА ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПокупки.НеПодтвержденаСтавка0)
	|	КОНЕЦ                                                          КАК Событие,
	|	НДСПредъявленный.Период                                        КАК ДатаСобытия,
	|	ЕСТЬNULL(ИСФ.ЗаписьДополнительногоЛиста, ЛОЖЬ)                 КАК ЗаписьДополнительногоЛиста,
	|	ЕСТЬNULL(ИСФ.КорректируемыйПериод, ДАТАВРЕМЯ(1,1,1))           КАК КорректируемыйПериод,
	|	СчетаФактурыДокументы.ДоговорКонтрагента                       КАК ДоговорКонтрагента,
	|	НДСПредъявленный.ИсправленныйСчетФактура                       КАК ИсправленныйСчетФактура,
	|	0                                                              КАК СуммаБезНДС,
	|	0                                                              КАК НДС,
	|	0                                                              КАК НДСУпр,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПринятиеНДСкВычету) КАК ХозяйственнаяОперация,
	|	ДокументыОплаты.НомерДокументаОплаты                            КАК НомерДокументаОплаты,
	|	ДокументыОплаты.ДатаДокументаОплаты                             КАК ДатаДокументаОплаты,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныеПлатежи)
	|			ТОГДА ""20""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.ТаможенныйСоюз)
	|			ТОГДА ""19""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентАренда)
	|			ТОГДА ""06""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентРеализацияИмущества)
	|			ТОГДА ""06""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентИностранцы)
	|			ТОГДА ""06""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентЭлектронныеУслуги)
	|			ТОГДА ""06""
	|		КОГДА НДСПредъявленный.ВидЦенности = ЗНАЧЕНИЕ(Перечисление.ВидыЦенностей.НалоговыйАгентКомитент)
	|			ТОГДА ""06""
	|		ИНАЧЕ """"
	|	КОНЕЦ                                                           КАК КодВидаОперации,
	|	НДСПредъявленный.РегламентнаяОперация                           КАК РегламентнаяОперация,
	|	НДСПредъявленный.РеализацияЭкспорт                              КАК ДокументОтгрузки,
	|	НДСПредъявленный.ВидДеятельностиНДС                             КАК ВидДеятельностиНДС
	|ИЗ
	|	НДСПредъявленныйПринятиеКВычету КАК НДСПредъявленный
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|		И НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		ДокументыОплаты КАК ДокументыОплаты
	|	ПО
	|		НДСПредъявленный.Организация = ДокументыОплаты.Организация
	|		И НДСПредъявленный.СчетФактура = ДокументыОплаты.СчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ВосстановленияНДС КАК ВосстановленияНДС
	|	ПО
	|		НДСПредъявленный.Организация = ВосстановленияНДС.Организация
	|		И НДСПредъявленный.СчетФактура = ВосстановленияНДС.СчетФактура
	|		И НДСПредъявленный.Поставщик = НДСПредъявленный.Поставщик
	|		И НДСПредъявленный.ВидЦенности = НДСПредъявленный.ВидЦенности
	|		И НДСПредъявленный.СтавкаНДС = НДСПредъявленный.СтавкаНДС
	|		И НДСПредъявленный.ИсправленныйСчетФактура = НДСПредъявленный.ИсправленныйСчетФактура
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		ИсправительныеСчетаФактуры КАК ИСФ
	|	ПО
	|		НДСПредъявленный.Организация = ИСФ.Организация
	|		И НДСПредъявленный.ИсправленныйСчетФактура = ИСФ.ИсправительныйСчетФактура
	|
	|ГДЕ
	|	ВосстановленияНДС.СчетФактура ЕСТЬ NULL
	|	И НДСПредъявленный.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход)
	|	И НДСПредъявленный.Событие В (
	|			ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НДСПринятКВычету),
	|			ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.ПодтвержденаСтавка0),
	|			ЗНАЧЕНИЕ(Перечисление.СобытияНДСПредъявленный.НеПодтвержденаСтавка0))
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПокупокСторноПоИСФ(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	1                                          КАК Приоритет,
	|	ИсправительныеСчетаФактуры.Ссылка          КАК Регистратор,
	|	ИсправительныеСчетаФактуры.ДатаПолучения   КАК Период,
	|	НДСЗаписиКнигиПокупок.Организация          КАК Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик            КАК Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура          КАК СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности          КАК ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС            КАК СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.СчетУчетаНДС         КАК СчетУчетаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты           КАК ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты       КАК ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие              КАК Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия          КАК ДатаСобытия,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НДСЗаписиКнигиПокупок.ЗаписьДополнительногоЛиста
	|			ТОГДА ИСТИНА
	|		КОГДА НАЧАЛОПЕРИОДА(НДСЗаписиКнигиПокупок.Период, Квартал) < 
	|				НАЧАЛОПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, Квартал)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ) КАК ЗаписьДополнительногоЛиста,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НДСЗаписиКнигиПокупок.КорректируемыйПериод <> ДАТАВРЕМЯ(1,1,1)
	|			ТОГДА НДСЗаписиКнигиПокупок.КорректируемыйПериод
	|		КОГДА НАЧАЛОПЕРИОДА(НДСЗаписиКнигиПокупок.Период, Квартал) < 
	|				НАЧАЛОПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, Квартал)
	|			ТОГДА НДСЗаписиКнигиПокупок.Период
	|	КОНЕЦ) КАК КорректируемыйПериод,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента      КАК ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	-СУММА(НДСЗаписиКнигиПокупок.СуммаБезНДС)     КАК СуммаБезНДС,
	|	-СУММА(НДСЗаписиКнигиПокупок.НДС)             КАК НДС,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация   КАК ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты    КАК НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты     КАК ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации         КАК КодВидаОперации,
	|	ИСТИНА                                        КАК РегламентнаяОперация,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки        КАК ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС      КАК ВидДеятельностиНДС
	|
	|ПОМЕСТИТЬ НДСЗаписиКнигиПокупокСторноПоИСФ
	|ИЗ
	|	ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|	ПО
	|		НДСЗаписиКнигиПокупок.Организация = ИсправительныеСчетаФактуры.Организация
	|		И НДСЗаписиКнигиПокупок.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И НДСЗаписиКнигиПокупок.Период < &НачалоПериода
	|ГДЕ
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура <> ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсправительныеСчетаФактуры.Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаПолучения,
	|	НДСЗаписиКнигиПокупок.Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.СчетУчетаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(НДСЗаписиКнигиПокупок.НДС) <> 0
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПокупокСохранение(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПокупок.Регистратор
	|ПОМЕСТИТЬ РегистраторыЗапись
	|ИЗ
	|	НДСЗаписиКнигиПокупокПоНДСПредъявленный КАК НДСЗаписиКнигиПокупок
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПокупок.Регистратор
	|ИЗ
	|	НДСЗаписиКнигиПокупокСторноПоИСФ КАК НДСЗаписиКнигиПокупок
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПокупок.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|;
	|
	|ВЫБРАТЬ
	|	0 КАК Приоритет,
	|	НДСЗаписиКнигиПокупок.Период,
	|	НДСЗаписиКнигиПокупок.Регистратор,
	|	НДСЗаписиКнигиПокупок.Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия,
	|	НДСЗаписиКнигиПокупок.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПокупок.КорректируемыйПериод,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПокупок.СуммаБезНДС,
	|	НДСЗаписиКнигиПокупок.НДС,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации,
	|	НДСЗаписиКнигиПокупок.РегламентнаяОперация,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС
	|ПОМЕСТИТЬ НДСЗаписиКнигиПокупокСохранение
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПокупок КАК НДСЗаписиКнигиПокупок
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		РегистраторыЗапись КАК РегистраторыЗапись
	|	ПО
	|		НДСЗаписиКнигиПокупок.Регистратор = РегистраторыЗапись.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		НДСЗаписиКнигиПокупок.Организация = Задания.Организация
	|		И НДСЗаписиКнигиПокупок.СчетФактура = Задания.СчетФактура
	|
	|ГДЕ
	|	(НЕ РегистраторыЗапись.Регистратор ЕСТЬ NULL)
	|	И (НДСЗаписиКнигиПокупок.Период < &НачалоПериода
	|			ИЛИ НДСЗаписиКнигиПокупок.Период > &КонецПериода
	|			ИЛИ НЕ НДСЗаписиКнигиПокупок.РегламентнаяОперация
	|			ИЛИ Задания.СчетФактура ЕСТЬ NULL)
	|;
	|
	|/////////////////////////////////////////////
	|УНИЧТОЖИТЬ РегистраторыЗапись
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ЗаписатьНДСЗаписиКнигиПокупок(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДСЗаписиКнигиПокупок.Приоритет,
	|	НДСЗаписиКнигиПокупок.Период,
	|	НДСЗаписиКнигиПокупок.Регистратор,
	|	НДСЗаписиКнигиПокупок.Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия,
	|	НДСЗаписиКнигиПокупок.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПокупок.КорректируемыйПериод,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПокупок.СуммаБезНДС,
	|	НДСЗаписиКнигиПокупок.НДС,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации,
	|	НДСЗаписиКнигиПокупок.РегламентнаяОперация,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПокупокПоНДСПредъявленный КАК НДСЗаписиКнигиПокупок
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСЗаписиКнигиПокупок.Приоритет,
	|	НДСЗаписиКнигиПокупок.Период,
	|	НДСЗаписиКнигиПокупок.Регистратор,
	|	НДСЗаписиКнигиПокупок.Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия,
	|	НДСЗаписиКнигиПокупок.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПокупок.КорректируемыйПериод,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПокупок.СуммаБезНДС,
	|	НДСЗаписиКнигиПокупок.НДС,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации,
	|	НДСЗаписиКнигиПокупок.РегламентнаяОперация,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПокупокСторноПоИСФ КАК НДСЗаписиКнигиПокупок
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСЗаписиКнигиПокупок.Приоритет,
	|	НДСЗаписиКнигиПокупок.Период,
	|	НДСЗаписиКнигиПокупок.Регистратор,
	|	НДСЗаписиКнигиПокупок.Организация,
	|	НДСЗаписиКнигиПокупок.Поставщик,
	|	НДСЗаписиКнигиПокупок.СчетФактура,
	|	НДСЗаписиКнигиПокупок.ВидЦенности,
	|	НДСЗаписиКнигиПокупок.СтавкаНДС,
	|	НДСЗаписиКнигиПокупок.ДатаОплаты,
	|	НДСЗаписиКнигиПокупок.ДокументОплаты,
	|	НДСЗаписиКнигиПокупок.Событие,
	|	НДСЗаписиКнигиПокупок.ДатаСобытия,
	|	НДСЗаписиКнигиПокупок.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПокупок.КорректируемыйПериод,
	|	НДСЗаписиКнигиПокупок.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПокупок.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПокупок.СуммаБезНДС,
	|	НДСЗаписиКнигиПокупок.НДС,
	|	НДСЗаписиКнигиПокупок.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПокупок.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПокупок.КодВидаОперации,
	|	НДСЗаписиКнигиПокупок.РегламентнаяОперация,
	|	НДСЗаписиКнигиПокупок.ДокументОтгрузки,
	|	НДСЗаписиКнигиПокупок.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПокупокСохранение КАК НДСЗаписиКнигиПокупок
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Период,
	|	Приоритет
	|
	|ИТОГИ ПО
	|	Регистратор
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ДокументыСОсобымПорядкомУплатыНДС = Новый ОписаниеТипов(
	"ДокументСсылка.СчетФактураНалоговыйАгент,
	|ДокументСсылка.ТаможеннаяДекларацияИмпорт,
	|ДокументСсылка.ЗаявлениеОВвозеТоваров");
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСЗаписиКнигиПокупок.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		
		// проверка дат запрета производится при изменении данных об оплате в бюджет (РС ПодтверждениеОплатыНДСВБюджет)
		Если ДокументыСОсобымПорядкомУплатыНДС.СодержитТип(ТипЗнч(ВыборкаДокумент.Регистратор)) Тогда
			НаборЗаписей.ДополнительныеСвойства.Вставить("ПропуститьПроверкуЗапретаИзменения", Истина);
		КонецЕсли;
		
		Выборка = ВыборкаДокумент.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
			
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
	КонецЦикла;

КонецПроцедуры

Процедура ОчиститьНДСЗаписиКнигиПокупок(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УстаревшиеРегистраторы.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСЗаписиКнигиПокупок КАК УстаревшиеРегистраторы
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПокупокПоНДСПредъявленный КАК НДСЗаписиКнигиПокупокПоНДСПредъявленный
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПокупокПоНДСПредъявленный.Регистратор
	|		
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПокупокСохранение КАК НДСЗаписиКнигиПокупокСохранение
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПокупокСохранение.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПокупокСторноПоИСФ КАК НДСЗаписиКнигиПокупокСторноПоИСФ
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПокупокСторноПоИСФ.Регистратор
	|
	|ГДЕ
	|	НДСЗаписиКнигиПокупокПоНДСПредъявленный.Регистратор ЕСТЬ NULL
	|	И НДСЗаписиКнигиПокупокСохранение.Регистратор ЕСТЬ NULL
	|	И НДСЗаписиКнигиПокупокСторноПоИСФ.Регистратор ЕСТЬ NULL
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать();
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСЗаписиКнигиПокупок.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		НаборЗаписей.Записать(Истина);
		
	КонецЦикла;

КонецПроцедуры

#КонецОбласти

#Область ФормированиеДвиженияНДСЗаписиКнигиПродаж

Процедура СформироватьНДСЗаписиКнигиПродаж(ПараметрыРасчета)
	
	ПолучитьТекущиеРегистраторыНДСЗаписиКнигиПродаж(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПродажПоНДСПредъявленный(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПродажСторноПоИСФ(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПродажОплатыСФ(ПараметрыРасчета);
	РассчитатьНДСЗаписиКнигиПродажСохранение(ПараметрыРасчета);
	
	ЗаписатьНДСЗаписиКнигиПродаж(ПараметрыРасчета);
	ОчиститьНДСЗаписиКнигиПродаж(ПараметрыРасчета);
	
КонецПроцедуры

Процедура ПолучитьТекущиеРегистраторыНДСЗаписиКнигиПродаж(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПродаж.Регистратор КАК Регистратор
	|ПОМЕСТИТЬ ТекущиеРегистраторыНДСЗаписиКнигиПродаж
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		НДСЗаписиКнигиПродаж.Организация = Задания.Организация
	|		И НДСЗаписиКнигиПродаж.СчетФактура = Задания.СчетФактура
	|ГДЕ
	|	НДСЗаписиКнигиПродаж.Период МЕЖДУ &НачалоПериода И &КонецПериода
	|	И НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПродаж.Регистратор КАК Регистратор
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		НДСЗаписиКнигиПродаж.Регистратор = Задания.СчетФактура
	|ГДЕ
	| 	НДСЗаписиКнигиПродаж.Регистратор ССЫЛКА Документ.СчетФактураНалоговыйАгент
	|	И НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|
	|ИНДЕКСИРОВАТЬ ПО
	|	Регистратор
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",      ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",       ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",  ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПродажПоНДСПредъявленный(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	1                                                            КАК Приоритет,
	|	НДСПредъявленный.Период                                      КАК Период,
	|	НДСПредъявленный.Регистратор                                 КАК Регистратор,
	|	НДСПредъявленный.Организация                                 КАК Организация,
	|	НДСПредъявленный.Поставщик                                   КАК Покупатель,
	|	НДСПредъявленный.СчетФактура                                 КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                 КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                   КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаОплаты,
	|	НЕОПРЕДЕЛЕНО                                                 КАК ДокументОплаты,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПродажи.ВосстановлениеНДС) КАК Событие,
	|	НДСПредъявленный.Период                                      КАК ДатаСобытия,
	|	ЛОЖЬ                                                         КАК ЗаписьДополнительногоЛиста,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК КорректируемыйПериод,
	|	ЛОЖЬ                                                         КАК СторнирующаяЗаписьДопЛиста,
	|	НДСПредъявленный.ИсправленныйСчетФактура                     КАК ИсправленныйСчетФактура,
	|	ЛОЖЬ                                                         КАК Исправление,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаСчетаФактурыКомиссионера,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.СуммаБезНДС = 0 И НДСПредъявленный.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
	|			ТОГДА НДСПредъявленный.НДС * 100 / 18
	|		КОГДА НДСПредъявленный.СуммаБезНДС = 0 И НДСПредъявленный.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА НДСПредъявленный.НДС * 100 / 18
	|		КОГДА НДСПредъявленный.СуммаБезНДС = 0 И НДСПредъявленный.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
	|			ТОГДА НДСПредъявленный.НДС * 100 / 10
	|		ИНАЧЕ НДСПредъявленный.СуммаБезНДС
	|	КОНЕЦ КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                                         КАК НДС,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)    КАК ХозяйственнаяОперация,
	|	""""                                                         КАК НомерДокументаОплаты,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаДокументаОплаты,
	|	""21""                                                       КАК КодВидаОперации,
	|	ИСТИНА                                                       КАК РегламентнаяОперация,
	|	НДСПредъявленный.ВидДеятельностиНДС                          КАК ВидДеятельностиНДС
	|ПОМЕСТИТЬ НДСЗаписиКнигиПродажПоНДСПредъявленный
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПодВидДеятельности КАК НДСПредъявленный
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	1                                                            КАК Приоритет,
	|	НДСПредъявленный.Период                                      КАК Период,
	|	НДСПредъявленный.Регистратор                                 КАК Регистратор,
	|	НДСПредъявленный.Организация                                 КАК Организация,
	|	НДСПредъявленный.Поставщик                                   КАК Покупатель,
	|	НДСПредъявленный.СчетФактура                                 КАК СчетФактура,
	|	НДСПредъявленный.ВидЦенности                                 КАК ВидЦенности,
	|	НДСПредъявленный.СтавкаНДС                                   КАК СтавкаНДС,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаОплаты,
	|	НЕОПРЕДЕЛЕНО                                                 КАК ДокументОплаты,
	|	ЗНАЧЕНИЕ(Перечисление.СобытияПоНДСПродажи.ВосстановлениеНДС) КАК Событие,
	|	НДСПредъявленный.Период                                      КАК ДатаСобытия,
	|	ЛОЖЬ                                                         КАК ЗаписьДополнительногоЛиста,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК КорректируемыйПериод,
	|	ЛОЖЬ                                                         КАК СторнирующаяЗаписьДопЛиста,
	|	НДСПредъявленный.ИсправленныйСчетФактура                     КАК ИсправленныйСчетФактура,
	|	ЛОЖЬ                                                         КАК Исправление,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаСчетаФактурыКомиссионера,
	|	ВЫБОР 
	|		КОГДА НДСПредъявленный.СуммаБезНДС = 0 И НДСПредъявленный.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
	|			ТОГДА НДСПредъявленный.НДС * 100 / 18
	|		ИНАЧЕ НДСПредъявленный.СуммаБезНДС
	|	КОНЕЦ КАК СуммаБезНДС,
	|	НДСПредъявленный.НДС                                         КАК НДС,
	|	ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)    КАК ХозяйственнаяОперация,
	|	""""                                                         КАК НомерДокументаОплаты,
	|	ДАТАВРЕМЯ(1,1,1)                                             КАК ДатаДокументаОплаты,
	|	СчетаФактурыДокументы.Ссылка.КодВидаОперацииНаУменьшение     КАК КодВидаОперации,
	|	ИСТИНА                                                       КАК РегламентнаяОперация,
	|	НДСПредъявленный.ВидДеятельностиНДС                          КАК ВидДеятельностиНДС
	|ИЗ
	|	НДСПредъявленныйВосстановлениеПоКСФ КАК НДСПредъявленный
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		СчетаФактурыДокументы КАК СчетаФактурыДокументы
	|	ПО
	|		НДСПредъявленный.СчетФактура = СчетаФактурыДокументы.СчетФактура
	|		И НДСПредъявленный.Организация = СчетаФактурыДокументы.Организация
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",      ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",       ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций",  ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	Запрос.Выполнить();

КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПродажСторноПоИСФ(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	1                                           КАК Приоритет,
	|	ИсправительныеСчетаФактуры.Ссылка           КАК Регистратор,
	|	ИсправительныеСчетаФактуры.ДатаИсправления  КАК Период,
	|	НДСЗаписиКнигиПродаж.Организация            КАК Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель             КАК Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура            КАК СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности            КАК ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС              КАК СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты             КАК ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты         КАК ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие                КАК Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия            КАК ДатаСобытия,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста
	|			ТОГДА ИСТИНА
	|		КОГДА НАЧАЛОПЕРИОДА(НДСЗаписиКнигиПродаж.Период, Квартал) < 
	|				НАЧАЛОПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, Квартал)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ)  КАК ЗаписьДополнительногоЛиста,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НДСЗаписиКнигиПродаж.КорректируемыйПериод <> ДАТАВРЕМЯ(1,1,1)
	|			ТОГДА НДСЗаписиКнигиПродаж.КорректируемыйПериод
	|		КОГДА НАЧАЛОПЕРИОДА(НДСЗаписиКнигиПродаж.Период, Квартал) < 
	|				НАЧАЛОПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, Квартал)
	|			ТОГДА НДСЗаписиКнигиПродаж.Период
	|	КОНЕЦ) КАК КорректируемыйПериод,
	|	МАКСИМУМ(ВЫБОР
	|		КОГДА НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста
	|			ТОГДА ИСТИНА
	|		КОГДА НАЧАЛОПЕРИОДА(НДСЗаписиКнигиПродаж.Период, Квартал) < 
	|				НАЧАЛОПЕРИОДА(ИсправительныеСчетаФактуры.ДатаЗаписиКнигиПокупок, Квартал)
	|			ТОГДА ИСТИНА
	|		ИНАЧЕ ЛОЖЬ
	|	КОНЕЦ)  КАК СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента           КАК ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура      КАК ИсправленныйСчетФактура,
	|	ИСТИНА                                            КАК Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера КАК ДатаСчетаФактурыКомиссионера,
	|	-СУММА(НДСЗаписиКнигиПродаж.СуммаБезНДС)          КАК СуммаБезНДС,
	|	-СУММА(НДСЗаписиКнигиПродаж.НДС)                  КАК НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация        КАК ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты         КАК НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты          КАК ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации              КАК КодВидаОперации,
	|	ИСТИНА                                            КАК РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС           КАК ВидДеятельностиНДС
	|
	|ПОМЕСТИТЬ НДСЗаписиКнигиПродажСторноПоИСФ
	|ИЗ
	|	ИсправительныеСчетаФактуры КАК ИсправительныеСчетаФактуры
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|	ПО
	|		НДСЗаписиКнигиПродаж.Организация = ИсправительныеСчетаФактуры.Организация
	|		И НДСЗаписиКнигиПродаж.СчетФактура = ИсправительныеСчетаФактуры.СчетФактура
	|		И НДСЗаписиКнигиПродаж.Период < &НачалоПериода
	|	
	|	ВНУТРЕННЕЕ СОЕДИНЕНИЕ
	|		Документ.КорректировкаПриобретения КАК КорректировкаПоСогласованиюСторон
	|	ПО
	|		ИсправительныеСчетаФактуры.СчетФактура = КорректировкаПоСогласованиюСторон.Ссылка
	|		И ИсправительныеСчетаФактуры.Организация = КорректировкаПоСогласованиюСторон.Организация
	|		И КорректировкаПоСогласованиюСторон.ВидКорректировки = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.КорректировкаПоСогласованиюСторон)
	|	
	|ГДЕ
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура <> ИсправительныеСчетаФактуры.ИсправительныйСчетФактура
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсправительныеСчетаФактуры.Ссылка,
	|	ИсправительныеСчетаФактуры.ДатаИсправления,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|
	|ИМЕЮЩИЕ
	|	СУММА(НДСЗаписиКнигиПродаж.НДС) <> 0
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПродажСохранение(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПродаж.Регистратор
	|ПОМЕСТИТЬ РегистраторыЗапись
	|ИЗ
	|	НДСЗаписиКнигиПродажПоНДСПредъявленный КАК НДСЗаписиКнигиПродаж
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПродаж.Регистратор
	|ИЗ
	|	НДСЗаписиКнигиПродажСторноПоИСФ КАК НДСЗаписиКнигиПродаж
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НДСЗаписиКнигиПродаж.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|;
	|
	|ВЫБРАТЬ
	|	0 КАК Приоритет,
	|	НДСЗаписиКнигиПродаж.Период,
	|	НДСЗаписиКнигиПродаж.Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.СуммаБезНДС,
	|	НДСЗаписиКнигиПродаж.НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|ПОМЕСТИТЬ НДСЗаписиКнигиПродажСохранение
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ 
	|		РегистраторыЗапись КАК РегистраторыЗапись
	|	ПО 
	|		НДСЗаписиКнигиПродаж.Регистратор = РегистраторыЗапись.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		Задания КАК Задания
	|	ПО
	|		НДСЗаписиКнигиПродаж.Организация = Задания.Организация
	|		И НДСЗаписиКнигиПродаж.СчетФактура = Задания.СчетФактура
	|	
	|ГДЕ
	|	(НЕ РегистраторыЗапись.Регистратор ЕСТЬ NULL)
	|	И (НДСЗаписиКнигиПродаж.Период < &НачалоПериода
	|			ИЛИ НДСЗаписиКнигиПродаж.Период > &КонецПериода
	|			ИЛИ НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация
	|			ИЛИ Задания.СчетФактура ЕСТЬ NULL)
	|;
	|
	|/////////////////////////////////////////////
	|УНИЧТОЖИТЬ РегистраторыЗапись";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ЗаписатьНДСЗаписиКнигиПродаж(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НДСЗаписиКнигиПродаж.Приоритет,
	|	НДСЗаписиКнигиПродаж.Период,
	|	НДСЗаписиКнигиПродаж.Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста,
	|	НЕОПРЕДЕЛЕНО 	 КАК ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.СуммаБезНДС,
	|	НДСЗаписиКнигиПродаж.НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПродажПоНДСПредъявленный КАК НДСЗаписиКнигиПродаж
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСЗаписиКнигиПродаж.Приоритет,
	|	НДСЗаписиКнигиПродаж.Период,
	|	НДСЗаписиКнигиПродаж.Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.СуммаБезНДС,
	|	НДСЗаписиКнигиПродаж.НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПродажСторноПоИСФ КАК НДСЗаписиКнигиПродаж
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСЗаписиКнигиПродаж.Приоритет,
	|	НДСЗаписиКнигиПродаж.Период,
	|	НДСЗаписиКнигиПродаж.Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.СуммаБезНДС,
	|	НДСЗаписиКнигиПродаж.НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПродажОплатыСФ КАК НДСЗаписиКнигиПродаж
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	НДСЗаписиКнигиПродаж.Приоритет,
	|	НДСЗаписиКнигиПродаж.Период,
	|	НДСЗаписиКнигиПродаж.Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера,
	|	НДСЗаписиКнигиПродаж.СуммаБезНДС,
	|	НДСЗаписиКнигиПродаж.НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.НомерДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.ДатаДокументаОплаты,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации,
	|	НДСЗаписиКнигиПродаж.РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС
	|ИЗ
	|	НДСЗаписиКнигиПродажСохранение КАК НДСЗаписиКнигиПродаж
	|
	|УПОРЯДОЧИТЬ ПО
	|	Регистратор,
	|	Период,
	|	Приоритет
	|
	|ИТОГИ ПО
	|	Регистратор
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",  ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать(ОбходРезультатаЗапроса.ПоГруппировкам);
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСЗаписиКнигиПродаж.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		
		Выборка = ВыборкаДокумент.Выбрать();
		Пока Выборка.Следующий() Цикл
			
			НоваяЗапись = НаборЗаписей.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяЗапись, Выборка);
			
		КонецЦикла;
		
		НаборЗаписей.Записать();
		
	КонецЦикла;

КонецПроцедуры

Процедура ОчиститьНДСЗаписиКнигиПродаж(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	УстаревшиеРегистраторы.Регистратор
	|ИЗ
	|	ТекущиеРегистраторыНДСЗаписиКнигиПродаж КАК УстаревшиеРегистраторы
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПродажПоНДСПредъявленный КАК НДСЗаписиКнигиПродажПоНДСПредъявленный
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПродажПоНДСПредъявленный.Регистратор
	|	
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПродажСторноПоИСФ КАК НДСЗаписиКнигиПродажСторноПоИСФ
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПродажСторноПоИСФ.Регистратор
	|
	|	ЛЕВОЕ СОЕДИНЕНИЕ
	|		НДСЗаписиКнигиПродажСохранение КАК НДСЗаписиКнигиПродажСохранение
	|	ПО 
	|		УстаревшиеРегистраторы.Регистратор = НДСЗаписиКнигиПродажСохранение.Регистратор
	|ГДЕ
	|	НДСЗаписиКнигиПродажПоНДСПредъявленный.Регистратор ЕСТЬ NULL
	|	И НДСЗаписиКнигиПродажСторноПоИСФ.Регистратор ЕСТЬ NULL
	|	И НДСЗаписиКнигиПродажСохранение.Регистратор ЕСТЬ NULL
	|";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.УстановитьПараметр("МассивОрганизаций", ПараметрыРасчета.МассивОрганизаций);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	ВыборкаДокумент = Запрос.Выполнить().Выбрать();
	Пока ВыборкаДокумент.Следующий() Цикл
		
		НаборЗаписей = РегистрыНакопления.НДСЗаписиКнигиПродаж.СоздатьНаборЗаписей();
		НаборЗаписей.Отбор.Регистратор.Установить(ВыборкаДокумент.Регистратор);
		НаборЗаписей.Записать(Истина);
		
	КонецЦикла;

КонецПроцедуры

Процедура РассчитатьНДСЗаписиКнигиПродажОплатыСФ(ПараметрыРасчета)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	ДанныеДокумента.Дата КАК Период,
	|	ПодтверждениеОплатыНДСВБюджет.НомерДокументаПеречисленияНалога КАК НомерДокументаОплаты,
	|	ПодтверждениеОплатыНДСВБюджет.ДатаДокументаПеречисленияНалога КАК ДатаДокументаОплаты,
	|	ПодтверждениеОплатыНДСВБюджет.СчетФактура КАК СчетФактура
	|ПОМЕСТИТЬ ВтДанныеОплат
	|ИЗ
	|	Документ.СчетФактураНалоговыйАгент КАК ДанныеДокумента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО ДанныеДокумента.Ссылка = Задания.СчетФактура
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ПодтверждениеОплатыНДСВБюджет КАК ПодтверждениеОплатыНДСВБюджет
	|		ПО ДанныеДокумента.Ссылка = ПодтверждениеОплатыНДСВБюджет.СчетФактура
	|ГДЕ
	|	ДанныеДокумента.ВидАгентскогоДоговора В (ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.Нерезидент), ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.НерезидентЭлектронныеУслуги))
	|	И ПодтверждениеОплатыНДСВБюджет.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияОплатыНДСВБюджет.Оплачено)
	|	И ДанныеДокумента.Дата МЕЖДУ &НачалоПериода И &КонецПериода
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ЕСТЬNULL(СписаниеБезналичныхДенежныхСредств.ДатаВходящегоДокумента, ДанныеПервичныхДокументов.Дата),
	|	ЕСТЬNULL(СписаниеБезналичныхДенежныхСредств.НомерВходящегоДокумента, ДанныеПервичныхДокументов.Номер),
	|	ЕСТЬNULL(СписаниеБезналичныхДенежныхСредств.ДатаВходящегоДокумента, ДанныеПервичныхДокументов.Дата),
	|	ДанныеДокумента.Ссылка
	|ИЗ
	|	Документ.СчетФактураНалоговыйАгент КАК ДанныеДокумента
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Задания КАК Задания
	|		ПО ДанныеДокумента.Ссылка = Задания.СчетФактура
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ДанныеПервичныхДокументов КАК ДанныеПервичныхДокументов
	|		ПО (ДанныеПервичныхДокументов.Документ = ДанныеДокумента.ДокументОснование)
	|			И (ДанныеПервичныхДокументов.Организация = ДанныеДокумента.Организация)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.СписаниеБезналичныхДенежныхСредств КАК СписаниеБезналичныхДенежныхСредств
	|		ПО ДанныеДокумента.ДокументОснование = СписаниеБезналичныхДенежныхСредств.Ссылка
	|ГДЕ
	|	НЕ ДанныеДокумента.ВидАгентскогоДоговора В (ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.Нерезидент), ЗНАЧЕНИЕ(Перечисление.ВидыАгентскихДоговоров.НерезидентЭлектронныеУслуги))
	|	И ЕСТЬNULL(СписаниеБезналичныхДенежныхСредств.ДатаВходящегоДокумента, ДанныеПервичныхДокументов.Дата) МЕЖДУ &НачалоПериода И &КонецПериода
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	2 КАК Приоритет,
	|	ВтДанныеОплат.Период КАК Период,
	|	НДСЗаписиКнигиПродаж.Регистратор КАК Регистратор,
	|	НДСЗаписиКнигиПродаж.Организация КАК Организация,
	|	НДСЗаписиКнигиПродаж.Покупатель КАК Покупатель,
	|	НДСЗаписиКнигиПродаж.СчетФактура КАК СчетФактура,
	|	НДСЗаписиКнигиПродаж.ВидЦенности КАК ВидЦенности,
	|	НДСЗаписиКнигиПродаж.СтавкаНДС КАК СтавкаНДС,
	|	НДСЗаписиКнигиПродаж.ДатаОплаты КАК ДатаОплаты,
	|	НДСЗаписиКнигиПродаж.ДокументОплаты КАК ДокументОплаты,
	|	НДСЗаписиКнигиПродаж.Событие КАК Событие,
	|	НДСЗаписиКнигиПродаж.ДатаСобытия КАК ДатаСобытия,
	|	НДСЗаписиКнигиПродаж.ЗаписьДополнительногоЛиста КАК ЗаписьДополнительногоЛиста,
	|	НДСЗаписиКнигиПродаж.КорректируемыйПериод КАК КорректируемыйПериод,
	|	НДСЗаписиКнигиПродаж.СторнирующаяЗаписьДопЛиста КАК СторнирующаяЗаписьДопЛиста,
	|	НДСЗаписиКнигиПродаж.ДоговорКонтрагента КАК ДоговорКонтрагента,
	|	НДСЗаписиКнигиПродаж.ИсправленныйСчетФактура КАК ИсправленныйСчетФактура,
	|	НДСЗаписиКнигиПродаж.Исправление КАК Исправление,
	|	НДСЗаписиКнигиПродаж.ДатаСчетаФактурыКомиссионера КАК ДатаСчетаФактурыКомиссионера,
	|	0 КАК СуммаБезНДС,
	|	0 КАК НДС,
	|	НДСЗаписиКнигиПродаж.ХозяйственнаяОперация КАК ХозяйственнаяОперация,
	|	НДСЗаписиКнигиПродаж.КодВидаОперации КАК КодВидаОперации,
	|	ИСТИНА КАК РегламентнаяОперация,
	|	НДСЗаписиКнигиПродаж.ВидДеятельностиНДС КАК ВидДеятельностиНДС,
	|	0 КАК НДСУпр,
	|	ВтДанныеОплат.НомерДокументаОплаты КАК НомерДокументаОплаты,
	|	ВтДанныеОплат.ДатаДокументаОплаты КАК ДатаДокументаОплаты
	|ПОМЕСТИТЬ НДСЗаписиКнигиПродажОплатыСФ
	|ИЗ
	|	РегистрНакопления.НДСЗаписиКнигиПродаж КАК НДСЗаписиКнигиПродаж
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ ВтДанныеОплат КАК ВтДанныеОплат
	|		ПО НДСЗаписиКнигиПродаж.Регистратор = ВтДанныеОплат.СчетФактура
	|ГДЕ
	|	НЕ НДСЗаписиКнигиПродаж.РегламентнаяОперация";
	
	Запрос.УстановитьПараметр("НачалоПериода",     ПараметрыРасчета.НачалоПериода);
	Запрос.УстановитьПараметр("КонецПериода",      ПараметрыРасчета.КонецПериода);
	Запрос.МенеджерВременныхТаблиц = ПараметрыРасчета.МенеджерВременныхТаблиц;
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти


#Область ВспомогательныеПроцедурыДляБлокировкиАлгоритмаПриОбновленииИБ

Процедура ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ()
	
	УстановитьПривилегированныйРежим(Истина);
	
	ВходящиеДанные = Новый Соответствие;
	
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.НДСЗаписиКнигиПокупок);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.НДСЗаписиКнигиПродаж);
	ВходящиеДанные.Вставить(Метаданные.РегистрыНакопления.НДСПредъявленный);
	
	ВходящиеДанные.Вставить(Метаданные.Документы.СчетФактураВыданный);
	ВходящиеДанные.Вставить(Метаданные.Документы.СчетФактураНалоговыйАгент);
	ВходящиеДанные.Вставить(Метаданные.Документы.СчетФактураПолученный);
	ВходящиеДанные.Вставить(Метаданные.Документы.СчетФактураПолученныйНалоговыйАгент);
	ВходящиеДанные.Вставить(Метаданные.Документы.ТаможеннаяДекларацияИмпорт);
	ВходящиеДанные.Вставить(Метаданные.Документы.ЗаявлениеОВвозеТоваров);
	
	ЗакрытиеМесяцаСервер.ПроверитьБлокировкуВходящихДанныхПриОбновленииИБ(
		ВходящиеДанные,
		НСтр("ru = 'Формирование записей книг покупок и продаж.'"));
	
КонецПроцедуры

#КонецОбласти

#Область ФормированиеЗаданийПоДаннымКонтрольныхРегистров

Функция КоллекцияКонтрольныхРегистров()
	
	Коллекция = Новый Массив();
	Коллекция.Добавить("НДСПредъявленныйЗадания");
	Коллекция.Добавить("СостоянияБлокировкиВычетаНДСПоСчетамФактурамЗадания");
	
	Возврат Коллекция;
КонецФункции

Процедура ДополнитьТекстЗапросаЗаданий(ИмяТаблицы, Таблицы, ШаблонЗапроса, ТекстЗапроса, ТекстУничтожитьВт)
	Если Таблицы.Найти(ИмяТаблицы) <> Неопределено Тогда
		Если ЗначениеЗаполнено(ТекстЗапроса) Тогда
			ТекстЗапроса = ТекстЗапроса + "
			|
			|ОБЪЕДИНИТЬ ВСЕ
			|";
		КонецЕсли;
		ТекстЗапроса = ТекстЗапроса + СтрЗаменить(ШаблонЗапроса, "&КоллекцияДанных", ИмяТаблицы);
		ТекстУничтожитьВт = ТекстУничтожитьВт + "УНИЧТОЖИТЬ " + ИмяТаблицы + "; ";
	КонецЕсли;
КонецПроцедуры

Процедура ОтразитьЗаданияКФормированиюЗаписейКнигиПокупокПродаж(Документ, ДополнительныеСвойства) Экспорт
	
	Если ПланыОбмена.ГлавныйУзел() <> Неопределено Тогда // задания устанавливаются только в главном узле.
		Возврат;
	КонецЕсли;
	
	КоллекцияКонтрольныхРегистров = КоллекцияКонтрольныхРегистров();
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	ВременныеТаблицы = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	
	ШаблонЗапроса = "
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	Таблица.Месяц        КАК Месяц,
	|	Таблица.Организация  КАК Организация,
	|	Таблица.СчетФактура  КАК СчетФактура
	|ИЗ
	|	&КоллекцияДанных КАК Таблица
	|";
		
	ТекстВложенногоЗапроса = "";
	ТекстУничтожитьВт = "; ";
		
	Для Каждого КонтрольныйРегистр Из КоллекцияКонтрольныхРегистров Цикл
		ДополнитьТекстЗапросаЗаданий(КонтрольныйРегистр, ВременныеТаблицы.Таблицы, ШаблонЗапроса, ТекстВложенногоЗапроса, ТекстУничтожитьВт)
	КонецЦикла;
	
	Если ЗначениеЗаполнено(ТекстВложенногоЗапроса) Тогда // есть хотя бы один контрольный регистр.
		ТекстЗапроса = СтрЗаменить(ШаблонЗапроса, "&КоллекцияДанных", "(" + ТекстВложенногоЗапроса + ")")
			+ ТекстУничтожитьВт;
			
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.МенеджерВременныхТаблиц = ВременныеТаблицы;
		
		Результат = Запрос.Выполнить();
		Если Результат.Пустой() Тогда
			Возврат; // нет данных к записи
		КонецЕсли;
		
		Выборка = Результат.Выбрать();
		Пока Выборка.Следующий() Цикл
			РегистрыСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж.СоздатьЗаписьРегистра(
				Выборка.Месяц,
				Выборка.СчетФактура,
				Выборка.Организация);
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#КонецОбласти

Функция СписокДоступныхВидовДеятельностиНДСПоступления(Знач Дата, ВидДеятельностиНДС, ХозяйственнаяОперация, Организация = Неопределено)
	
	Если Не ЗначениеЗаполнено(Дата) Тогда
		Дата = ТекущаяДатаСеанса();
	КонецЕсли;
	
	ИспользоватьРаздельныйУчет = ПолучитьФункциональнуюОпцию("ИспользоватьРаздельныйУчетПоНалогообложению");
	
	СписокНалогообложений = Новый СписокЗначений;
	
	Если ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию, НСтр("ru = 'По фактическому использованию'"));
	Иначе
		Если ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС 
			ИЛИ ИспользоватьРаздельныйУчет Тогда
			СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС,   НСтр("ru = 'Облагаемую НДС'"));
		КонецЕсли;
		
		Если ВидДеятельностиНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС 
			ИЛИ ИспользоватьРаздельныйУчет Тогда
			СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС, НСтр("ru = 'Не облагаемую НДС'"));
		КонецЕсли;
		
		Если ИспользоватьРаздельныйУчет Тогда
			СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД,  НСтр("ru = 'Облагаемую ЕНВД'"));
		КонецЕсли;
		
		ДоступнаПродажаНаЭкспорт = Константы.ИспользоватьПродажиНаЭкспорт.Получить();
		Если ДоступнаПродажаНаЭкспорт И ИспользоватьРаздельныйУчет Тогда
			Если Дата >= УчетНДСУТ.ДатаНачалаДействия150ФЗ() Тогда
				Если ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортНесырьевыхТоваров") Тогда
					СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров, НСтр("ru = 'Экспорт несырьевых товаров'"));
				КонецЕсли;
				Если ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортСырьевыхТоваровУслуг") Тогда
					СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг, НСтр("ru = 'Экспорт сырьевых товаров, работ'"));
				КонецЕсли;
			Иначе
				СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт, НСтр("ru = 'Экспорт'"));
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если ИспользоватьРаздельныйУчет 
		И (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаТоварыВПути
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаФактуровкаПоставки
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаЧерезПодотчетноеЛицо
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщикаРеглУчет
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭС
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСТоварыВПути
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаВСтранахЕАЭСФактуровкаПоставки
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпорту
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаПоИмпортуТоварыВПути
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыкупТоваровХранящихсяНаСкладе
		ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВыкупТоваровПереданныхВПроизводство) Тогда
		
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением, НСтр("ru = 'Определяется распределением'"));
		
	КонецЕсли;
	
	
	Возврат СписокНалогообложений;
	
КонецФункции

Функция СписокДоступныхВидовДеятельностиНДСПотребления(Организация, Знач Дата, ХозяйственнаяОперация)
	
	Если Не ЗначениеЗаполнено(Дата) Тогда
		Дата = ТекущаяДатаСеанса();
	КонецЕсли;

	ИспользоватьРаздельныйУчет = ПолучитьФункциональнуюОпцию("ИспользоватьРаздельныйУчетПоНалогообложению");
	
	СписокНалогообложений = Новый СписокЗначений;
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПеремещениеТоваров 
			И ИспользоватьРаздельныйУчет Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка(), НСтр("ru = 'Без изменений'"));
	КонецЕсли;
	
	Если (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВПроизводство
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаМатериаловВПроизводство
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаМатериаловВКладовую
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПересортицаТоваров
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПорчаТоваров
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров)
		И ИспользоватьРаздельныйУчет Тогда
		
		ЗакупкаПодДеятельность = Справочники.Организации.ЗакупкаПодДеятельность(
			Организация, 
			Справочники.Склады.ПустаяСсылка(), 
			Дата);
			
		Если ЗакупкаПодДеятельность <> Перечисления.ТипыНалогообложенияНДС.ПоФактическомуИспользованию Тогда
			СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПустаяСсылка(), НСтр("ru = 'Без изменений'"));
		КонецЕсли;
		
	КонецЕсли;
	
	НалогообложениеНДС = Справочники.Организации.НалогообложениеНДС(
			Организация, 
			Справочники.Склады.ПустаяСсылка(), 
			Дата);
	
	Если НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС 
		 ИЛИ ИспользоватьРаздельныйУчет Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС, НСтр("ru = 'Облагаемую НДС'"));
	КонецЕсли;
	Если НалогообложениеНДС = Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС 
		 ИЛИ ИспользоватьРаздельныйУчет Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС, НСтр("ru = 'Не облагаемую НДС'"));
	КонецЕсли;
	
	ДоступнаПродажаЕНВД = Истина;
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров Тогда
		ДоступнаПродажаЕНВД = Ложь;
	КонецЕсли;
	
	Если ДоступнаПродажаЕНВД И ИспользоватьРаздельныйУчет Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД, НСтр("ru = 'Облагаемую ЕНВД'"));
	КонецЕсли;
	
	ДоступнаПродажаНаЭкспорт = Константы.ИспользоватьПродажиНаЭкспорт.Получить();
	
	Если ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваров 
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаПрочиеЦели
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию Тогда
		ДоступнаПродажаНаЭкспорт = Ложь;
	КонецЕсли;
	
	Если ДоступнаПродажаНаЭкспорт И ИспользоватьРаздельныйУчет Тогда
		
		Если Дата >= УчетНДСУТ.ДатаНачалаДействия150ФЗ() Тогда
			Если ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортНесырьевыхТоваров") Тогда
				СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ЭкспортНесырьевыхТоваров, НСтр("ru = 'Экспорт несырьевых товаров'"));
			КонецЕсли;
			Если ПолучитьФункциональнуюОпцию("ИспользоватьПродажиНаЭкспортСырьевыхТоваровУслуг") Тогда
				СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ЭкспортСырьевыхТоваровУслуг, НСтр("ru = 'Экспорт сырьевых товаров, работ'"));
			КонецЕсли;
		Иначе
			СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт, НСтр("ru = 'Экспорт'"));
		КонецЕсли;
		
	КонецЕсли;
	
	Если ИспользоватьРаздельныйУчет
		И (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаУПоставщика
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ЗакупкаЧерезПодотчетноеЛицо 
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.СписаниеТоваровПоТребованию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаВЭксплуатацию) Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ОпределяетсяРаспределением, НСтр("ru = 'Определяется распределением'"));
	КонецЕсли;
	
	
	Возврат СписокНалогообложений;
	
КонецФункции

Функция СписокДоступныхВидовНалогообложенияПродажи(ХозяйственнаяОперация)
	
	СписокНалогообложений = Новый СписокЗначений;
	
	СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяНДС);
	СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНеОблагаетсяНДС);
	
	ДоступнаПродажаЕНВД = 
		НЕ (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ПередачаНаКомиссию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровКомитенту
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратОтКомиссионера);
		
	Если ДоступнаПродажаЕНВД Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаОблагаетсяЕНВД);
	КонецЕсли;
	
	ДоступнаПродажаНаЭкспорт = Константы.ИспользоватьПродажиНаЭкспорт.Получить()
		И (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиенту
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности);
	
	Если ДоступнаПродажаНаЭкспорт Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ПродажаНаЭкспорт);
	КонецЕсли;
	
	ПродажаТоваровОблагаемыхНДСУПокупателя = ПолучитьФункциональнуюОпцию("ПродажаТоваровОблагаемыхНДСУПокупателя")
		И (ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиенту
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияТоваровВДругуюОрганизацию
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияКлиентуРеглУчет
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.РеализацияБезПереходаПраваСобственности
			ИЛИ ХозяйственнаяОперация = Перечисления.ХозяйственныеОперации.ВозвратТоваровПоставщику);
	
	Если ПродажаТоваровОблагаемыхНДСУПокупателя Тогда
		СписокНалогообложений.Добавить(Перечисления.ТипыНалогообложенияНДС.ОблагаетсяНДСУПокупателя);
	КонецЕсли;
	
	Возврат СписокНалогообложений;
	
КонецФункции

Процедура ЗаблокироватьРегистрЗаданий(ПараметрыРасчета)
	
	Блокировка = Новый БлокировкаДанных;
	
	ЭлементБлокировки = Блокировка.Добавить("РегистрСведений.ЗаданияКФормированиюЗаписейКнигиПокупокПродаж");
	ЭлементБлокировки.УстановитьЗначение("НомерЗадания", Новый Диапазон(Неопределено, ПараметрыРасчета.НомерЗадания));
	
	ИсточникБлокировки = Новый ТаблицаЗначений;
	ИсточникБлокировки.Колонки.Добавить("Организация", Новый ОписаниеТипов("СправочникСсылка.Организации"));
	ИсточникБлокировки.Колонки.Добавить("СчетФактура", Новый ОписаниеТипов(Документы.ТипВсеСсылки().Типы()));
	
	Если ПараметрыРасчета.МассивСчетовФактур <> Неопределено Тогда
		ИсточникБлокировки.ЗагрузитьКолонку(ПараметрыРасчета.МассивСчетовФактур, "СчетФактура");
		ЭлементБлокировки.ИсточникДанных = ИсточникБлокировки;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("СчетФактура", "СчетФактура");
	КонецЕсли;
	Если ПараметрыРасчета.МассивОрганизаций <> Неопределено Тогда
		Если ТипЗнч(ПараметрыРасчета.МассивОрганизаций) = Тип("СписокЗначений") Тогда
			ИсточникБлокировки.ЗагрузитьКолонку(ПараметрыРасчета.МассивОрганизаций.ВыгрузитьЗначения(), "Организация");
		ИначеЕсли ТипЗнч(ПараметрыРасчета.МассивОрганизаций) = Тип("СправочникСсылка.Организации") Тогда
			ИсточникБлокировки.ЗагрузитьКолонку(ОбщегоНазначенияКлиентСервер.ЗначениеВМассиве(ПараметрыРасчета.МассивОрганизаций), "Организация");
		Иначе
			ИсточникБлокировки.ЗагрузитьКолонку(ПараметрыРасчета.МассивОрганизаций, "Организация");
		КонецЕсли;
		ЭлементБлокировки.ИсточникДанных = ИсточникБлокировки;
		ЭлементБлокировки.ИспользоватьИзИсточникаДанных("Организация", "Организация");
	КонецЕсли;
	
	ЭлементБлокировки.Режим = РежимБлокировкиДанных.Исключительный;
	
	Блокировка.Заблокировать();
	
КонецПроцедуры

Функция СписокВидовЦенностейСвязанныхСОплатой()
	
	СписокВидовЦенностейОплаты = Новый СписокЗначений;
	
	СписокВидовЦенностейОплаты.Добавить(Перечисления.ВидыЦенностей.АвансыВыданные);
	СписокВидовЦенностейОплаты.Добавить(Перечисления.ВидыЦенностей.АвансыПолученные);
	СписокВидовЦенностейОплаты.Добавить(Перечисления.ВидыЦенностей.АвансыПолученные0);
	СписокВидовЦенностейОплаты.Добавить(Перечисления.ВидыЦенностей.ВозвратАвансовПолученных);
	
	Возврат СписокВидовЦенностейОплаты;
	
КонецФункции

#Область ОбщиеПроцедурыФормСчетФактур

Процедура ЗаполнитьЗависимыеОтКонтрагентаРеквизитыФормы(Форма, ДатаСведений, ИзменятьИННКПП = Ложь) Экспорт
	
	Форма.КонтрагентЮрЛицо                        = Ложь;
	Форма.НеобходимоЗаполнитьГоловногоКонтрагента = Ложь;
	
	Форма.СписокВыбораКПП.Очистить();
	
	Если ЗначениеЗаполнено(Форма.Объект.Контрагент) И ТипЗнч(Форма.Объект.Контрагент) = Тип("СправочникСсылка.Контрагенты") Тогда
		
		РеквизитыКлиента = Справочники.Контрагенты.РеквизитыКонтрагента(Форма.Объект.Контрагент, ДатаСведений);
		
		Форма.НеобходимоЗаполнитьГоловногоКонтрагента = (РеквизитыКлиента.ОбособленноеПодразделение = Истина
			И Не ЗначениеЗаполнено(РеквизитыКлиента.ГоловнойКонтрагент));
		Форма.КонтрагентЮрЛицо = (РеквизитыКлиента.ЮрФизЛицо = Перечисления.ЮрФизЛицо.ЮрЛицо);
		
		Если ИзменятьИННКПП Тогда
			Форма.Объект.ИННКонтрагента = РеквизитыКлиента.ИНН;
			Форма.Объект.КППКонтрагента = РеквизитыКлиента.КПП;
		КонецЕсли;
		
	Иначе
		
		Форма.Объект.ИННКонтрагента = "";
		Форма.Объект.КППКонтрагента = "";
		
	КонецЕсли;
	
КонецПроцедуры

Процедура ЗаполнитьСписокВыбораКППСчетФактурыВыданные(СписокВыбора, Контрагент, ДатаСведений) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("ДатаСведений", ДатаСведений);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ КонтрагентыХолдинга
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.Ссылка = &Контрагент
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	НЕ Контрагенты.Ссылка = &Контрагент
	|	И Контрагенты.ГоловнойКонтрагент = &Контрагент
	|	И Контрагенты.ОбособленноеПодразделение
	|	И НЕ Контрагенты.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	МАКСИМУМ(ИсторияКППКонтрагентов.Период) КАК Период,
	|	ИсторияКППКонтрагентов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ЗначенияКПП
	|ИЗ
	|	Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
	|ГДЕ
	|	ИсторияКППКонтрагентов.Ссылка  В (ВЫБРАТЬ РАЗЛИЧНЫЕ КонтрагентыХолдинга.Ссылка ИЗ КонтрагентыХолдинга КАК КонтрагентыХолдинга)
	|	И ИсторияКППКонтрагентов.Период <= &ДатаСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсторияКППКонтрагентов.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ИсторияКППКонтрагентов.КПП КАК КПП,
	|	ИсторияКППКонтрагентов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ИсторическоеЗначениеКПП
	|ИЗ
	|	ЗначенияКПП КАК ЗначенияКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
	|		ПО ЗначенияКПП.Ссылка = ИсторияКППКонтрагентов.Ссылка
	|			И ЗначенияКПП.Период = ИсторияКППКонтрагентов.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ЕСТЬNULL(ИсторическоеЗначениеКПП.КПП, Контрагенты.КПП) КАК КПП,
	|	Контрагенты.Представление КАК ПредставлениеКонтрагента
	|ПОМЕСТИТЬ ДанныеКонтрагентов
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыХолдинга КАК КонтрагентыХолдинга
	|			ПО Контрагенты.Ссылка = КонтрагентыХолдинга.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИсторическоеЗначениеКПП КАК ИсторическоеЗначениеКПП
	|			ПО ИсторическоеЗначениеКПП.Ссылка = Контрагенты.Ссылка
	|ИНДЕКСИРОВАТЬ ПО
	|	КПП
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ 
	|	СчетФактураВыданный.КППКонтрагента КАК КПП
	|ПОМЕСТИТЬ ДанныеСчетовФактуры
	|ИЗ
	|	Документ.СчетФактураВыданный КАК СчетФактураВыданный
	|ГДЕ
	|	СчетФактураВыданный.Контрагент = &Контрагент
	|	И СчетФактураВыданный.Проведен
	|	И НЕ СчетФактураВыданный.КППКонтрагента = """"
	|	И НЕ СчетФактураВыданный.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	СчетФактураВыданныйАванс.КППКонтрагента КАК КПП
	|ИЗ
	|	Документ.СчетФактураВыданныйАванс КАК СчетФактураВыданныйАванс
	|ГДЕ
	|	СчетФактураВыданныйАванс.Контрагент = &Контрагент
	|	И СчетФактураВыданныйАванс.Проведен
	|	И НЕ СчетФактураВыданныйАванс.КППКонтрагента = """"
	|	И НЕ СчетФактураВыданныйАванс.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ
	|	СчетФактураКомиссионеру.КПППокупателя
	|ИЗ
	|	Документ.СчетФактураКомиссионеру.Покупатели КАК СчетФактураКомиссионеру
	|ГДЕ
	|	СчетФактураКомиссионеру.Покупатель = &Контрагент
	|	И СчетФактураКомиссионеру.Ссылка.Проведен
	|	И НЕ СчетФактураКомиссионеру.КПППокупателя = """"
	|	И НЕ СчетФактураКомиссионеру.КПППокупателя В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеКонтрагентов.КПП КАК КПП,
	|	ДанныеКонтрагентов.ПредставлениеКонтрагента КАК ПредставлениеКонтрагента
	|ИЗ
	|	ДанныеКонтрагентов КАК ДанныеКонтрагентов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеСчетовФактуры.КПП,
	|	""""
	|ИЗ
	|	ДанныеСчетовФактуры КАК ДанныеСчетовФактуры";
	

	СписокВыбора.Очистить();
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока Выборка.Следующий() Цикл
		ПредставлениеКПП = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("%1 %2",
			?(ПустаяСтрока(Выборка.КПП), Нстр("ru = '<не задан>'"), Выборка.КПП),
			?(ПустаяСтрока(Выборка.ПредставлениеКонтрагента), "", "(" + Выборка.ПредставлениеКонтрагента + ")"));
		СписокВыбора.Добавить(Выборка.КПП, ПредставлениеКПП);
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьСписокВыбораКППСчетФактурыПолученные(СписокВыбора, Контрагент, ДатаСведений) Экспорт
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("Контрагент", Контрагент);
	Запрос.УстановитьПараметр("ДатаСведений", ДатаСведений);
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	Контрагенты.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ КонтрагентыХолдинга
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	Контрагенты.Ссылка = &Контрагент
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	Контрагенты.Ссылка
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|ГДЕ
	|	НЕ Контрагенты.Ссылка = &Контрагент
	|	И Контрагенты.ГоловнойКонтрагент = &Контрагент
	|	И Контрагенты.ОбособленноеПодразделение
	|	И НЕ Контрагенты.ПометкаУдаления
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ 
	|	МАКСИМУМ(ИсторияКППКонтрагентов.Период) КАК Период,
	|	ИсторияКППКонтрагентов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ЗначенияКПП
	|ИЗ
	|	Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
	|ГДЕ
	|	ИсторияКППКонтрагентов.Ссылка  В (ВЫБРАТЬ РАЗЛИЧНЫЕ КонтрагентыХолдинга.Ссылка ИЗ КонтрагентыХолдинга КАК КонтрагентыХолдинга)
	|	И ИсторияКППКонтрагентов.Период <= &ДатаСведений
	|
	|СГРУППИРОВАТЬ ПО
	|	ИсторияКППКонтрагентов.Ссылка
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	ИсторияКППКонтрагентов.КПП КАК КПП,
	|	ИсторияКППКонтрагентов.Ссылка КАК Ссылка
	|ПОМЕСТИТЬ ИсторическоеЗначениеКПП
	|ИЗ
	|	ЗначенияКПП КАК ЗначенияКПП
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
	|		ПО ЗначенияКПП.Ссылка = ИсторияКППКонтрагентов.Ссылка
	|			И ЗначенияКПП.Период = ИсторияКППКонтрагентов.Период
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ 
	|	ЕСТЬNULL(ИсторическоеЗначениеКПП.КПП, Контрагенты.КПП) КАК КПП,
	|	Контрагенты.Представление КАК ПредставлениеКонтрагента
	|ПОМЕСТИТЬ ДанныеКонтрагентов
	|ИЗ
	|	Справочник.Контрагенты КАК Контрагенты
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ КонтрагентыХолдинга КАК КонтрагентыХолдинга
	|			ПО Контрагенты.Ссылка = КонтрагентыХолдинга.Ссылка
	|		ЛЕВОЕ СОЕДИНЕНИЕ ИсторическоеЗначениеКПП КАК ИсторическоеЗначениеКПП
	|			ПО ИсторическоеЗначениеКПП.Ссылка = Контрагенты.Ссылка
	|ИНДЕКСИРОВАТЬ ПО
	|	КПП
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ 
	|	СчетФактураПолученный.КППКонтрагента КАК КПП
	|ПОМЕСТИТЬ ДанныеСчетовФактуры
	|ИЗ
	|	Документ.СчетФактураПолученный КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Контрагент = &Контрагент
	|	И СчетФактураПолученный.Проведен
	|	И НЕ СчетФактураПолученный.КППКонтрагента = """"
	|	И НЕ СчетФактураПолученный.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	СчетФактураПолученный.КППКонтрагента КАК КПП
	|ИЗ
	|	Документ.СчетФактураПолученныйНалоговыйАгент КАК СчетФактураПолученный
	|ГДЕ
	|	СчетФактураПолученный.Контрагент = &Контрагент
	|	И СчетФактураПолученный.Проведен
	|	И НЕ СчетФактураПолученный.КППКонтрагента = """"
	|	И НЕ СчетФактураПолученный.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	СчетФактураПолученныйАванс.КППКонтрагента КАК КПП
	|ИЗ
	|	Документ.СчетФактураПолученныйАванс КАК СчетФактураПолученныйАванс
	|ГДЕ
	|	СчетФактураПолученныйАванс.Контрагент = &Контрагент
	|	И СчетФактураПолученныйАванс.Проведен
	|	И НЕ СчетФактураПолученныйАванс.КППКонтрагента = """"
	|	И НЕ СчетФактураПолученныйАванс.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	ЗаписьКнигиПокупок.КППКонтрагента КАК КПП
	|ИЗ
	|	Документ.ЗаписьКнигиПокупок КАК ЗаписьКнигиПокупок
	|ГДЕ
	|	ЗаписьКнигиПокупок.Контрагент = &Контрагент
	|	И ЗаписьКнигиПокупок.Проведен
	|	И НЕ ЗаписьКнигиПокупок.КППКонтрагента = """"
	|	И НЕ ЗаписьКнигиПокупок.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	СчетФактураНаНеподтвержденнуюРеализацию0.КППКонтрагента КАК КПП
	|ИЗ
	|	Документ.СчетФактураНаНеподтвержденнуюРеализацию0 КАК СчетФактураНаНеподтвержденнуюРеализацию0
	|ГДЕ
	|	СчетФактураНаНеподтвержденнуюРеализацию0.Контрагент = &Контрагент
	|	И СчетФактураНаНеподтвержденнуюРеализацию0.Проведен
	|	И НЕ СчетФактураНаНеподтвержденнуюРеализацию0.КППКонтрагента = """"
	|	И НЕ СчетФактураНаНеподтвержденнуюРеализацию0.КППКонтрагента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|
	|ОБЪЕДИНИТЬ
	|
	|ВЫБРАТЬ 
	|	СчетФактураКомитента.КППКомитента КАК КПП
	|ИЗ
	|	Документ.СчетФактураКомитента КАК СчетФактураКомитента
	|ГДЕ
	|	СчетФактураКомитента.Комитент = &Контрагент
	|	И СчетФактураКомитента.Проведен
	|	И НЕ СчетФактураКомитента.КППКомитента = """"
	|	И НЕ СчетФактураКомитента.КППКомитента В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ
	|	СчетФактураКомитентаПокупатели.КППСубкомиссионера
	|ИЗ
	|	Документ.СчетФактураКомитента.Покупатели КАК СчетФактураКомитентаПокупатели
	|ГДЕ
	|	СчетФактураКомитентаПокупатели.Покупатель = &Контрагент
	|	И СчетФактураКомитентаПокупатели.Ссылка.Проведен
	|	И НЕ СчетФактураКомитентаПокупатели.КППСубкомиссионера = """"
	|	И НЕ СчетФактураКомитентаПокупатели.КППСубкомиссионера В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ
	|	СчетФактураПолученныйПродавцы.КПППродавца
	|ИЗ
	|	Документ.СчетФактураПолученный.Продавцы КАК СчетФактураПолученныйПродавцы
	|ГДЕ
	|	СчетФактураПолученныйПродавцы.Продавец = &Контрагент
	|	И СчетФактураПолученныйПродавцы.Ссылка.Проведен
	|	И НЕ СчетФактураПолученныйПродавцы.КПППродавца = """"
	|	И НЕ СчетФактураПолученныйПродавцы.КПППродавца В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|	
	|ОБЪЕДИНИТЬ
	|	
	|ВЫБРАТЬ
	|	СчетФактураПолученныйАвансПродавцы.КПППродавца
	|ИЗ
	|	Документ.СчетФактураПолученныйАванс.Продавцы КАК СчетФактураПолученныйАвансПродавцы
	|ГДЕ
	|	СчетФактураПолученныйАвансПродавцы.Продавец = &Контрагент
	|	И СчетФактураПолученныйАвансПродавцы.Ссылка.Проведен
	|	И НЕ СчетФактураПолученныйАвансПродавцы.КПППродавца = """"
	|	И НЕ СчетФактураПолученныйАвансПродавцы.КПППродавца В
	|				(ВЫБРАТЬ
	|					ДанныеКонтрагентов.КПП
	|				ИЗ
	|					ДанныеКонтрагентов КАК ДанныеКонтрагентов)
	|;
	|
	|////////////////////////////////////////////////////////////////////////////////
	|ВЫБРАТЬ
	|	ДанныеКонтрагентов.КПП КАК КПП,
	|	ДанныеКонтрагентов.ПредставлениеКонтрагента КАК ПредставлениеКонтрагента
	|ИЗ
	|	ДанныеКонтрагентов КАК ДанныеКонтрагентов
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	ДанныеСчетовФактуры.КПП,
	|	""""
	|ИЗ
	|	ДанныеСчетовФактуры КАК ДанныеСчетовФактуры";
	

	СписокВыбора.Очистить();
	
	УстановитьПривилегированныйРежим(Истина);
	Выборка = Запрос.Выполнить().Выбрать();
	УстановитьПривилегированныйРежим(Ложь);
	
	Пока Выборка.Следующий() Цикл
		ПредставлениеКПП = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку("%1 %2",
			?(ПустаяСтрока(Выборка.КПП), Нстр("ru = '<не задан>'"), Выборка.КПП),
			?(ПустаяСтрока(Выборка.ПредставлениеКонтрагента), "", "(" + Выборка.ПредставлениеКонтрагента + ")"));
		СписокВыбора.Добавить(Выборка.КПП, ПредставлениеКПП);
	КонецЦикла;
	
КонецПроцедуры

Процедура ЗаполнитьПродавцов(Форма, СписокПродавцов, ДатаСведений, ПолучатьИННКПП = Ложь) Экспорт
	
	Форма.Объект.Продавцы.Очистить();
	Для Каждого Элемент Из СписокПродавцов Цикл
		НоваяСтрока = Форма.Объект.Продавцы.Добавить();
		Если ТипЗнч(Элемент.Значение) = Тип("Структура") Тогда
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Элемент.Значение);
		Иначе
			НоваяСтрока.Продавец = Элемент.Значение;
		КонецЕсли;
	КонецЦикла;
	
	Если ПолучатьИННКПП Тогда
		
		Продавцы = Новый Массив;
		Для каждого Строка Из Форма.Объект.Продавцы Цикл
			Если ЗначениеЗаполнено(Строка.Продавец) Тогда
				Продавцы.Добавить(Строка.Продавец);
			КонецЕсли;
		КонецЦикла;
		
		Запрос = Новый Запрос;
		Запрос.Текст = "
		|ВЫБРАТЬ РАЗРЕШЕННЫЕ
		|	МАКСИМУМ(ИсторияКППКонтрагентов.Период) КАК Период,
		|	ИсторияКППКонтрагентов.Ссылка           КАК Ссылка
		|ПОМЕСТИТЬ ЗначенияКПП
		|ИЗ
		|	Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
		|ГДЕ
		|	ИсторияКППКонтрагентов.Ссылка  В (&Контрагенты)
		|	И ИсторияКППКонтрагентов.Период <= &ДатаСведений
		|
		|СГРУППИРОВАТЬ ПО
		|	ИсторияКППКонтрагентов.Ссылка
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	ИсторияКППКонтрагентов.КПП    КАК КПП,
		|	ИсторияКППКонтрагентов.Ссылка КАК Ссылка
		|ПОМЕСТИТЬ ИсторическоеЗначениеКПП
		|ИЗ
		|	ЗначенияКПП КАК ЗначенияКПП
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.Контрагенты.ИсторияКПП КАК ИсторияКППКонтрагентов
		|		ПО ЗначенияКПП.Ссылка = ИсторияКППКонтрагентов.Ссылка
		|			И ЗначенияКПП.Период = ИсторияКППКонтрагентов.Период
		|;
		|
		|////////////////////////////////////////////////////////////////////////////////
		|
		|ВЫБРАТЬ
		|	Контрагенты.Ссылка                                     КАК Продавец,
		|	ЕСТЬNULL(ИсторическоеЗначениеКПП.КПП, Контрагенты.КПП) КАК КПППродавца,
		|	Контрагенты.ИНН                                        КАК ИННПродавца,
		|	ВЫБОР
		|		КОГДА Контрагенты.ЮрФизЛицо = ЗНАЧЕНИЕ(Перечисление.ЮрФизЛицо.ЮрЛицо)
		|			ТОГДА ИСТИНА
		|		ИНАЧЕ ЛОЖЬ
		|	КОНЕЦ                                                 КАК ЮрЛицо
		|ИЗ
		|	Справочник.Контрагенты КАК Контрагенты
		|	ЛЕВОЕ СОЕДИНЕНИЕ ИсторическоеЗначениеКПП КАК ИсторическоеЗначениеКПП
		|		ПО ИсторическоеЗначениеКПП.Ссылка = Контрагенты.Ссылка
		|ГДЕ
		|	Контрагенты.Ссылка В (&Контрагенты)
		|";
		
		Запрос.УстановитьПараметр("Контрагенты",  Продавцы);
		Запрос.УстановитьПараметр("ДатаСведений", ДатаСведений);
		
		Форма.Объект.Продавцы.Загрузить(Запрос.Выполнить().Выгрузить());
		
	КонецЕсли;
	
	ДокументОбъект = Форма.РеквизитФормыВЗначение("Объект");
	ДокументОбъект.ЗаполнитьКодВидаОперации();
	Форма.ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
	
КонецПроцедуры

Процедура НастроитьСовместныйВыборКонтрагентовОрганизаций(Элемент, Контрагент = Null) Экспорт

	Если ПолучитьФункциональнуюОпцию("ИспользоватьПередачиТоваровМеждуОрганизациями") Тогда
		Если Контрагент = Неопределено Тогда
			Контрагент = Справочники.Контрагенты.ПустаяСсылка();
		КонецЕсли;
		НовыйМассив = Новый Массив();
		НовыйМассив.Добавить(Новый ПараметрВыбора("ВыборКонтрагентовИОрганизаций", Истина));
		Элемент.ПараметрыВыбора = Новый ФиксированныйМассив(НовыйМассив);
 	Иначе
		Элемент.ОграничениеТипа = Новый ОписаниеТипов("СправочникСсылка.Контрагенты");	
		Элемент.ВыбиратьТип = Ложь;
	КонецЕсли;
	
КонецПроцедуры	

#КонецОбласти

#КонецОбласти
