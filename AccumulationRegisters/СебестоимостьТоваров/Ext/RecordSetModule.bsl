#Если Сервер Или ТолстыйКлиентОбычноеПриложение Или ВнешнееСоединение Тогда

#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, Замещение)
	
	Если ОбменДанными.Загрузка
		ИЛИ УниверсальныеМеханизмыПартийИСебестоимости.ДвиженияЗаписываютсяРасчетомПартийИСебестоимости(ЭтотОбъект) Тогда
		
		Если ДополнительныеСвойства.Свойство("ДополнитьДвижениямиИзИБЗаПериод") Тогда
			
			ДополнительныеСвойства.Вставить("ТочноНужноСохранитьДвижения");
			
			// Сохраним неизмененные первичные движения.
			СохранитьНеИзмененныеПервичныеДвижения();
			
			// Сохраним расчетные движения за периоды, в которых есть первичные движения.
			УниверсальныеМеханизмыПартийИСебестоимости.СохранитьДвиженияСформированныеРасчетомПартийИСебестоимости(ЭтотОбъект, Замещение);
			
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	ОбновлениеИнформационнойБазы.ПроверитьОбъектОбработан(ЭтотОбъект);
	
	// Сохраним неизмененные первичные движения.
	СохранитьНеИзмененныеПервичныеДвижения();
	
	// Сохраним расчетные движения за периоды, в которых есть первичные движения.
	УниверсальныеМеханизмыПартийИСебестоимости.СохранитьДвиженияСформированныеРасчетомПартийИСебестоимости(ЭтотОбъект, Замещение);
	
	Если ПланыОбмена.ГлавныйУзел() <> Неопределено
	 ИЛИ НЕ ДополнительныеСвойства.Свойство("ДляПроведения") Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.Текст =
	"ВЫБРАТЬ
	|	*
	|ПОМЕСТИТЬ СебестоимостьТоваровПередЗаписью
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
	|ГДЕ
	|	Себестоимость.Регистратор = &Регистратор";
	
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	
	Запрос.МенеджерВременныхТаблиц = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Регистратор", Отбор.Регистратор.Значение);
	
	Запрос.Выполнить();
	
КонецПроцедуры

Процедура ПриЗаписи(Отказ, Замещение)
	
	Если ОбменДанными.Загрузка
	 ИЛИ НЕ ДополнительныеСвойства.Свойство("ДляПроведения")
	 ИЛИ ПланыОбмена.ГлавныйУзел() <> Неопределено
	 ИЛИ УниверсальныеМеханизмыПартийИСебестоимости.ДвиженияЗаписываютсяРасчетомПартийИСебестоимости(ЭтотОбъект) Тогда
		Возврат;
	КонецЕсли;
	
	Запрос = Новый Запрос("
	|ВЫБРАТЬ РАЗЛИЧНЫЕ
	|	НАЧАЛОПЕРИОДА(Таблица.Период, МЕСЯЦ) КАК Месяц,
	|	Таблица.Организация                  КАК Организация,
	|	Таблица.Регистратор                  КАК Документ,
	|	ЛОЖЬ                                 КАК ИзмененыДанныеДляПартионногоУчетаВерсии21
	|ПОМЕСТИТЬ СебестоимостьТоваровЗаданияКРасчетуСебестоимости
	|ИЗ
	|	(ВЫБРАТЬ
	|		Себестоимость.Период                        КАК Период,
	|		Себестоимость.Регистратор                   КАК Регистратор,
	|		Себестоимость.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|		Себестоимость.РазделУчета                   КАК РазделУчета,
	|		Себестоимость.ВидЗапасов                    КАК ВидЗапасов,
	|		Себестоимость.Организация                   КАК Организация,
	|		Себестоимость.Партия                   		КАК Партия,
	|		Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|		Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|		Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|
	|		Себестоимость.Количество             		КАК Количество,
	|		Себестоимость.Стоимость              		КАК Стоимость,
	|		Себестоимость.СтоимостьБезНДС        		КАК СтоимостьБезНДС,
	|		Себестоимость.ДопРасходы       				КАК ДопРасходы,
	|		Себестоимость.ДопРасходыБезНДС 				КАК ДопРасходыБезНДС,
	|		Себестоимость.СтоимостьРегл          		КАК СтоимостьРегл,
	|		Себестоимость.ПостояннаяРазница      		КАК ПостояннаяРазница,
	|		Себестоимость.ВременнаяРазница       		КАК ВременнаяРазница,
	|		Себестоимость.СтоимостьЗабалансовая       	КАК СтоимостьЗабалансовая,
	|		Себестоимость.Трудозатраты       			КАК Трудозатраты,
	|		Себестоимость.ПостатейныеПостоянныеСНДС     КАК ПостатейныеПостоянныеСНДС,
	|		Себестоимость.ПостатейныеПеременныеСНДС		КАК ПостатейныеПеременныеСНДС,
	|		Себестоимость.ПостатейныеПостоянныеБезНДС   КАК ПостатейныеПостоянныеБезНДС,
	|		Себестоимость.ПостатейныеПеременныеБезНДС   КАК ПостатейныеПеременныеБезНДС,
	|		Себестоимость.СтоимостьЗабалансоваяРегл     КАК СтоимостьЗабалансоваяРегл,
	|		Себестоимость.ДопРасходыРегл       			КАК ДопРасходыРегл,
	|		Себестоимость.ТрудозатратыРегл       		КАК ТрудозатратыРегл,
	|		Себестоимость.ПостатейныеПостоянныеРегл     КАК ПостатейныеПостоянныеРегл,
	|		Себестоимость.ПостатейныеПеременныеРегл     КАК ПостатейныеПеременныеРегл,
	|		Себестоимость.СтоимостьУпр             		КАК СтоимостьУпр,
	|		Себестоимость.ДопРасходыУпр    				КАК ДопРасходыУпр,
	|		Себестоимость.ТрудозатратыУпр     			КАК ТрудозатратыУпр,
	|		Себестоимость.ПостатейныеПостоянныеУпр		КАК ПостатейныеПостоянныеУпр,
	|		Себестоимость.ПостатейныеПеременныеУпр		КАК ПостатейныеПеременныеУпр,
	|
	|		ВЫБОР КОГДА Себестоимость.Количество > 0
	|			ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ КАК Знак,
	|
	|		Себестоимость.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|		Себестоимость.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Себестоимость.КорРазделУчета                КАК КорРазделУчета,
	|		Себестоимость.КорВидЗапасов                 КАК КорВидЗапасов,
	|		Себестоимость.КорОрганизация                КАК КорОрганизация,
	|		Себестоимость.КорСтоимость                  КАК КорСтоимость,
	|		Себестоимость.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|		Себестоимость.ЗаказКлиента                  КАК ЗаказКлиента,
	|		Себестоимость.Подразделение                 КАК Подразделение,
	|		Себестоимость.АналитикаРасходов             КАК АналитикаРасходов,
	|		Себестоимость.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|		Себестоимость.СтатьяДоходов                 КАК СтатьяДоходов,
	|		Себестоимость.АналитикаДоходов              КАК АналитикаДоходов,
	|		Себестоимость.ПериодПродажи                 КАК ПериодПродажи,
	|		Себестоимость.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|		Себестоимость.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|		Себестоимость.ДокументДвижения              КАК ДокументДвижения,
	|		Себестоимость.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|		Себестоимость.ГруппаПродукции           	КАК ГруппаПродукции,
	|		Себестоимость.КорПартия           			КАК КорПартия,
	|		Себестоимость.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|		Себестоимость.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|		Себестоимость.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|		Себестоимость.НДСРегл           			КАК НДСРегл,
	|		Себестоимость.НДСУпр           				КАК НДСУпр,
	|		Себестоимость.СтатьяКалькуляции           	КАК СтатьяКалькуляции,
	|		Себестоимость.ТипЗаписи           			КАК ТипЗаписи,
	|		Себестоимость.ДокументИсточник           	КАК ДокументИсточник
	|	ИЗ
	|		СебестоимостьТоваровПередЗаписью КАК Себестоимость
	|		
	|	ОБЪЕДИНИТЬ ВСЕ
	|	
	|	ВЫБРАТЬ
	|		Себестоимость.Период                        КАК Период,
	|		Себестоимость.Регистратор                   КАК Регистратор,
	|		Себестоимость.АналитикаУчетаНоменклатуры    КАК АналитикаУчетаНоменклатуры,
	|		Себестоимость.РазделУчета                   КАК РазделУчета,
	|		Себестоимость.ВидЗапасов                    КАК ВидЗапасов,
	|		Себестоимость.Организация                   КАК Организация,
	|		Себестоимость.Партия                   		КАК Партия,
	|		Себестоимость.АналитикаУчетаПартий          КАК АналитикаУчетаПартий,
	|		Себестоимость.АналитикаФинансовогоУчета     КАК АналитикаФинансовогоУчета,
	|		Себестоимость.ВидДеятельностиНДС            КАК ВидДеятельностиНДС,
	|
	|		-Себестоимость.Количество             		КАК Количество,
	|		-Себестоимость.Стоимость              		КАК Стоимость,
	|		-Себестоимость.СтоимостьБезНДС        		КАК СтоимостьБезНДС,
	|		-Себестоимость.ДопРасходы       			КАК ДопРасходы,
	|		-Себестоимость.ДопРасходыБезНДС 			КАК ДопРасходыБезНДС,
	|		-Себестоимость.СтоимостьРегл          		КАК СтоимостьРегл,
	|		-Себестоимость.ПостояннаяРазница      		КАК ПостояннаяРазница,
	|		-Себестоимость.ВременнаяРазница       		КАК ВременнаяРазница,
	|		-Себестоимость.СтоимостьЗабалансовая       	КАК СтоимостьЗабалансовая,
	|		-Себестоимость.Трудозатраты       			КАК Трудозатраты,
	|		-Себестоимость.ПостатейныеПостоянныеСНДС    КАК ПостатейныеПостоянныеСНДС,
	|		-Себестоимость.ПостатейныеПеременныеСНДС    КАК ПостатейныеПеременныеСНДС,
	|		-Себестоимость.ПостатейныеПостоянныеБезНДС  КАК ПостатейныеПостоянныеБезНДС,
	|		-Себестоимость.ПостатейныеПеременныеБезНДС  КАК ПостатейныеПеременныеБезНДС,
	|		-Себестоимость.СтоимостьЗабалансоваяРегл    КАК СтоимостьЗабалансоваяРегл,
	|		-Себестоимость.ДопРасходыРегл       		КАК ДопРасходыРегл,
	|		-Себестоимость.ТрудозатратыРегл       		КАК ТрудозатратыРегл,
	|		-Себестоимость.ПостатейныеПостоянныеРегл    КАК ПостатейныеПостоянныеРегл,
	|		-Себестоимость.ПостатейныеПеременныеРегл    КАК ПостатейныеПеременныеРегл,
	|		-Себестоимость.СтоимостьУпр            		КАК СтоимостьУпр,
	|		-Себестоимость.ДопРасходыУпр       			КАК ДопРасходыУпр,
	|		-Себестоимость.ТрудозатратыУпр     			КАК ТрудозатратыУпр,
	|		-Себестоимость.ПостатейныеПостоянныеУпр		КАК ПостатейныеПостоянныеУпр,
	|		-Себестоимость.ПостатейныеПеременныеУпр		КАК ПостатейныеПеременныеУпр,
	|
	|		ВЫБОР КОГДА Себестоимость.Количество > 0
	|			ТОГДА 1
	|			ИНАЧЕ -1
	|		КОНЕЦ КАК Знак,
	|
	|		Себестоимость.ХозяйственнаяОперация         КАК ХозяйственнаяОперация,
	|		Себестоимость.КорАналитикаУчетаНоменклатуры КАК КорАналитикаУчетаНоменклатуры,
	|		Себестоимость.КорРазделУчета                КАК КорРазделУчета,
	|		Себестоимость.КорВидЗапасов                 КАК КорВидЗапасов,
	|		Себестоимость.КорОрганизация                КАК КорОрганизация,
	|		Себестоимость.КорСтоимость                  КАК КорСтоимость,
	|		Себестоимость.АналитикаУчетаПоПартнерам     КАК АналитикаУчетаПоПартнерам,
	|		Себестоимость.ЗаказКлиента                  КАК ЗаказКлиента,
	|		Себестоимость.Подразделение                 КАК Подразделение,
	|		Себестоимость.АналитикаРасходов             КАК АналитикаРасходов,
	|		Себестоимость.СтатьяРасходовСписания        КАК СтатьяРасходовСписания,
	|		Себестоимость.СтатьяДоходов                 КАК СтатьяДоходов,
	|		Себестоимость.АналитикаДоходов              КАК АналитикаДоходов,
	|		Себестоимость.ПериодПродажи                 КАК ПериодПродажи,
	|		Себестоимость.СтатьяАктивовПассивов         КАК СтатьяАктивовПассивов,
	|		Себестоимость.АналитикаАктивовПассивов      КАК АналитикаАктивовПассивов,
	|		Себестоимость.ДокументДвижения              КАК ДокументДвижения,
	|		Себестоимость.ИдентификаторСтроки           КАК ИдентификаторСтроки,
	|		Себестоимость.ГруппаПродукции           	КАК ГруппаПродукции,
	|		Себестоимость.КорПартия           			КАК КорПартия,
	|		Себестоимость.КорАналитикаУчетаПартий       КАК КорАналитикаУчетаПартий,
	|		Себестоимость.КорАналитикаФинансовогоУчета  КАК КорАналитикаФинансовогоУчета,
	|		Себестоимость.КорВидДеятельностиНДС         КАК КорВидДеятельностиНДС,
	|		Себестоимость.НДСРегл           			КАК НДСРегл,
	|		Себестоимость.НДСУпр           				КАК НДСУпр,
	|		Себестоимость.СтатьяКалькуляции           	КАК СтатьяКалькуляции,
	|		Себестоимость.ТипЗаписи           			КАК ТипЗаписи,
	|		Себестоимость.ДокументИсточник           	КАК ДокументИсточник
	|	ИЗ
	|		РегистрНакопления.СебестоимостьТоваров КАК Себестоимость
	|	ГДЕ
	|		Себестоимость.Регистратор = &Регистратор
	|	) КАК Таблица
	|
	|СГРУППИРОВАТЬ ПО
	|	НАЧАЛОПЕРИОДА(Таблица.Период, МЕСЯЦ),
	|	Таблица.Период,
	|	Таблица.Регистратор,
	|	Таблица.АналитикаУчетаНоменклатуры,
	|	Таблица.РазделУчета,
	|	Таблица.ВидЗапасов,
	|	Таблица.Организация,
	|	Таблица.Партия,
	|	Таблица.АналитикаУчетаПартий,
	|	Таблица.АналитикаФинансовогоУчета,
	|	Таблица.ВидДеятельностиНДС,
	|	Таблица.ХозяйственнаяОперация,
	|	Таблица.КорАналитикаУчетаНоменклатуры,
	|	Таблица.КорРазделУчета,
	|	Таблица.КорВидЗапасов,
	|	Таблица.КорОрганизация,
	|	Таблица.КорСтоимость,
	|	Таблица.АналитикаУчетаПоПартнерам,
	|	Таблица.ЗаказКлиента,
	|	Таблица.Подразделение,
	|	Таблица.АналитикаРасходов,
	|	Таблица.СтатьяРасходовСписания,
	|	Таблица.СтатьяДоходов,
	|	Таблица.АналитикаДоходов,
	|	Таблица.ПериодПродажи,
	|	Таблица.СтатьяАктивовПассивов,
	|	Таблица.АналитикаАктивовПассивов,
	|	Таблица.ДокументДвижения,
	|	Таблица.ИдентификаторСтроки,
	|	Таблица.ГруппаПродукции,
	|	Таблица.КорПартия,
	|	Таблица.КорАналитикаУчетаПартий,
	|	Таблица.КорАналитикаФинансовогоУчета,
	|	Таблица.КорВидДеятельностиНДС,
	|	Таблица.НДСРегл,
	|	Таблица.НДСУпр,
	|	Таблица.СтатьяКалькуляции,
	|	Таблица.ТипЗаписи,
	|	Таблица.ДокументИсточник,
	|	Таблица.Знак
	|
	|ИМЕЮЩИЕ
	|	СУММА(Таблица.Количество) <> 0
	|	ИЛИ СУММА(Таблица.Стоимость) <> 0
	|	ИЛИ СУММА(Таблица.СтоимостьБезНДС) <> 0
	|	ИЛИ СУММА(Таблица.ДопРасходы) <> 0
	|	ИЛИ СУММА(Таблица.ДопРасходыБезНДС) <> 0
	|	ИЛИ СУММА(Таблица.СтоимостьРегл) <> 0
	|	ИЛИ СУММА(Таблица.ПостояннаяРазница) <> 0
	|	ИЛИ СУММА(Таблица.ВременнаяРазница) <> 0
	|	ИЛИ СУММА(Таблица.СтоимостьЗабалансовая) <> 0
	|	ИЛИ СУММА(Таблица.Трудозатраты) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПостоянныеСНДС) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПеременныеСНДС) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПостоянныеБезНДС) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПеременныеБезНДС) <> 0
	|	ИЛИ СУММА(Таблица.СтоимостьЗабалансоваяРегл) <> 0
	|	ИЛИ СУММА(Таблица.ДопРасходыРегл) <> 0
	|	ИЛИ СУММА(Таблица.ТрудозатратыРегл) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПостоянныеРегл) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПеременныеРегл) <> 0
	|	ИЛИ СУММА(Таблица.СтоимостьУпр) <> 0
	|	ИЛИ СУММА(Таблица.ДопРасходыУпр) <> 0
	|	ИЛИ СУММА(Таблица.ТрудозатратыУпр) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПостоянныеУпр) <> 0
	|	ИЛИ СУММА(Таблица.ПостатейныеПеременныеУпр) <> 0
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|УНИЧТОЖИТЬ СебестоимостьТоваровПередЗаписью
	|");
	
	СтруктураВременныеТаблицы = ДополнительныеСвойства.ДляПроведения.СтруктураВременныеТаблицы;
	
	Запрос.МенеджерВременныхТаблиц = СтруктураВременныеТаблицы.МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Регистратор", Отбор.Регистратор.Значение);
	
	Запрос.Выполнить();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура СохранитьНеИзмененныеПервичныеДвижения()
	
	Если УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ЗначенияТехнологическихПараметров().НеСохранятьРасчетныеДвижения Тогда
		Возврат;
	КонецЕсли;
	
	Если ДополнительныеСвойства.Свойство("ДатаРегистратора") Тогда
		ДатаРегистратора = ДополнительныеСвойства.ДатаРегистратора;
	Иначе
		ДатаРегистратора = ОбщегоНазначения.ЗначениеРеквизитаОбъекта(Отбор.Регистратор.Значение, "Дата");
	КонецЕсли;
	
	Если НЕ УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПартионныйУчетВерсии22(НачалоМесяца(ДатаРегистратора)) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ДополнительныеСвойства.Свойство("ТочноНужноСохранитьДвижения") Тогда
		
		Если НЕ ДополнительныеСвойства.Свойство("ДляПроведения")
		 ИЛИ НЕ ДополнительныеСвойства.Свойство("РежимЗаписи")
		 ИЛИ ДополнительныеСвойства.РежимЗаписи = РежимЗаписиДокумента.ОтменаПроведения Тогда
			Возврат;
		КонецЕсли;
		
	КонецЕсли;
	
	Запрос = Новый Запрос;
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	Запрос.УстановитьПараметр("Регистратор", 				Отбор.Регистратор.Значение);
	
	#Область ДополнитьДвижениямиИзИБЗаПериод
	
	// Если при проведении документа известно, что данные какого-то периода точно не изменились,
	// то надо просто добавить их в набор записей из ИБ.
	Если ДополнительныеСвойства.Свойство("ДополнитьДвижениямиИзИБЗаПериод") Тогда
		
		Запрос.УстановитьПараметр("НачалоПериода", ДополнительныеСвойства.ДополнитьДвижениямиИзИБЗаПериод.НачалоПериода);
		Запрос.УстановитьПараметр("КонецПериода",  ДополнительныеСвойства.ДополнитьДвижениямиИзИБЗаПериод.КонецПериода);
		
		Запрос.Текст =
		"ВЫБРАТЬ
		|	*
		|ИЗ
		|	РегистрНакопления.СебестоимостьТоваров КАК Т
		|ГДЕ
		|	Т.Регистратор = &Регистратор
		|	И Т.Период МЕЖДУ &НачалоПериода И &КонецПериода
		|	И НЕ Т.РасчетПартий
		|	И НЕ Т.РасчетСебестоимости";
		
		Выборка = Запрос.Выполнить().Выбрать();
		
		Пока Выборка.Следующий() Цикл
			НоваяСтрока = ЭтотОбъект.Добавить();
			ЗаполнитьЗначенияСвойств(НоваяСтрока, Выборка);
		КонецЦикла;
		
	КонецЕсли;
	
	#КонецОбласти
	
	ТаблицаЗаписей = ЭтотОбъект.Выгрузить();
	Запрос.УстановитьПараметр("НаборЗаписей", 				ТаблицаЗаписей);
	Запрос.УстановитьПараметр("ТипыЗаписейПервичныхПартий", УниверсальныеМеханизмыПартийИСебестоимости.ТипыЗаписейПервичныхПартий());
	
	// Создадим ВТПравилаЗаполненияПоляТипЗаписи
	УниверсальныеМеханизмыПартийИСебестоимости.СоздатьТаблицуПравилЗаполненияПоляТипЗаписи(
		Запрос.МенеджерВременныхТаблиц,
		УниверсальныеМеханизмыПартийИСебестоимостиПовтИсп.ПравилаЗаполненияПоляТипЗаписи(Отбор.Регистратор.Значение.Метаданные().Имя));
		
	#Область ШаблоныТекстаЗапроса
	
	// Подготовим шаблоны для формирования текстов запросов.
	ПоляИсключения = Новый Структура("НомерСтроки, Активность, Регистратор, МоментВремени");
	ПоляПартий     = Новый Структура("Партия, АналитикаУчетаПартий, АналитикаФинансовогоУчета, ВидДеятельностиНДС, ДокументИсточник, РасчетНеЗавершен");
	
	ТекстПоляРегистра = "";
	ТекстПоляРегистраСМинусом = "";
	ТекстПоляРегистраБезПартий = "";
	ТекстПоляГруппировкиБезПартий = "";
	ТекстПоляСуммирования = "";
	ТекстПоляУсловия = "";
	
	Для Каждого ТекущаяКолонка Из ТаблицаЗаписей.Колонки Цикл
		
		Если ПоляИсключения.Свойство(ТекущаяКолонка.Имя) Тогда
			Продолжить;
		КонецЕсли;
		
		ЭтоСуммируемоеПоле = Метаданные().Ресурсы.Найти(ТекущаяКолонка.Имя) <> Неопределено
			ИЛИ (Метаданные().Реквизиты.Найти(ТекущаяКолонка.Имя) <> Неопределено
				И ТекущаяКолонка.ТипЗначения.СодержитТип(Тип("Число")));
		 
		ТекстПоляРегистра = ТекстПоляРегистра + ?(ТекстПоляРегистра = "", "", ",
			|	") + "Т." + ТекущаяКолонка.Имя;
		ТекстПоляРегистраСМинусом = ТекстПоляРегистраСМинусом + ?(ТекстПоляРегистраСМинусом = "", "", ",
			|	") + ?(ЭтоСуммируемоеПоле, "-", "") + "Т." + ТекущаяКолонка.Имя;
			
		Если ЭтоСуммируемоеПоле Тогда
			
			ТекстПоляСуммирования = ТекстПоляСуммирования + ?(ТекстПоляСуммирования = "", "", ",
				|	") + "СУММА(Т." + ТекущаяКолонка.Имя + ") КАК " + ТекущаяКолонка.Имя;
			ТекстПоляУсловия = ТекстПоляУсловия + ?(ТекстПоляУсловия = "", "", "
				|	ИЛИ ") + "СУММА(Т." + ТекущаяКолонка.Имя + ") <> 0";
			
		Иначе
			
			Если НЕ ПоляПартий.Свойство(ТекущаяКолонка.Имя) Тогда
				
				ТекстПоляРегистраБезПартий = ТекстПоляРегистраБезПартий + ?(ТекстПоляРегистраБезПартий = "", "", ",
					|	") + "Т." + ТекущаяКолонка.Имя;
				ТекстПоляГруппировкиБезПартий = ТекстПоляГруппировкиБезПартий + ?(ТекстПоляГруппировкиБезПартий = "", "", ",
					|	") + "Т." + ТекущаяКолонка.Имя;
				
			Иначе
				
				Если НРег(ТекущаяКолонка.Имя) = НРег("ДокументИсточник") Тогда
					УсловиеДляПоляДокументИсточник =
						 "ИЛИ (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход) И Правила.ДокументИсточникВПриходе)
					|	  ИЛИ (Т.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Расход) И Правила.ДокументИсточникВРасходе)
					|	  ";
				Иначе
					УсловиеДляПоляДокументИсточник = "";
				КонецЕсли;
				
				ТекстПоляРегистраБезПартий = ТекстПоляРегистраБезПартий + ?(ТекстПоляРегистраБезПартий = "", "", ",
					|	") + "ВЫБОР КОГДА Т.ТипЗаписи В (&ТипыЗаписейПервичныхПартий)
					|	  " + УсловиеДляПоляДокументИсточник + "
					|		ТОГДА Т." + ТекущаяКолонка.Имя
					+ " ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ КАК " + ТекущаяКолонка.Имя;
				ТекстПоляГруппировкиБезПартий = ТекстПоляГруппировкиБезПартий + ?(ТекстПоляГруппировкиБезПартий = "", "", ",
					|	") + "ВЫБОР КОГДА Т.ТипЗаписи В (&ТипыЗаписейПервичныхПартий)
					|	  " + УсловиеДляПоляДокументИсточник + "
					|		ТОГДА Т." + ТекущаяКолонка.Имя
					+ " ИНАЧЕ НЕОПРЕДЕЛЕНО КОНЕЦ";
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЦикла;
	
	#КонецОбласти
	
	#Область СозданиеВременныхТаблиц
	
	// Проанализируем наличие измененных первичных движений в разрезе периодов (месяцев).
	ШаблонТекстаЗапроса =
	"ВЫБРАТЬ
	|	%1
	|ПОМЕСТИТЬ ВТНаборЗаписей
	|ИЗ
	|	&НаборЗаписей КАК Т
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	%3,
	|	%4
	|ПОМЕСТИТЬ ВТИзмененныеДвижения
	|ИЗ
	|(ВЫБРАТЬ
	|	%1
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Регистратор = &Регистратор
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	%2
	|ИЗ
	|	ВТНаборЗаписей КАК Т
	|ГДЕ
	|	НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|) КАК Т
	|	ЛЕВОЕ СОЕДИНЕНИЕ ВТПравилаЗаполненияПоляТипЗаписи КАК Правила
	|		ПО Правила.ХозяйственнаяОперация = ЗНАЧЕНИЕ(Перечисление.ХозяйственныеОперации.ПустаяСсылка)
	|			ИЛИ Т.ХозяйственнаяОперация = Правила.ХозяйственнаяОперация
	|
	|СГРУППИРОВАТЬ ПО
	|	%5
	|ИМЕЮЩИЕ
	|	%6
	|;
	|////////////////////////////////////////////////////////////////////////////////
	|
	|ВЫБРАТЬ
	|	Т.Период КАК Период,
	|	МАКСИМУМ(Т.ЕстьИзмененныеДвижения) КАК ЕстьИзмененныеДвижения
	|ПОМЕСТИТЬ ВТПериодыДвижений
	|ИЗ
	|	(ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
	|		ЛОЖЬ КАК ЕстьИзмененныеДвижения
	|	ИЗ
	|		ВТНаборЗаписей КАК Т
	|	
	|	ОБЪЕДИНИТЬ ВСЕ
	|
	|	ВЫБРАТЬ РАЗЛИЧНЫЕ
	|		НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) КАК Период,
	|		ИСТИНА КАК ЕстьИзмененныеДвижения
	|	ИЗ
	|		ВТИзмененныеДвижения КАК Т
	|	) КАК Т
	|
	|СГРУППИРОВАТЬ ПО
	|	Т.Период
	|;
	|";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонТекстаЗапроса,
		ТекстПоляРегистра,
		ТекстПоляРегистраСМинусом,
		ТекстПоляРегистраБезПартий,
		ТекстПоляСуммирования,
		ТекстПоляГруппировкиБезПартий,
		ТекстПоляУсловия);
		
	Запрос.Выполнить(); // сформируем временные таблицы с описанием движений
	
	#КонецОбласти
	
	#Область ЗаполнениеНабораЗаписей
	
	// Движения не измененных периодов возьмем из ИБ,
	// а движения измененных периодов и расчетные движения - из набора записей.
	ШаблонТекстаЗапроса =
	"ВЫБРАТЬ
	|	&Регистратор КАК Регистратор,
	|	%1
	|ИЗ
	|	РегистрНакопления.СебестоимостьТоваров КАК Т
	|ГДЕ
	|	Т.Регистратор = &Регистратор
	|	И НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) В
	|		(ВЫБРАТЬ Т.Период
	|		 ИЗ ВТПериодыДвижений КАК Т
	|		 ГДЕ НЕ Т.ЕстьИзмененныеДвижения)
	|
	|ОБЪЕДИНИТЬ ВСЕ
	|
	|ВЫБРАТЬ
	|	&Регистратор КАК Регистратор,
	|	%1
	|ИЗ
	|	ВТНаборЗаписей КАК Т
	|ГДЕ
	|	НЕ Т.РасчетПартий
	|	И НЕ Т.РасчетСебестоимости
	|	И НАЧАЛОПЕРИОДА(Т.Период, МЕСЯЦ) В
	|		(ВЫБРАТЬ Т.Период
	|		 ИЗ ВТПериодыДвижений КАК Т
	|		 ГДЕ Т.ЕстьИзмененныеДвижения)
	|";
	
	Запрос.Текст = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
		ШаблонТекстаЗапроса,
		ТекстПоляРегистра);
	
	ТаблицаЗаписей = Запрос.Выполнить().Выгрузить();
	
	ЭтотОбъект.Загрузить(ТаблицаЗаписей);
	
	#КонецОбласти
	
КонецПроцедуры

#КонецОбласти

#КонецЕсли
