
&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	//Если Параметры.Свойство("Объект") Тогда // Возврат при получении формы для анализа.
	//	Возврат;
	//КонецЕсли;
	
	Объект.ЗонаДоставки 		= Параметры.ЗонаДоставки;
	Объект.ЗонаДоставкиИсходная = Параметры.ЗонаДоставки;
	
	Объект.ДатаОтправки = КонецДня(Параметры.ДатаОтправки);
	Объект.ДатаС 		= НачалоДня(Параметры.ДатаОтправки-3*24*60*60);
	Объект.ФильтрПоДате = Истина;
	СоздатьСписок();
	
КонецПроцедуры


//// по заданным параметрам заполняет список докум
&НаСервере
Процедура СоздатьСписок()
	
	Если НЕ ЗначениеЗаполнено(Объект.ЗонаДоставки) тогда
		Возврат;
	КонецЕсли;
	
	Если ЗначениеЗаполнено(Объект.ЗонаДоставки.Родитель) тогда
		ЗонаГруппа = Объект.ЗонаДоставки.Родитель;
	Иначе
		ЗонаГруппа = Объект.ЗонаДоставки;
	КонецЕсли;
	
	Объект.Список.Очистить();
	Запрос = Новый Запрос;
	
	Запрос.УстановитьПараметр("Родитель", ЗонаГруппа);
	Запрос.УстановитьПараметр("Ссылка", Объект.ЗонаДоставки);
	Запрос.УстановитьПараметр("Состояние", Перечисления.СостоянияОтгрузки.ОжидаетсяВключениеВРейс);
	
	Запрос.Текст = 
			"ВЫБРАТЬ
			|	ЗоныДоставкиСписок.АдресДоставки КАК АдресДоставки
			|ПОМЕСТИТЬ АдресаВсе
			|ИЗ
			|	Справочник.ЗоныДоставки.Список КАК ЗоныДоставкиСписок
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЗоныДоставки КАК ЗоныДоставки
			|		ПО (ЗоныДоставкиСписок.Ссылка = ЗоныДоставки.Ссылка)
			|ГДЕ
			|	(ЗоныДоставки.Родитель = &Родитель
			|			ИЛИ ЗоныДоставки.Ссылка = &Родитель)
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗоныДоставкиСписок.АдресДоставки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	ЗоныДоставкиСписок.АдресДоставки КАК АдресДоставки
			|ПОМЕСТИТЬ АдресЗоны
			|ИЗ
			|	Справочник.ЗоныДоставки.Список КАК ЗоныДоставкиСписок
			|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ЗоныДоставки КАК ЗоныДоставки
			|		ПО ЗоныДоставкиСписок.Ссылка = ЗоныДоставки.Ссылка
			|ГДЕ
			|	ЗоныДоставки.Ссылка = &Ссылка
			|
			|СГРУППИРОВАТЬ ПО
			|	ЗоныДоставкиСписок.АдресДоставки
			|;
			|
			|////////////////////////////////////////////////////////////////////////////////
			|ВЫБРАТЬ
			|	РеализацияТоваровУслуг.Ссылка КАК Ссылка,
			|	РеализацияТоваровУслуг.Дата КАК Дата,
			|	РеализацияТоваровУслуг.Номер КАК Номер,
			|	РеализацияТоваровУслуг.РСМАдресДоставки КАК Адрес,
			|	СостоянияОтгрузки.Состояние КАК Состояние,
			|	АдресЗоны.АдресДоставки КАК АдресЗоны,
			|	АдресаВсе.АдресДоставки КАК АдресВсе
			|ИЗ
			|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
			|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СостоянияОтгрузки КАК СостоянияОтгрузки
			|		ПО РеализацияТоваровУслуг.Ссылка = СостоянияОтгрузки.ДокументОтгрузки
			|		ЛЕВОЕ СОЕДИНЕНИЕ АдресаВсе КАК АдресаВсе
			|		ПО РеализацияТоваровУслуг.РСМАдресДоставки = АдресаВсе.АдресДоставки
			|		ЛЕВОЕ СОЕДИНЕНИЕ АдресЗоны КАК АдресЗоны
			|		ПО РеализацияТоваровУслуг.РСМАдресДоставки = АдресЗоны.АдресДоставки
			|ГДЕ
			|	СостоянияОтгрузки.Состояние = &Состояние
			|	И РеализацияТоваровУслуг.Дата МЕЖДУ &Дата1 И &Дата2";	
	

	ТекДата = НачалоДня(Объект.ДатаОтправки);
	ПредДата = ТекДата-24*60*60;
	СтрСПБ = Новый Структура;
	СтрСпб.Вставить("ПНачало", 	ВремяВДату(ПредДата,Объект.ЗонаДоставки.СПБПНачало));
	СтрСпб.Вставить("ПКонец", 	ВремяВДату(ПредДата,Объект.ЗонаДоставки.СПБПКонец));
	СтрСпб.Вставить("ТНачало", 	ВремяВДату(ТекДата,Объект.ЗонаДоставки.СПБТНачало));
	СтрСпб.Вставить("ТКонец", 	ВремяВДату(ТекДата,Объект.ЗонаДоставки.СПБТКонец));
	
	СтрР = Новый Структура;
	СтрР.Вставить("ПНачало", 	ВремяВДату(ПредДата,Объект.ЗонаДоставки.РПНачало));
	СтрР.Вставить("ПКонец", 	ВремяВДату(ПредДата,Объект.ЗонаДоставки.РПКонец));
	СтрР.Вставить("ТНачало", 	ВремяВДату(ТекДата,Объект.ЗонаДоставки.РТНачало));
	СтрР.Вставить("ТКонец", 	ВремяВДату(ТекДата,Объект.ЗонаДоставки.РТКонец));
	
	Если Объект.ФильтрПоДате тогда
		
		Если СтрСпб.ПНачало < СтрР.ПНачало тогда
			дата1 = СтрСпб.ПНачало;
		Иначе
			дата1 = СтрР.ПНачало;
		КонецЕсли;
		
		Если СтрСпб.ТКонец< стрР.тКонец тогда
			дата2 = стрР.тКонец;
		Иначе
			дата2 = стрСпб.тКонец;
		КонецЕсли;
		Дата1 = НачалоДня( Дата1);
	Иначе
		Дата1 = НачалоДня(Объект.ДатаС);
		Дата2 = Объект.ДатаОтправки;
	КонецЕсли;
	
	Запрос.УстановитьПараметр("Дата1", Дата1);
	Запрос.УстановитьПараметр("Дата2", Дата2);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
		
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		Если НЕ ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.АдресВсе) тогда
			продолжить;
		КонецЕсли;
		// проверка по фильтру даты
		отм = ложь;
		Если Объект.ФильтрПоДате тогда
			Если ВыборкаДетальныеЗаписи.адрес.СПБ тогда
				стрФильтр = стрСпб;
			Иначе
				стрФильтр = стрР;
			КонецЕсли;
			Если (ВыборкаДетальныеЗаписи.Дата>= стрФильтр.ПНачало и ВыборкаДетальныеЗаписи.Дата<= стрФильтр.ПКонец) или
			     (ВыборкаДетальныеЗаписи.Дата>= стрФильтр.ТНачало и ВыборкаДетальныеЗаписи.Дата<= стрФильтр.ТКонец) тогда
				 //**************
				 отм = истина;
			КонецЕсли;	 
		КонецЕсли;
		НовСтр = Объект.Список.Добавить();
		НовСтр.АдресДоставки = ВыборкаДетальныеЗаписи.Адрес;
		НовСтр.Дата = ВыборкаДетальныеЗаписи.Дата;
		НовСтр.Номер = ВыборкаДетальныеЗаписи.Номер;
		Если отм и ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.АдресЗоны) тогда
			НовСтр.Отм = Истина;
		Иначе
			НовСтр.Отм = Ложь;
		КонецЕсли;
		НовСтр.Ссылка = ВыборкаДетальныеЗаписи.Ссылка;
		НовСтр.Спб = ВыборкаДетальныеЗаписи.Адрес.СПБ;
	
	КонецЦикла;
	
КонецПроцедуры


Функция ВремяВДату(Дата,время)
	
	//р = найти(время,":");
	//Если р<> 0 тогда
	//	час = число( Лев(время,р-1));
	//	мин = число( сред(время,р+1));
	//КонецЕсли;
	//Результат = НачалоДня(Дата)+час*60*60+мин*60;
	//
	//Возврат результат;
	
	р = найти(время,":");
 Если р<> 0 тогда
  час = число( Лев(время,р-1));
  мин = число( сред(время,р+1));
 Иначе
  час = 0;
  мин =0;
 КонецЕсли;
 Результат = НачалоДня(Дата)+час*60*60+мин*60;
 
 Возврат результат;
 

	
КонецФункции


&НаКлиенте
Процедура ПриОткрытии(Отказ)
	ПриОткрытииНаСервере();
КонецПроцедуры


&НаСервере
Процедура ПриОткрытииНаСервере()

КонецПроцедуры


&НаКлиенте
Процедура ОбновитьСписок(Команда)
	СоздатьСписок();
КонецПроцедуры


&НаКлиенте
Процедура ОтметитьВсе(Команда)
	для каждого стр из объект.Список цикл
		стр.Отм = Истина;
	КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура УбратьВсе(Команда)
	для каждого стр из объект.Список цикл
		стр.Отм = Ложь;
	КонецЦикла;
КонецПроцедуры


&НаКлиенте
Процедура ФильтрПоДатеПриИзменении(Элемент)
	Элементы.ДатаС.Видимость = НЕ Объект.ФильтрПоДате;
КонецПроцедуры


&НаКлиенте
Процедура Загрузить(Команда)
	/// перенос в список
	Рез = Новый Массив;
	для каждого стр из объект.Список цикл
		Если стр.Отм тогда
			Рез.Добавить(стр.ссылка);
		КонецЕсли;
	КонецЦикла;
	
	ОповеститьОВыборе(Рез);	
	
КонецПроцедуры

