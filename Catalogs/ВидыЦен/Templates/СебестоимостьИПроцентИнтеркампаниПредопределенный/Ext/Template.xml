<?xml version="1.0" encoding="UTF-8"?>
<DataCompositionSchema xmlns="http://v8.1c.ru/8.1/data-composition-system/schema" xmlns:dcscom="http://v8.1c.ru/8.1/data-composition-system/common" xmlns:dcscor="http://v8.1c.ru/8.1/data-composition-system/core" xmlns:dcsset="http://v8.1c.ru/8.1/data-composition-system/settings" xmlns:v8="http://v8.1c.ru/8.1/data/core" xmlns:v8ui="http://v8.1c.ru/8.1/data/ui" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
	<dataSource>
		<name>ИсточникДанных1</name>
		<dataSourceType>Local</dataSourceType>
	</dataSource>
	<dataSet xsi:type="DataSetQuery">
		<name>Запрос</name>
		<field xsi:type="DataSetFieldField">
			<dataPath>Номенклатура</dataPath>
			<field>Номенклатура</field>
			<role>
				<dcscom:dimension>true</dcscom:dimension>
			</role>
			<valueType>
				<v8:Type xmlns:d5p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d5p1:CatalogRef.Номенклатура</v8:Type>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Характеристика</dataPath>
			<field>Характеристика</field>
			<role>
				<dcscom:dimension>true</dcscom:dimension>
			</role>
			<valueType>
				<v8:Type xmlns:d5p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d5p1:CatalogRef.ХарактеристикиНоменклатуры</v8:Type>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>АналитикаУчетаНоменклатуры</dataPath>
			<field>АналитикаУчетаНоменклатуры</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ОрганизацияВладелец</dataPath>
			<field>ОрганизацияВладелец</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Цена</dataPath>
			<field>Цена</field>
			<valueType>
				<v8:Type>xs:decimal</v8:Type>
				<v8:NumberQualifiers>
					<v8:Digits>0</v8:Digits>
					<v8:FractionDigits>0</v8:FractionDigits>
					<v8:AllowedSign>Any</v8:AllowedSign>
				</v8:NumberQualifiers>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Коэффициент</dataPath>
			<field>Коэффициент</field>
			<valueType>
				<v8:Type>xs:decimal</v8:Type>
				<v8:NumberQualifiers>
					<v8:Digits>0</v8:Digits>
					<v8:FractionDigits>0</v8:FractionDigits>
					<v8:AllowedSign>Any</v8:AllowedSign>
				</v8:NumberQualifiers>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Упаковка</dataPath>
			<field>Упаковка</field>
			<valueType>
				<v8:Type xmlns:d5p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d5p1:CatalogRef.УпаковкиЕдиницыИзмерения</v8:Type>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Валюта</dataPath>
			<field>Валюта</field>
			<valueType>
				<v8:Type xmlns:d5p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d5p1:CatalogRef.Валюты</v8:Type>
			</valueType>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>СегментНоменклатуры</dataPath>
			<field>СегментНоменклатуры</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ХозяйственнаяОперация</dataPath>
			<field>ХозяйственнаяОперация</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>НаправлениеДеятельностиКонтрагента</dataPath>
			<field>НаправлениеДеятельностиКонтрагента</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>АналитикаУчетаНаборов</dataPath>
			<field>АналитикаУчетаНаборов</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Менеджер</dataPath>
			<field>Менеджер</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ОрганизацияПродавец</dataPath>
			<field>ОрганизацияПродавец</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Соглашение</dataPath>
			<field>Соглашение</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Договор</dataPath>
			<field>Договор</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ВидЗапасов</dataPath>
			<field>ВидЗапасов</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Склад</dataPath>
			<field>Склад</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ЗаказКлиента</dataPath>
			<field>ЗаказКлиента</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>НаправлениеДеятельностиНоменклатуры</dataPath>
			<field>НаправлениеДеятельностиНоменклатуры</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ТипЗапасов</dataPath>
			<field>ТипЗапасов</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Подразделение</dataPath>
			<field>Подразделение</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>АналитикаУчетаПоПартнерам</dataPath>
			<field>АналитикаУчетаПоПартнерам</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>ВидДеятельностиНДС</dataPath>
			<field>ВидДеятельностиНДС</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>АналитикаУчетаПартий</dataPath>
			<field>АналитикаУчетаПартий</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>АналитикаФинансовогоУчета</dataPath>
			<field>АналитикаФинансовогоУчета</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Партия</dataPath>
			<field>Партия</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>РазделУчета</dataPath>
			<field>РазделУчета</field>
		</field>
		<field xsi:type="DataSetFieldField">
			<dataPath>Организация</dataPath>
			<field>Организация</field>
		</field>
		<dataSource>ИсточникДанных1</dataSource>
		<query>ВЫБРАТЬ РАЗЛИЧНЫЕ
	Сегменты.Номенклатура,
	Сегменты.Характеристика,
	ИСТИНА КАК ИспользуетсяОтборПоСегментуНоменклатуры
ПОМЕСТИТЬ ОтборПоСегментуНоменклатуры
ИЗ
	РегистрСведений.НоменклатураСегмента КАК Сегменты
{ГДЕ
	Сегменты.Сегмент.* КАК СегментНоменклатуры,
	Сегменты.Номенклатура.* КАК Номенклатура,
	Сегменты.Характеристика.* КАК Характеристика}

ИНДЕКСИРОВАТЬ ПО
	Сегменты.Номенклатура,
	Сегменты.Характеристика,
	ИспользуетсяОтборПоСегментуНоменклатуры
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ
	Резервы.Регистратор КАК Регистратор,
	Резервы.Организация КАК ОрганизацияВладелец,
	Резервы.КорОрганизация КАК ОрганизацияПродавец,
	Ключи.Номенклатура КАК Номенклатура,
	Ключи.Характеристика КАК Характеристика,
	Ключи.Склад КАК Склад,
	СУММА(Резервы.Количество) КАК Количество
ПОМЕСТИТЬ РезервыЗаПериод
ИЗ
	РегистрНакопления.РезервыТоваровОрганизаций КАК Резервы
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	ПО Ключи.Ссылка = Резервы.АналитикаУчетаНоменклатуры
	
ГДЕ
	Резервы.Количество &gt; 0
	И Резервы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	И Не &amp;ИспользуетсяОтборПоСегментуНоменклатуры
	И Резервы.Период МЕЖДУ &amp;НачалоПериода И &amp;КонецПериода
	
СГРУППИРОВАТЬ ПО
	Резервы.Регистратор,
	Резервы.Организация,
	Резервы.КорОрганизация,
	Ключи.Номенклатура,
	Ключи.Характеристика,
	Ключи.Склад
	
ОБЪЕДИНИТЬ ВСЕ
	
ВЫБРАТЬ
	Резервы.Регистратор КАК Регистратор,
	Резервы.Организация КАК ОрганизацияВладелец,
	Резервы.КорОрганизация КАК ОрганизацияПродавец,
	Ключи.Номенклатура КАК Номенклатура,
	Ключи.Характеристика КАК Характеристика,
	Ключи.Склад КАК Склад,
	СУММА(Резервы.Количество) КАК Количество
ИЗ
	РегистрНакопления.РезервыТоваровОрганизаций КАК Резервы
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК Ключи
	ПО Ключи.Ссылка = Резервы.АналитикаУчетаНоменклатуры
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ ОтборПоСегментуНоменклатуры КАК ОтборПоСегменту
	ПО Ключи.Номенклатура = ОтборПоСегменту.Номенклатура
		И Ключи.Характеристика = ОтборПоСегменту.Характеристика
ГДЕ
	Резервы.Количество &gt; 0
	И Резервы.ВидДвижения = ЗНАЧЕНИЕ(ВидДвиженияНакопления.Приход)
	И &amp;ИспользуетсяОтборПоСегментуНоменклатуры
	И Резервы.Период МЕЖДУ &amp;НачалоПериода И &amp;КонецПериода
	
СГРУППИРОВАТЬ ПО
	Резервы.Регистратор,
	Резервы.Организация,
	Резервы.КорОрганизация,
	Ключи.Номенклатура,
	Ключи.Характеристика,
	Ключи.Склад
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗРЕШЕННЫЕ
	Резервы.ОрганизацияВладелец КАК ОрганизацияВладелец,
	Резервы.ОрганизацияПродавец КАК ОрганизацияПродавец,
	Резервы.Номенклатура КАК Номенклатура,
	Резервы.Характеристика КАК Характеристика,
	Резервы.Склад КАК Склад,
	СУММА(Резервы.Количество) КАК Количество,
	СУММА(Резервы.Количество) *
		МАКСИМУМ(
			ВЫБОР
				КОГДА ЕСТЬNULL(ВидыЦен.ЦенаВключаетНДС, ЛОЖЬ)
					ТОГДА Выручка.СуммаВыручкиОборот
				ИНАЧЕ Выручка.СуммаВыручкиБезНДСОборот
			КОНЕЦ) /
		МАКСИМУМ(Выручка.КоличествоОборот) КАК СуммаВыручки
ПОМЕСТИТЬ Выручка
ИЗ
	РегистрНакопления.ВыручкаИСебестоимостьПродаж.Обороты(
		{(&amp;НачалоПериода)},
		{(&amp;КонецПериода)},
		Авто,
		{((АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Характеристика) В
			(ВЫБРАТЬ
				ОтборПоСегментуНоменклатуры.Номенклатура,
				ОтборПоСегментуНоменклатуры.Характеристика
			ИЗ
				ОтборПоСегментуНоменклатуры
			ГДЕ
				ОтборПоСегментуНоменклатуры.ИспользуетсяОтборПоСегментуНоменклатуры = &amp;ИспользуетсяОтборПоСегментуНоменклатуры))}
	) КАК Выручка
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КлючиАналитикиУчетаНоменклатуры КАК КлючиВыручки
	ПО КлючиВыручки.Ссылка = Выручка.АналитикаУчетаНоменклатуры
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РезервыЗаПериод КАК Резервы
	ПО Выручка.Регистратор = Резервы.Регистратор
		И КлючиВыручки.Номенклатура = Резервы.Номенклатура
		И КлючиВыручки.Характеристика = Резервы.Характеристика
		И КлючиВыручки.Склад = Резервы.Склад
	
	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЦен КАК ВидыЦен
	ПО ВидыЦен.Ссылка = &amp;ВидЦены
	
СГРУППИРОВАТЬ ПО
	Резервы.ОрганизацияВладелец,
	Резервы.ОрганизацияПродавец,
	Резервы.Номенклатура,
	Резервы.Характеристика,
	Резервы.Склад
;

////////////////////////////////////////////////////////////////////////////////
ВЫБРАТЬ РАЗРЕШЕННЫЕ
	1 КАК Коэффициент,
	Выручка.Номенклатура КАК Номенклатура,
	Выручка.Характеристика КАК Характеристика,
	ЗНАЧЕНИЕ(Справочник.УпаковкиЕдиницыИзмерения.ПустаяСсылка) КАК Упаковка,
	Константы.ВалютаУправленческогоУчета КАК Валюта,
	ВЫБОР
		КОГДА ВидыЦен.ЦенаВключаетНДС ТОГДА
			ЕСТЬNULL(СтоимостьТоваровСрезПоследних.Стоимость, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьЗабалансовая, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьДопРасходы, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.Трудозатраты, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.ПостатейныеПостоянныеСНДС, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.ПостатейныеПеременныеСНДС, 0)
		ИНАЧЕ
			ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьБезНДС, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьДопРасходыБезНДС, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.Трудозатраты, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.ПостатейныеПостоянныеБезНДС, 0)
			+ ЕСТЬNULL(СтоимостьТоваровСрезПоследних.ПостатейныеПеременныеБезНДС, 0)
			+ ВЫРАЗИТЬ(ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьЗабалансовая, 0) - ЕСТЬNULL(СтоимостьТоваровСрезПоследних.СтоимостьЗабалансовая, 0)
				* ВЫБОР
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18)
						ТОГДА 0.18
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10)
						ТОГДА 0.1
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС0)
						ТОГДА 0
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.БезНДС)
						ТОГДА 0
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС18_118)
						ТОГДА 0.18
					КОГДА Выручка.Номенклатура.СтавкаНДС = ЗНАЧЕНИЕ(Перечисление.СтавкиНДС.НДС10_110)
						ТОГДА 0.1
					ИНАЧЕ 0
				КОНЕЦ КАК ЧИСЛО(15, 2))
	КОНЕЦ * (100 + &amp;Процент) / 100 КАК Цена
{ВЫБРАТЬ
	Коэффициент,
	Цена,
	Номенклатура.*,
	Характеристика.*,
	Упаковка.*,
	Валюта.*}
ИЗ
	Выручка КАК Выручка
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.СтоимостьТоваров.СрезПоследних(
		{(&amp;ДатаДокумента)},
		{((АналитикаУчетаНоменклатуры.Номенклатура, АналитикаУчетаНоменклатуры.Характеристика) В
			(ВЫБРАТЬ
				ОтборПоСегментуНоменклатуры.Номенклатура,
				ОтборПоСегментуНоменклатуры.Характеристика
			ИЗ
				ОтборПоСегментуНоменклатуры
			ГДЕ
				ОтборПоСегментуНоменклатуры.ИспользуетсяОтборПоСегментуНоменклатуры = &amp;ИспользуетсяОтборПоСегментуНоменклатуры))}
	) КАК СтоимостьТоваровСрезПоследних
	
	ПО Выручка.ОрганизацияПродавец = СтоимостьТоваровСрезПоследних.Организация
		И Выручка.Номенклатура = СтоимостьТоваровСрезПоследних.АналитикаУчетаНоменклатуры.Номенклатура
		И Выручка.Характеристика = СтоимостьТоваровСрезПоследних.АналитикаУчетаНоменклатуры.Характеристика
		И Выручка.Склад = СтоимостьТоваровСрезПоследних.АналитикаУчетаНоменклатуры.Склад
	
	ВНУТРЕННЕЕ СОЕДИНЕНИЕ Константы КАК Константы
	ПО Истина
	
	ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВидыЦен КАК ВидыЦен
	ПО ВидыЦен.Ссылка = &amp;ВидЦены
	
{ГДЕ
	Выручка.Номенклатура.*,
	Выручка.Характеристика.*,
	Выручка.ОрганизацияВладелец.*,
	Выручка.ОрганизацияПродавец.*,
	Выручка.Склад.*}</query>
	</dataSet>
	<parameter>
		<name>НачалоПериода</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Начало периода</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:dateTime</v8:Type>
			<v8:DateQualifiers>
				<v8:DateFractions>DateTime</v8:DateFractions>
			</v8:DateQualifiers>
		</valueType>
		<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
		<useRestriction>false</useRestriction>
		<expression>&amp;ПериодПоУмолчанию.ДатаНачала</expression>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>КонецПериода</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Конец периода</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:dateTime</v8:Type>
			<v8:DateQualifiers>
				<v8:DateFractions>DateTime</v8:DateFractions>
			</v8:DateQualifiers>
		</valueType>
		<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
		<useRestriction>false</useRestriction>
		<expression>&amp;ПериодПоУмолчанию.ДатаОкончания</expression>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>Процент</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Процент</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:decimal</v8:Type>
			<v8:NumberQualifiers>
				<v8:Digits>0</v8:Digits>
				<v8:FractionDigits>0</v8:FractionDigits>
				<v8:AllowedSign>Any</v8:AllowedSign>
			</v8:NumberQualifiers>
		</valueType>
		<value xsi:type="xs:decimal">0</value>
		<useRestriction>false</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>ИспользуетсяОтборПоСегментуНоменклатуры</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Используется отбор по сегменту номенклатуры</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:boolean</v8:Type>
		</valueType>
		<value xsi:type="xs:boolean">false</value>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>ВидЦены</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Вид цены</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type xmlns:d4p1="http://v8.1c.ru/8.1/data/enterprise/current-config">d4p1:CatalogRef.ВидыЦен</v8:Type>
		</valueType>
		<value xsi:nil="true"/>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>ДатаДокумента</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Дата документа</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>xs:dateTime</v8:Type>
			<v8:DateQualifiers>
				<v8:DateFractions>DateTime</v8:DateFractions>
			</v8:DateQualifiers>
		</valueType>
		<value xsi:type="xs:dateTime">0001-01-01T00:00:00</value>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<parameter>
		<name>ПериодПоУмолчанию</name>
		<title xsi:type="v8:LocalStringType">
			<v8:item>
				<v8:lang>ru</v8:lang>
				<v8:content>Период по умолчанию</v8:content>
			</v8:item>
		</title>
		<valueType>
			<v8:Type>v8:StandardPeriod</v8:Type>
		</valueType>
		<value xsi:type="v8:StandardPeriod">
			<v8:variant xsi:type="v8:StandardPeriodVariant">Custom</v8:variant>
			<v8:startDate>0001-01-01T00:00:00</v8:startDate>
			<v8:endDate>0001-01-01T00:00:00</v8:endDate>
		</value>
		<useRestriction>true</useRestriction>
		<availableAsField>false</availableAsField>
	</parameter>
	<settingsVariant>
		<dcsset:name>Основной</dcsset:name>
		<dcsset:presentation xsi:type="xs:string">Основной</dcsset:presentation>
		<dcsset:settings xmlns:style="http://v8.1c.ru/8.1/data/ui/style" xmlns:sys="http://v8.1c.ru/8.1/data/ui/fonts/system" xmlns:web="http://v8.1c.ru/8.1/data/ui/colors/web" xmlns:win="http://v8.1c.ru/8.1/data/ui/colors/windows"/>
	</settingsVariant>
</DataCompositionSchema>